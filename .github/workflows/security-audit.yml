name: Security Audit

on:
  schedule:
    # 毎週月曜日の午前0時（UTC）に実行
    - cron: '0 0 * * 1'
  workflow_dispatch: # 手動実行も可能
  pull_request:
    branches:
      - main
      - develop

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        id: audit
        run: |
          npm audit --audit-level=moderate --json > audit-report.json || true
        continue-on-error: true
      
      - name: Parse audit results
        id: parse-audit
        run: |
          if [ -f audit-report.json ]; then
            VULN_COUNT=$(node -e "const data=require('./audit-report.json'); console.log(Object.values(data.metadata?.vulnerabilities || {}).reduce((a,b)=>a+b,0))")
            echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: |
            audit-report.json
      
      - name: Comment PR with audit results
        if: github.event_name == 'pull_request' && steps.parse-audit.outputs.vulnerabilities != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let message = '⚠️ npm audit found security vulnerabilities.\n\n';
            try {
              const auditData = JSON.parse(fs.readFileSync('audit-report.json', 'utf8'));
              const vulns = auditData.metadata?.vulnerabilities || {};
              const total = Object.values(vulns).reduce((a, b) => a + b, 0);
              message += `**Total vulnerabilities: ${total}**\n\n`;
              message += `- Low: ${vulns.low || 0}\n`;
              message += `- Moderate: ${vulns.moderate || 0}\n`;
              message += `- High: ${vulns.high || 0}\n`;
              message += `- Critical: ${vulns.critical || 0}\n\n`;
              message += 'Please review the audit report and update dependencies if necessary.';
            } catch (e) {
              message += 'Unable to parse audit report.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
      
      - name: Fail if critical vulnerabilities found
        if: steps.parse-audit.outputs.vulnerabilities > 0
        run: |
          echo "⚠️ Security vulnerabilities found. Please review the audit report."
          exit 1


大分類,中分類,項目,詳細内容
━━━ UI基本設計書 ━━━,,,
基本情報,機能名,チャットシステム,
,対象画面,チャットメインページ ・ チャット一覧ページ,
,技術スタック,Next.js 15 ・ TypeScript ・ Google Gemini AI ・ Prisma ・ PostgreSQL ・ pgvector,
,作成日,2025-10-28,
━━━ 1. 画面概要 ━━━,,,
チャットメインページ,機能,AIキャラクターとリアルタイムチャット,メッセージ送受信 ・ 画像送信 ・ 再生成 ・ 削除機能
,ファイル,src/app/chat/[characterId]/page.tsx,
チャット一覧ページ,機能,チャット履歴一覧,ユーザーの全てのチャット履歴を表示 ・ 検索・選択削除機能付き
,ファイル,src/app/chatlist/page.tsx,
チャットヘッダー,コンポーネント,ヘッダー情報,キャラクター情報 ・ チャット設定 ・ メニュー（削除・ノート）を表示
,ファイル,ChatHeader.tsx,
チャットメッセージリスト,コンポーネント,メッセージ表示,ユーザーとAIのメッセージを時系列で表示 ・ バージョン切り替え・削除ボタン付き
,ファイル,ChatMessageList.tsx,
チャットフッター,コンポーネント,入力エリア,メッセージ入力欄 ・ 画像アップロードボタン ・ 送信ボタン
,ファイル,ChatFooter.tsx,
━━━ 2. 前提・制約 ━━━,,,
データ取得,方式,サーバーサイド取得 ・ クライアント側でリアルタイム更新,
AI応答,AIモデル,Google Gemini AI使用,システムプロンプト ・ ローブック ・ ペルソナを考慮した応答生成
画像制約,ファイル制限,1メッセージにつき1枚 ・ 最大5MB,対応形式: jpg / jpeg / png / gif / webp
ポイント消費,課金システム,チャットメッセージ送信時にポイントを消費 ・ 無料ポイント優先で消費,
バージョン管理,履歴管理,再生成したメッセージは全バージョンを保持 ・ バージョン切り替え可能,
コンテキスト管理,履歴範囲,チャット履歴の最新100メッセージをコンテキストとして使用,
━━━ 3. 関連URL・遷移 ━━━,,,
URL一覧,/chat/[characterId],チャットメインページ,
,/chatlist,チャット一覧ページ,
遷移フロー,基本フロー,キャラクター詳細 → チャット開始 or チャット一覧 → 既存チャット再開,
━━━ 4. 役割・権限 ━━━,,,
一般ユーザー,操作権限,全てのチャット機能にアクセス可能 ・ 自分のチャットのみ閲覧・削除可能,
停止ユーザー,アクセス制限,チャット機能にアクセス不可,
━━━ 5. 主要機能一覧 ━━━,,,
新規チャット作成,チャット開始,キャラクター選択後に新規チャットルームを作成 ・ 初期状況メッセージを表示,
メッセージ送信,テキスト送信,テキストメッセージまたは画像を送信 ・ AIが応答を生成,
AI応答生成,AI機能,Google Gemini AIを使用してキャラクターの応答を生成,システムプロンプト ・ ローブック ・ ペルソナを考慮
メッセージ再生成,応答再生成,AIの応答を再生成 ・ 全バージョンを保持しバージョン切り替え可能,
バージョン切り替え,履歴管理,再生成したメッセージの過去バージョンを閲覧,◀▶ボタンで切り替え ・ バージョン番号表示（例: <2/4>）
メッセージ削除,削除機能,ユーザーメッセージ削除時は全ての応答を削除,AIメッセージ削除時は特定バージョンのみ削除 ・ 確認ダイアログ付き
画像送信,画像機能,画像をチャットに送信 ・ AIが画像を認識して応答,
画像表示,画像表示,チャットメッセージ内の画像を表示,クリックで拡大表示（ライトボックス）
初期状況表示,開始メッセージ,チャット開始時の初期状況メッセージを常時表示,キャラクターの最初の台詞を表示
チャットノート,メモ機能,チャットに関するメモを記録 ・ プロットや重要情報を保存,
チャット設定,カスタマイズ,システムプロンプトをカスタマイズ ・ ペルソナ選択 ・ セーフティフィルター設定,
チャット削除,削除機能,チャットルーム全体を削除 ・ 全てのメッセージとノートも削除 ・ 確認ダイアログ付き,
チャット検索,検索機能,チャット一覧でキャラクター名と最後のメッセージ内容で検索,リアルタイムフィルタリング
選択削除,一括削除,チャット一覧で複数のチャットを選択して一括削除 ・ チェックボックス付き,
ローブック検索,AI検索,メッセージ送信時にローブックをベクトル検索 ・ 関連情報をコンテキストに追加,
ローディング表示,UI表示,AI応答生成中に「応答生成中...」メッセージと回転アイコンを表示,再生成中は「再生成中...」表示
━━━ 6. 画面構成（UIブロック） ━━━,,,
チャットヘッダー,表示要素,キャラクター画像 ・ 名前 ・ チャット設定ボタン ・ メニューボタン（削除・ノート）,ChatHeader.tsx
初期状況メッセージ,開始メッセージ,チャット開始時の状況説明 ・ キャラクターの最初の台詞 ・ 常時表示,
メッセージバブル（ユーザー）,ユーザー側,ユーザーのメッセージを右側に表示 ・ 画像表示対応 ・ 削除ボタン付き,
メッセージバブル（AI）,AI側,AIの応答を左側に表示 ・ キャラクター画像付き ・ 再生成・削除・バージョン切り替えボタン付き,
バージョン表示,バージョン管理,再生成したメッセージに「<2/4>」のようなバージョン番号表示,
バージョン切り替えボタン,操作ボタン,◀▶ボタンで過去バージョンを閲覧 ・ 最新バージョンに自動表示,
再生成ボタン,操作ボタン,AIメッセージの下に配置 ・ クリックで再生成開始 ・ ローディング中は無効化,
削除ボタン,操作ボタン,メッセージの下に配置 ・ 確認ダイアログ後に削除,
ローディングインジケーター,UI表示,応答生成中または再生成中に「...中」メッセージと回転アイコンを表示,メッセージバブル内に表示
チャットフッター,入力エリア,メッセージ入力欄（テキストエリア） ・ 画像アップロードボタン ・ 送信ボタン,Enter送信対応（Shift+Enterで改行） ・ ChatFooter.tsx
画像プレビュー,プレビュー,送信前の画像をプレビュー表示 ・ 削除ボタン付き,
チャット設定モーダル,設定画面,システムプロンプトのカスタマイズ ・ ペルソナ選択 ・ セーフティフィルター設定 ・ 保存ボタン,ChatSettings.tsx
チャットノートモーダル,メモ画面,テキストエリアでメモを入力 ・ 保存ボタン,
画像ライトボックス,画像拡大,画像クリック時に大きく表示 ・ 閉じるボタン,ImageLightbox.tsx
確認モーダル,確認画面,メッセージ削除・チャット削除時の確認ダイアログ ・ 削除対象を明確に表示,ConfirmationModal.tsx
チャット一覧テーブル,一覧表示,キャラクター画像 ・ 名前 ・ 最後のメッセージ ・ 更新日時を表示 ・ 選択削除用チェックボックス,
チャット検索バー,検索欄,キャラクター名と最後のメッセージ内容で検索 ・ リアルタイムフィルタリング,
━━━ 7. 画面項目定義 ━━━,,,
【チャット】メッセージ内容,型: string,必須 ・ 1〜2000文字,テキストエリア
【チャット】画像,型: file,任意 ・ jpg/jpeg/png/gif/webp ・ 最大5MB ・ 1枚,画像アップロード
【設定】システムプロンプト,型: string,任意 ・ 最大2000文字,キャラクターのデフォルトプロンプトに追加
【設定】ペルソナ,型: number,任意 ・ ユーザーのペルソナIDを選択,ドロップダウン
【設定】セーフティフィルター,型: boolean,必須 ・ true / false,オン/オフ切り替え
【ノート】ノート内容,型: string,任意 ・ 最大5000文字,テキストエリア
━━━ 8. フィルタ仕様 ━━━,,,
セーフティフィルター,適用方式,ユーザー設定に基づいて不適切なコンテンツをフィルタリング,AI応答生成時に適用
ローブック検索,検索方式,メッセージ送信時にローブックをベクトル検索,関連度が高い上位3件をコンテキストに追加
コンテキスト管理,履歴管理,最新100メッセージをコンテキストとして使用,それ以前のメッセージは要約して使用
━━━ 9. API I/F 仕様 ━━━,,,
POST /api/chat/new,パラメータ,{ characterId ・ note? },レスポンス: { success ・ chatId } ・ 新規チャット作成API
GET /api/chat/[chatId],パラメータ,パスなし,レスポンス: { chat: { id ・ characterId ・ userId ・ note ・ createdAt } } ・ チャット情報取得API
DELETE /api/chat/[chatId],パラメータ,パスなし,レスポンス: { success ・ message } ・ チャット削除API
PUT /api/chat/[chatId]/note,パラメータ,{ note: string },レスポンス: { success } ・ チャットノート更新API
GET /api/chat/messages,パラメータ,{ chatId ・ limit? ・ offset? },レスポンス: { messages: [] ・ total } ・ チャットメッセージ一覧取得API
POST /api/chat/messages,パラメータ,{ chatId ・ content ・ image? ・ parentMessageId? ・ version? },レスポンス: { success ・ message: { id ・ content ・ role ・ version } } ・ メッセージ送信API（ユーザー・AI応答）
DELETE /api/chat/messages/[messageId],パラメータ,パスなし,レスポンス: { success } ・ メッセージ削除API
POST /api/chat/messages/[messageId]/regenerate,パラメータ,{ currentVersion },レスポンス: { success ・ message: { id ・ content ・ version } } ・ メッセージ再生成API
GET /api/chats,パラメータ,{ page? ・ limit? },レスポンス: { chats: [] ・ total } ・ チャット一覧取得API
POST /api/chats/find-or-create,パラメータ,{ characterId },レスポンス: { chatId ・ isNew } ・ チャット検索または作成API（既存チャットがあれば返す）
GET /api/chatlist,パラメータ,{ search? ・ page? ・ limit? },レスポンス: { chats: [] ・ total } ・ チャット一覧取得API（検索機能付き）
━━━ 10. エラー・通知文言 ━━━,,,
送信エラー,表示タイミング: メッセージ送信失敗時,メッセージを送信できませんでした。もう一度お試しください。,
ポイント不足,表示タイミング: ポイント不足時,ポイントが不足しています。ポイントをチャージしてください。,
画像エラー,表示タイミング: 画像サイズオーバー時,画像サイズは5MB以下にしてください。,
画像エラー,表示タイミング: 画像形式エラー時,対応していない画像形式です。,
AI応答エラー,表示タイミング: AI応答生成失敗時,AI応答の生成に失敗しました。もう一度お試しください。,
削除確認（ユーザーメッセージ）,表示タイミング: ユーザーメッセージ削除時,このメッセージを削除してもよろしいですか？ このターンの全ての応答も削除されます。,
削除確認（AIメッセージ）,表示タイミング: AIメッセージ削除時,このバージョンのメッセージを削除してもよろしいですか？,
削除確認（チャット）,表示タイミング: チャット削除時,このチャットを削除してもよろしいですか？ 全てのメッセージとノートも削除されます。,
成功メッセージ,表示タイミング: メッセージ送信成功時,メッセージを送信しました。,
成功メッセージ,表示タイミング: チャット削除成功時,チャットを削除しました。,
ローディング,表示タイミング: AI応答生成中,応答生成中...,
ローディング,表示タイミング: メッセージ再生成中,再生成中...,
━━━ 11. モーダル仕様 ━━━,,,
チャット設定モーダル,トリガー: チャット設定ボタン押下時,内容: システムプロンプトのカスタマイズ ・ ペルソナ選択 ・ セーフティフィルター設定,ボタン: キャンセル ・ 保存
チャットノートモーダル,トリガー: ノートボタン押下時,内容: テキストエリアでメモを入力 ・ 現在のノート内容を表示,ボタン: キャンセル ・ 保存
画像ライトボックス,トリガー: 画像クリック時,内容: 画像を大きく表示 ・ 背景クリックまたは閉じるボタンで閉じる,ボタン: 閉じる
メッセージ削除確認,トリガー: メッセージ削除ボタン押下時,内容: 削除確認メッセージ ・ ユーザーメッセージの場合は全ての応答削除の警告,ボタン: キャンセル ・ 削除
チャット削除確認,トリガー: チャット削除ボタン押下時,内容: 削除確認メッセージ ・ 全てのメッセージとノート削除の警告,ボタン: キャンセル ・ 削除
━━━ 12. 認証・ガード ━━━,,,
認証チェック,制御方式,チャット機能はログイン必須 ・ 未ログインなら/loginへリダイレクト,
権限チェック,制御方式,チャットは作成者のみ閲覧・編集・削除可能 ・ 他ユーザーのチャットにアクセスすると404表示,
ポイントチェック,制御方式,メッセージ送信前にポイント残高を確認 ・ 不足時はエラーメッセージ表示,
停止チェック,制御方式,停止中ユーザーはチャット機能にアクセス不可,
━━━ 13. 非機能要件 ━━━,,,
パフォーマンス,最適化手法,メッセージはページネーション対応（初回50件・以降25件ずつ読み込み） ・ 画像はCDN配信 ・ ローブック検索は高速化,
セキュリティ,セキュリティ対策,メッセージ内容はXSS対策でサニタイズ ・ 画像アップロードはウイルススキャン,
スケーラビリティ,拡張性,AI応答生成は非同期処理 ・ データベースはインデックス最適化,
可用性,エラー処理,AI応答生成失敗時はリトライ機能 ・ 画像読み込みエラー時はプレースホルダー表示,
━━━ 14. テスト観点 ━━━,,,
メッセージ送信: 正常系,テストケース,テキストメッセージ送信でAI応答生成成功,
メッセージ送信: 画像付き,テストケース,画像付きメッセージ送信でAI応答生成成功,
メッセージ送信: 異常系,テストケース,ポイント不足でエラー表示,
メッセージ再生成: 正常系,テストケース,再生成ボタンで新しいバージョン生成 ・ 全バージョン保持確認,
バージョン切り替え: 操作確認,テストケース,◀▶ボタンで過去バージョンを閲覧 ・ バージョン番号表示確認,
メッセージ削除: ユーザー,テストケース,ユーザーメッセージ削除で全ての応答削除確認,
メッセージ削除: AI,テストケース,AIメッセージ削除で特定バージョンのみ削除確認,
初期状況表示: 常時表示,テストケース,チャット入力後も初期状況メッセージが消えないことを確認,
チャットノート: 機能確認,テストケース,ノート保存・編集・削除の動作確認,
チャット設定: AI反映,テストケース,システムプロンプトのカスタマイズがAI応答に反映されることを確認,
チャット削除: 完全削除,テストケース,チャット削除で全てのメッセージとノート削除確認,
チャット検索: 検索機能,テストケース,キャラクター名と最後のメッセージ内容で検索動作確認,
ローブック検索: AI連携,テストケース,メッセージ送信時にローブックが自動検索されることを確認,
画像表示: 表示機能,テストケース,チャット内の画像を表示 ・ ライトボックスで拡大表示確認,
ローディング表示: UI確認,テストケース,応答生成中と再生成中のローディング表示確認,
━━━ 15. 今後の拡張余地 ━━━,,,
音声チャット,提案内容,音声入力・音声出力によるチャット機能,
リアルタイム通知,提案内容,新しいメッセージ受信時のプッシュ通知,
チャット共有,提案内容,チャットを他ユーザーと共有する機能,
チャットエクスポート,提案内容,チャット履歴をPDFやテキスト形式でエクスポート,
マルチキャラクターチャット,提案内容,複数のキャラクターと同時にチャット,
AI画像生成,提案内容,チャット内でAIが画像を生成する機能,
感情表現,提案内容,AIの応答に感情を反映（喜び・悲しみなど）,

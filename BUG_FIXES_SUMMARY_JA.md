# 最近対応したバグと改善内容（原因・対応・対策）

## 1. リンクキャラクター自動生成が時々失敗する
- 原因  
  - Netlify 環境で生成リクエストがタイムアウト／一時的なネットワーク不良時にリトライせず即失敗。  
  - 一部生成 API で GCP 認証準備（`ensureGcpCreds`）が未実行のケース。  
- 対応  
  - 生成系 API（プロフィール / 詳細 / 開始状況 / 日付・場所）に 25 秒タイムアウトを追加（Netlify のデフォルトより短く設定）。  
  - タイムアウト・クォータ・ネットワーク別にエラー応答を分岐。  
  - 全生成 API で `ensureGcpCreds` を実行。  
- 対策  
  - クライアント側で最大 2 回リトライ（計 3 回、1 秒待機）を実装し成功率向上。  
  - ユーザー向けエラーメッセージを明確化し再試行を促す。  

## 2. ステータス設定がないのに状態窓が出る
- 原因  
  - `ChatMessageParser` が `hasStatusWindow=false` でもコードブロックを状態窓として描画。  
  - API がステータスウィンドウ指示を常に付与。  
- 対応  
  - `hasStatusWindow=false` のときコードブロックを通常テキスト扱いに変更。  
  - ステータス設定がない場合は API で指示を付与しない。  
- 対策  
  - 設定有無で描画を厳密に分岐し、不要な状態窓表示を防止。  

## 3. ユーザーノートの X ボタン重複
- 原因  
  - 設定パネルとノートモーダル双方に X が同時表示。  
- 対応  
  - サブモーダル（ノート / 会話保存 / 表示設定）表示中はメインパネルの X を非表示。  
- 対策  
  - モーダル開閉状態に応じてメインのクローズボタン表示を抑止し、重複を再発防止。  

## 4. ユーザー管理テーブルが解像度で崩れる
- 原因  
  - 長文セルやボタンが折り返し、テーブル幅固定不足で崩れ。  
- 対応  
  - `table-auto`＋`min-w`、`whitespace-nowrap`、`truncate` を設定。  
  - 操作ボタンを `flex-nowrap` ＋ `flex-shrink-0` で固定しパディング調整。  
- 対策  
  - モバイル / デスクトップ双方で崩れにくいテーブル構造を維持。  

## 5. マイページ等でボタン位置が画面幅によってずれる
- 原因  
  - 固定サイズのボタン / ヘッダーが小画面で折返し位置ずれ。  
- 対応  
  - 余白・サイズをレスポンシブ化（例: `p-2 sm:p-3`, `w-full sm:w-auto`, `flex-col sm:flex-row`, `truncate`）。  
  - 見出しやアイコンサイズも縮小版を用意。  
- 対策  
  - 主要ヘッダー / ボタンを可変にし、モバイルでも配置が乱れないよう統一。  

## 6. 未ログイン時のチャットリストでエラー表示
- 原因  
  - 未ログインで API が 401 を返した際、リダイレクトせずエラーのみ表示される場合。  
- 対応  
  - `/api/chatlist` が 401 の場合、即 `/login?redirect=/chatlist` へリダイレクト。  
  - その他エラーはモーダル通知し、必要に応じてログイン導線。  
- 対策  
  - 未認証アクセス時の UX を明確化し、エラー放置を防止。  

## 7. リフレッシュトークン無効化（ユーザー追い出し）
- 原因  
  - NextAuth JWT 戦略で `signOut` イベントが発火しないケースで DB の refresh token が残るリスク。  
- 対応  
  - `events.signOut` で `refresh_token / access_token / expires_at` を明示的に null 更新。  
  - `/api/auth/logout` を新設し、タイムアウト・手動ログアウト・退会・停止時に必ず POST して DB 側トークンを無効化。  
- 対策  
  - クライアントの全ログアウト経路とセッションタイムアウトで DB トークンを確実に消去し再利用を防止。  

## 8. 状態窓が表示されない（旧仕様からの変更整理）
- 原因  
  - 以前は「設定がないと表示されない」不満があったが、要件が「設定がない場合は表示しない」に変更。  
- 対応  
  - 上記 2 の修正で表示ロジックと API 指示を同期。  
- 対策  
  - 仕様変更に合わせて表示ロジックを一本化し、意図しない表示を防止。  


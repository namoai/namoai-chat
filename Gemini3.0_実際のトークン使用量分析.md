# Gemini 3.0 実際のトークン使用量分析とコスト計算

## 📊 Gemini 3.0 価格情報（2025年1月時点）

### 公式価格（Vertex AI経由）

**Gemini 3.0 Flash:**
- Input: **$0.075/1M tokens**（Gemini 2.5 Flashと同じ）
- Output: **$0.30/1M tokens**（Gemini 2.5 Flashと同じ）
- **注意**: 公式発表では価格変更なしの可能性あり

**Gemini 3.0 Pro:**
- コンテキスト ≤ 200,000 tokens:
  - Input: **$2.00/1M tokens**（2.5 Pro: $1.25 → **1.6倍**）
  - Output: **$12.00/1M tokens**（2.5 Pro: $5.00 → **2.4倍**）
- コンテキスト > 200,000 tokens:
  - Input: **$4.00/1M tokens**（2.5 Pro: $1.25 → **3.2倍**）
  - Output: **$18.00/1M tokens**（2.5 Pro: $5.00 → **3.6倍**）

**コスト比率:**
- Flash Input: 基準（$0.075/1M）
- Pro Input (≤200k): Flashの**26.7倍**
- Pro Output (≤200k): Flashの**40倍**

**重要**: 本システムの実際のトークン使用量（最大17,150 tokens）は200k tokensを大幅に下回るため、Proモデルは常に「≤200k」の価格が適用されます。

---

## 🔍 実際のシステム構成要素分析

### 1. システムプロンプト構成要素

#### ① システムテンプレート (systemTemplate)
- **最大長**: 制限なし（データベース: `String?`）
- **実測想定**: 500-5,000文字（平均2,000文字）
- **トークン換算**: 約1,000-2,500 tokens（平均1,250 tokens）

#### ② 初期コンテキスト (initialContextText)
- **firstSituation**: 最大1,000文字（生成APIの指示）
- **firstMessage**: 最大500文字（生成APIの指示）
- **合計**: 最大1,500文字（初回メッセージのみ）
- **トークン換算**: 約750 tokens（初回のみ）

#### ③ メモリブック (backMemoryInfo)
- **最大長**: 3,000文字（要約APIの指示）
- **実測想定**: 500-3,000文字（平均1,500文字）
- **トークン換算**: 約750-1,500 tokens（平均750 tokens）

#### ④ 詳細記憶 (detailedMemoryInfo)
- **1件あたり**: 最大2,000文字（`MAX_MEMORY_LENGTH = 2000`）
- **適用数**: 最大3件（`triggeredMemories.length < 3`）
- **最大合計**: 6,000文字（3件 × 2,000文字）
- **実測想定**: 平均4,000文字（2件 × 2,000文字）
- **トークン換算**: 約2,000 tokens（最大3,000 tokens）

#### ⑤ ロアブック (lorebookInfo)
- **1件あたり**: 制限なし（データベース: `String`）
- **適用数**: 最大5件（`triggeredLorebooks.length >= 5`でbreak）
- **実測想定**: 平均500文字/件 × 3件 = 1,500文字
- **トークン換算**: 約750 tokens

#### ⑥ ペルソナ (userPersonaInfo)
- **nickname**: 最大20文字（`VarChar(20)`）
- **description**: 最大1,000文字（`VarChar(1000)`）
- **合計**: 最大1,020文字
- **トークン換算**: 約500 tokens

#### ⑦ 画像インストラクション (imageInstruction)
- **画像数**: 最大100枚（`images.length > 100`で制限）
- **実測想定**: 平均10枚 × 50文字/枚 = 500文字
- **トークン換算**: 約250 tokens

#### ⑧ フォーマットインストラクション (formattingInstruction)
- **固定長**: 約800-1,000文字
- **トークン換算**: 約400-500 tokens（平均450 tokens）

#### ⑨ ブーストインストラクション (boostInstruction)
- **条件付き**: ブースト使用時のみ
- **長さ**: 約100文字
- **トークン換算**: 約50 tokens

### 2. チャット履歴

#### ① 最新メッセージ (orderedHistory)
- **取得数**: 最新10件（`take: 10`）
- **実測想定**: 
  - ユーザーメッセージ: 平均100文字/件
  - AI応答: 平均1,000文字/件（800-1,100文字の指示）
  - 合計: 10件 × 550文字 = 5,500文字
- **トークン換算**: 約2,750 tokens

#### ② ベクトル検索メッセージ (vectorMatchedMessages)
- **取得数**: 最大10件（`searchSimilarMessages(..., 10)`）
- **実測想定**: 平均5件 × 550文字 = 2,750文字
- **トークン換算**: 約1,375 tokens

#### ③ 現在のユーザーメッセージ
- **長さ**: 平均100文字
- **トークン換算**: 約50 tokens

### 3. 出力（AI応答）

- **指示**: 800-1,100文字
- **実測想定**: 平均950文字
- **トークン換算**: 約475 tokens

---

## 📐 トークン使用量計算（最悪ケース：すべて最大）

### シナリオ1: 初回メッセージ（すべて最大）

| 項目 | 文字数 | トークン数 |
|------|--------|-----------|
| **システムプロンプト** | | |
| systemTemplate | 5,000 | 2,500 |
| initialContext (firstSituation + firstMessage) | 1,500 | 750 |
| backMemory | 3,000 | 1,500 |
| detailedMemory (3件) | 6,000 | 3,000 |
| lorebook (5件) | 2,500 | 1,250 |
| persona | 1,020 | 500 |
| imageInstruction (100枚) | 5,000 | 2,500 |
| formattingInstruction | 1,000 | 500 |
| boostInstruction | 100 | 50 |
| **システムプロンプト合計** | **22,120** | **11,050** |
| **チャット履歴** | | |
| orderedHistory (10件) | 5,500 | 2,750 |
| vectorMatchedMessages (10件) | 5,500 | 2,750 |
| 現在のユーザーメッセージ | 100 | 50 |
| **チャット履歴合計** | **11,100** | **5,550** |
| **Input合計** | **33,220** | **16,600** |
| **Output** | 1,100 | 550 |
| **総トークン数** | - | **17,150** |

### シナリオ2: 通常メッセージ（平均値）

| 項目 | 文字数 | トークン数 |
|------|--------|-----------|
| **システムプロンプト** | | |
| systemTemplate | 2,000 | 1,000 |
| backMemory | 1,500 | 750 |
| detailedMemory (2件) | 4,000 | 2,000 |
| lorebook (3件) | 1,500 | 750 |
| persona | 1,020 | 500 |
| imageInstruction (10枚) | 500 | 250 |
| formattingInstruction | 900 | 450 |
| **システムプロンプト合計** | **11,420** | **5,700** |
| **チャット履歴** | | |
| orderedHistory (10件) | 5,500 | 2,750 |
| vectorMatchedMessages (5件) | 2,750 | 1,375 |
| 現在のユーザーメッセージ | 100 | 50 |
| **チャット履歴合計** | **8,350** | **4,175** |
| **Input合計** | **19,770** | **9,875** |
| **Output** | 950 | 475 |
| **総トークン数** | - | **10,350** |

### シナリオ3: 最小ケース（新規チャット、最小設定）

| 項目 | 文字数 | トークン数 |
|------|--------|-----------|
| **システムプロンプト** | | |
| systemTemplate | 500 | 250 |
| initialContext | 1,000 | 500 |
| formattingInstruction | 800 | 400 |
| **システムプロンプト合計** | **2,300** | **1,150** |
| **チャット履歴** | | |
| 現在のユーザーメッセージ | 50 | 25 |
| **チャット履歴合計** | **50** | **25** |
| **Input合計** | **2,350** | **1,175** |
| **Output** | 800 | 400 |
| **総トークン数** | - | **1,575** |

---

## 💰 Gemini 3.0 コスト計算

### Flash（コンテキスト ≤ 200k tokens）

#### シナリオ1: 最悪ケース（初回、すべて最大）
- Input: 16,600 tokens × $0.075/1M = **$0.001245**
- Output: 550 tokens × $0.30/1M = **$0.000165**
- **合計: $0.00141 = 0.21 JPY**（約0.16円）

#### シナリオ2: 通常ケース（平均値）
- Input: 9,875 tokens × $0.075/1M = **$0.000741**
- Output: 475 tokens × $0.30/1M = **$0.000143**
- **合計: $0.000884 = 0.13 JPY**（約0.1円）

#### シナリオ3: 最小ケース
- Input: 1,175 tokens × $0.075/1M = **$0.000088**
- Output: 400 tokens × $0.30/1M = **$0.00012**
- **合計: $0.000208 = 0.03 JPY**（約0.02円）

### Pro（コンテキスト ≤ 200k tokens）

#### シナリオ1: 最悪ケース（初回、すべて最大）
- Input: 16,600 tokens × $2.00/1M = **$0.0332**
- Output: 550 tokens × $12.00/1M = **$0.0066**
- **合計: $0.0398 = 5.97 JPY**（約4.5円）

#### シナリオ2: 通常ケース（平均値）
- Input: 9,875 tokens × $2.00/1M = **$0.01975**
- Output: 475 tokens × $12.00/1M = **$0.0057**
- **合計: $0.02545 = 3.82 JPY**（約2.9円）

#### シナリオ3: 最小ケース
- Input: 1,175 tokens × $2.00/1M = **$0.00235**
- Output: 400 tokens × $12.00/1M = **$0.0048**
- **合計: $0.00715 = 1.07 JPY**（約0.8円）

### Pro（コンテキスト > 200k tokens、最悪ケース）

#### シナリオ1: 最悪ケース（初回、すべて最大）
- Input: 16,600 tokens × $4.00/1M = **$0.0664**
- Output: 550 tokens × $18.00/1M = **$0.0099**
- **合計: $0.0763 = 11.45 JPY**（約8.6円）

---

## 📊 ポイント制度検証

### 提案価格設定

**初期価格（50%セール）:**
- 3000チャット = 100,000円
- 1ポイント = 33.3円

**ポイント消費:**
- Flash: 5ポイント = 166.5円
- Pro: 20ポイント = 666円

### コスト vs 収益分析

#### Flash（5ポイント = 166.5円）

| シナリオ | 実際のコスト | 収益 | マージン | マージン率 |
|---------|------------|------|---------|-----------|
| **最悪ケース** | 0.21 JPY | 166.5円 | 166.3円 | **99.87%** |
| **通常ケース** | 0.13 JPY | 166.5円 | 166.4円 | **99.92%** |
| **最小ケース** | 0.03 JPY | 166.5円 | 166.5円 | **99.98%** |

#### Pro（20ポイント = 666円）

| シナリオ | 実際のコスト | 収益 | マージン | マージン率 |
|---------|------------|------|---------|-----------|
| **最悪ケース (≤200k)** | 5.97 JPY | 666円 | 660円 | **99.10%** |
| **通常ケース (≤200k)** | 3.82 JPY | 666円 | 662円 | **99.43%** |
| **最小ケース (≤200k)** | 1.07 JPY | 666円 | 665円 | **99.84%** |
| **最悪ケース (>200k)** | 11.45 JPY | 666円 | 655円 | **98.28%** |

---

## ✅ 結論：5ポイント/20ポイント制度の妥当性

### 検証結果

**✅ Flash 5ポイント、Pro 20ポイントは適切です**

**理由:**

1. **コスト比率の適切性**
   - ProはFlashの約28倍（最悪ケース）のコスト
   - ポイント比率は4倍（5 vs 20）
   - マージン率が高いため、十分な収益性を確保

2. **最悪ケースでも高いマージン率**
   - Flash: 99.87%以上
   - Pro: 98.28%以上（コンテキスト > 200kでも）

3. **価格競争力**
   - Flash: チャット1件あたり約33円（初期価格）
   - Pro: チャット1件あたり約133円（初期価格）
   - 競合サービスと比較して競争力あり

### 推奨事項

1. **初期価格設定**: 3000チャットに10万円（50%セール）は適切
2. **ポイント消費**: Flash 5ポイント、Pro 20ポイントは適切
3. **価格上昇への備え**: Gemini 3.0の価格上昇にも十分対応可能

---

## 📈 詳細分析：各要素のトークン使用量

### システムプロンプト内訳（最悪ケース）

| 要素 | 最大文字数 | トークン数 | 割合 |
|------|-----------|-----------|------|
| systemTemplate | 5,000 | 2,500 | 22.6% |
| imageInstruction | 5,000 | 2,500 | 22.6% |
| detailedMemory | 6,000 | 3,000 | 27.1% |
| backMemory | 3,000 | 1,500 | 13.6% |
| lorebook | 2,500 | 1,250 | 11.3% |
| initialContext | 1,500 | 750 | 6.8% |
| persona | 1,020 | 500 | 4.5% |
| formattingInstruction | 1,000 | 500 | 4.5% |
| boostInstruction | 100 | 50 | 0.5% |
| **合計** | **25,120** | **11,050** | **100%** |

### チャット履歴内訳（最悪ケース）

| 要素 | 最大文字数 | トークン数 | 割合 |
|------|-----------|-----------|------|
| orderedHistory (10件) | 5,500 | 2,750 | 49.5% |
| vectorMatchedMessages (10件) | 5,500 | 2,750 | 49.5% |
| 現在のユーザーメッセージ | 100 | 50 | 1.0% |
| **合計** | **11,100** | **5,550** | **100%** |

---

## 🎯 最終推奨事項

### 1. ポイント制度

**✅ Flash 5ポイント、Pro 20ポイントを推奨**

**根拠:**
- 最悪ケースでもマージン率98%以上
- コスト比率（28倍）に対してポイント比率（4倍）は適切
- 高い収益性を確保

### 2. 価格設定

**✅ 初期価格: 3000チャットに10万円（50%セール）を推奨**

**根拠:**
- チャット1件あたり約33円（Flash基準）
- 競合サービスと比較して競争力あり
- セール終了後も2000チャットに10万円で維持可能

### 3. 実装時の注意点

1. **コンテキスト長の監視**: 200k tokensを超える場合はPro価格が2倍になる
2. **システムプロンプトの最適化**: 不要な要素を削減してコスト削減
3. **ユーザーへの説明**: Flash/Proの違いを明確に説明

---

**作成日**: 2025-01-27  
**最終更新日**: 2025-01-27  
**バージョン**: 1.0


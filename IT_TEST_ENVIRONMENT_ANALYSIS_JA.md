# ITテスト環境の必要性分析

## ① 概要

### この資料の目的

本資料は**ITテスト環境（統合テスト環境）の必要性とコスト**を分析し、プロジェクトチームが環境構成を決定できるよう支援します。

**分析対象:**
- ローカルテスト環境 vs ITテスト環境の比較
- ITテスト環境構築コスト（AWS RDS基準）
- 環境構成の推奨事項

**対象読者:**
- プロジェクト管理者
- 開発チームリーダー
- インフラ担当者

---

## ② 結論（要点）

### 核心結論

**ITテスト環境は開発者3名以上のチームで推奨されます。**

**コスト:**
- 必要な時のみ実行: **約500-1,000円/月**（推奨）
- 24時間継続実行: **約3,275円/月**（非推奨）
- AWS無料利用枠適用時: **0円/月**（12ヶ月間、750時間以内）

**推奨構成:**
- **小規模チーム（1-2名）**: ローカル + ステージング（IT環境不要）
- **中規模チーム（3名以上）**: ローカル + IT環境 + ステージング + 本番

**構築時間:** 約4-6時間の所要見込み

---

## ③ 詳細

### 1. 事実（Fact）

#### 1.1 環境比較

| 項目 | ローカルテスト環境 | ITテスト環境 |
|------|----------------|---------------|
| **場所** | 各開発者のコンピューター | AWS RDS（クラウド） |
| **コスト** | 0円/月 | 500-3,275円/月 |
| **速度** | 非常に高速 | 普通（ネットワーク遅延） |
| **独立性** | 各自独立 | チーム共有 |
| **統合テスト** | 困難 | 可能 |
| **CI/CD連携** | 困難 | 可能 |

#### 1.2 ITテスト環境のコスト計算（事実）

**環境仕様:**
- インスタンス: PostgreSQL db.t3.micro
- リージョン: ap-northeast-1c（東京）
- デプロイ: Single-AZ（Multi-AZではない）

**月額コスト計算（24時間実行時）:**
- DBインスタンス: 0.026 USD/時間 × 24時間 × 30日 = 18.72 USD
- ストレージ（20GB）: 20GB × 0.115 USD/GB = 2.3 USD
- バックアップストレージ（20GB）: 20GB × 0.095 USD/GB = 1.9 USD
- データ転送（10GB）: 最初の1GB無料 + 9GB × 0.09 USD = 0.81 USD
- **合計月額コスト: 約23.73 USD ≈ 3,560円/月**（為替レート 1 USD = 150 JPY基準）

**コスト削減シナリオ（事実）:**
- 月40時間使用: 約500円/月
- 週5日、1日8時間: 約969円/月
- 24時間継続実行: 約3,153円/月

**AWS無料利用枠（事実）:**
- 新規AWSアカウントは12ヶ月間 db.t3.micro 750時間/月 + 20GBストレージ無料
- 無料利用枠適用時: 月0円（750時間以内）

#### 1.3 環境間のデータ移動方法（事実）

**IT環境 → ステージング/本番環境:**

1. **APIによるキャラクターExport/Import**
   - APIエンドポイント: `/api/characters/[id]/import`
   - IT環境でJSON Export → ステージング/本番でImport

2. **データベース直接マイグレーション**
   - `pg_dump`でIT環境DBをバックアップ
   - `pg_restore`でステージング/本番環境に復元

3. **手動コピー**
   - IT環境でキャラクター情報を確認後、ステージング/本番で再作成

#### 1.4 IT環境の制御方法（事実）

**管理パネルから制御:**
- 本番またはステージング環境の管理パネル（`/admin/it-environment`）から制御可能
- SUPER_ADMIN権限が必要
- 開始/停止/状態確認機能を提供

**AWS CLIで制御:**
```bash
# 停止
aws rds stop-db-instance --db-instance-identifier namos-chat-it

# 開始
aws rds start-db-instance --db-instance-identifier namos-chat-it
```

---

### 2. 意見（Opinion）および推奨事項

#### 2.1 ITテスト環境が必要な場合（意見）

**判断基準:**
- ✅ **チーム規模**: 開発者3名以上
- ✅ **CI/CDパイプライン**: 自動化されたテストが必要
- ✅ **統合テスト**: 複数システム間の統合検証が必須
- ✅ **本番環境の安定性**: デプロイ前に実際の環境と同様の検証が必要

**理由:**
- ローカル環境だけでは複数システム間の統合テストが困難
- CI/CDパイプラインで自動化されたテスト実行が必要
- 本番デプロイ前に問題を事前に発見し、サービスの安定性を確保

#### 2.2 ITテスト環境が不要な場合（意見）

**判断基準:**
- ❌ 開発者1-2名
- ❌ 小規模プロジェクト
- ❌ コスト制約
- ❌ ローカル + ステージングで十分

**理由:**
- 小規模チームではローカル環境だけでも十分なテストが可能
- 追加コスト負担が大きい場合
- シンプルなプロジェクトは統合テスト環境が過剰な場合がある

#### 2.3 コスト削減推奨事項（意見）

**核心戦略: 必要な時のみ実行し、終わったら停止**

**推奨使用パターン:**
- テストする時だけIT環境を開始
- テスト完了後、即座に停止
- 月使用時間: 約20-40時間を目標
- 予想コスト: 約500-1,000円/月

**非推奨:**
- 24時間継続実行（月3,000円以上）
- 使用しないのに実行状態で放置

**理由:**
- RDSは実行時間に比例してコストが発生
- 停止してもストレージコスト（約345円/月）のみ発生
- 必要な時のみ実行すればコストを大幅に削減可能

#### 2.4 環境構成推奨事項（意見）

**小規模チーム（1-2名）:**
```
ローカル環境 → ステージング環境 → 本番環境
```
- IT環境不要
- コスト: 0円/月

**中規模チーム（3名以上）:**
```
ローカル環境 → ITテスト環境 → ステージング環境 → 本番環境
```
- IT環境推奨
- コスト: 約500-1,000円/月（必要な時のみ実行）

**理由:**
- チーム規模が大きくなるほど統合テストの重要性が増加
- 複数の開発者が同時に作業する際、共有テスト環境が必要
- CI/CDパイプライン構築時、IT環境が必須

#### 2.5 構築時間見込み（意見）

**見込み時間: 約4-6時間**

**含まれる作業:**
- AWS RDSインスタンス作成および設定
- 環境変数設定
- 管理パネル連携
- テストおよび検証

**理由:**
- AWS RDSインスタンス作成: 約1-2時間（待機時間含む）
- 環境設定および連携: 約1-2時間
- テストおよび検証: 約1-2時間

---

### 3. 結論に至った根拠

#### 3.1 IT環境必要性の根拠

**事実ベース:**
- ローカル環境は統合テストに限界がある（表1.1参照）
- CI/CDパイプラインは共有テスト環境が必要
- 本番デプロイ前の検証は実際の環境と同様の条件で実施すべき

**意見:**
- 開発者3名以上のチームではIT環境構築を推奨
- 統合テストとCI/CD自動化が重要なプロジェクトでは必須

#### 3.2 コスト根拠

**事実ベース:**
- AWS RDS db.t3.micro 24時間実行時: 約3,560円/月
- 必要な時のみ実行時: 約500-1,000円/月
- AWS無料利用枠: 12ヶ月間無料（750時間/月以内）

**意見:**
- 必要な時のみ実行する方式がコスト効率的
- 無料利用枠を活用すれば初期12ヶ月は無料で使用可能
- 24時間継続実行は非推奨（コストの無駄）

#### 3.3 環境構成推奨根拠

**事実ベース:**
- 小規模チーム（1-2名）はローカル環境だけでも十分な場合が多い
- 中規模チーム（3名以上）は統合テスト環境が必要

**意見:**
- チーム規模とプロジェクトの複雑さに応じて環境構成を決定
- コストと必要性のバランスを考慮して選択

---

## 参考事項

### 環境変数設定

IT環境制御のための環境変数:

```bash
# IT環境RDSインスタンス識別子
IT_RDS_INSTANCE_IDENTIFIER=namos-chat-it

# AWSリージョン
AWS_REGION=ap-northeast-1
```

### セキュリティ考慮事項

- IT環境制御はSUPER_ADMIN権限のみ許可
- 本番またはステージング環境からのみ制御可能に制限することを推奨
- AWS IAM権限を適切に設定する必要がある

---

**作成日:** 2025-01-27  
**作成者:** プロジェクトチーム  
**レビュー必要:** インフラ担当者、プロジェクト管理者



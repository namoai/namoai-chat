# ğŸ’³ æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ çµ±åˆã‚¬ã‚¤ãƒ‰

## ğŸ“Š PayPay vs PayPal æ¯”è¼ƒ

### æ¨å¥¨: **PayPay** ã‚’ä¸»åŠ›ã¨ã—ã¦ä½¿ç”¨

| é …ç›® | PayPay | PayPal |
|------|--------|--------|
| **æ‰‹æ•°æ–™** | 1.98%~3.24% | 3.6% + 40å†† |
| **å¯¾è±¡åœ°åŸŸ** | æ—¥æœ¬ã®ã¿ | å…¨ä¸–ç•Œ |
| **æœˆé¡å›ºå®šè²»** | 0å††~1,980å†† | 0å†† |
| **æ±ºæ¸ˆé€Ÿåº¦** | å³åº§ | å³åº§ |
| **æ—¥æœ¬ã§ã®äººæ°—** | âœ… éå¸¸ã«é«˜ã„ | âš ï¸ ä¸­ç¨‹åº¦ |
| **å®Ÿè£…é›£æ˜“åº¦** | ä¸­ | æ˜“ |

**çµè«–**: æ—¥æœ¬å¸‚å ´ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã—ã¦ã„ã‚‹ãŸã‚ã€**PayPayã‚’ä¸»åŠ›**ã«ã€æµ·å¤–ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«**PayPalã‚’è£œåŠ©**ã¨ã—ã¦æä¾›ã™ã‚‹ã®ãŒæœ€é©ã§ã™ã€‚

---

## ğŸ¯ å®Ÿè£…æˆ¦ç•¥

### Phase 1: PayPay å®Ÿè£…ï¼ˆå„ªå…ˆï¼‰
- æ—¥æœ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®80%ä»¥ä¸Šã‚’ã‚«ãƒãƒ¼
- æ‰‹æ•°æ–™ãŒæœ€ã‚‚å®‰ã„ï¼ˆ1.98%~ï¼‰

### Phase 2: PayPal è¿½åŠ ï¼ˆæµ·å¤–å±•é–‹æ™‚ï¼‰
- åœ¨æ—¥å¤–å›½äººã€æµ·å¤–å±•é–‹æº–å‚™
- PayPayä½¿ãˆãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘

---

## ğŸ“¦ 1. PayPay æ±ºæ¸ˆã®å®Ÿè£…

### âš ï¸ é‡è¦: ç”³è«‹ãƒ»æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹

**PayPayã¯ã€Œç™»éŒ²ã—ã¦ã™ãä½¿ãˆã‚‹ã€ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼**

å®Ÿéš›ã®å®Ÿè£…ã«ã¯ä»¥ä¸‹ãŒå¿…è¦ã§ã™ï¼š
- âœ… äº‹æ¥­è€…ç™»éŒ²ï¼ˆæ³•äººã¾ãŸã¯å€‹äººäº‹æ¥­ä¸»ï¼‰
- âœ… PayPay for Business ç”³è«‹ï¼ˆå¯©æŸ»æœŸé–“: 2ã€œ4é€±é–“ï¼‰
- âœ… éŠ€è¡Œå£åº§é€£æºãƒ»ç¢ºèªï¼ˆ2ã€œ3å–¶æ¥­æ—¥ï¼‰
- âœ… APIã‚­ãƒ¼å–å¾—ï¼ˆå¯©æŸ»é€šéå¾Œï¼‰
- âœ… ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ1ã€œ2é€±é–“ï¼‰
- âœ… æœ¬ç•ªç’°å¢ƒç”³è«‹ï¼ˆ1é€±é–“ï¼‰

**ç›®å®‰æœŸé–“: ç´„2ã€œ3ãƒ¶æœˆ**

è©³ç´°ãªç”³è«‹ãƒ—ãƒ­ã‚»ã‚¹ã¯ `PAYMENT_APPLICATION_PROCESS.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### 1.1 PayPay åŠ ç›Ÿåº—ç”³è«‹

1. **PayPay for Business** ã«ç™»éŒ²
   - URL: https://paypay.ne.jp/business/
   - å¿…è¦æ›¸é¡: 
     - æ³•äººç™»è¨˜ç°¿è¬„æœ¬ï¼ˆæ³•äººã®å ´åˆï¼‰
     - é–‹æ¥­å±Šå‡ºæ›¸ï¼ˆå€‹äººäº‹æ¥­ä¸»ã®å ´åˆï¼‰
     - éŠ€è¡Œå£åº§æƒ…å ±
     - äº‹æ¥­å†…å®¹èª¬æ˜æ›¸
     - ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURL

2. **å¯©æŸ»ãƒ—ãƒ­ã‚»ã‚¹**ï¼ˆ2ã€œ4é€±é–“ï¼‰
   - äº‹æ¥­è€…ã®å®Ÿåœ¨æ€§ç¢ºèª
   - äº‹æ¥­å†…å®¹ã®é©åˆ‡æ€§ç¢ºèª
   - ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®å†…å®¹ç¢ºèª
   - è¦ç´„éµå®ˆã®å¯èƒ½æ€§ç¢ºèª

3. **API ã‚­ãƒ¼å–å¾—**ï¼ˆå¯©æŸ»é€šéå¾Œï¼‰
   - ç®¡ç†ç”»é¢ã‹ã‚‰ã€ŒAPIé€£æºã€ã‚’é¸æŠ
   - `CLIENT_ID` ã¨ `CLIENT_SECRET` ã‚’å–å¾—

### 1.2 ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# .env.local ã¾ãŸã¯ Secret Manager ã«è¿½åŠ 
PAYPAY_CLIENT_ID=your_client_id_here
PAYPAY_CLIENT_SECRET=your_client_secret_here
PAYPAY_MERCHANT_ID=your_merchant_id_here
PAYPAY_API_KEY=your_api_key_here
PAYPAY_ENVIRONMENT=sandbox  # æœ¬ç•ªç’°å¢ƒã§ã¯ 'production'
```

### 1.3 PayPay SDK ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @paypay/paypayopa
```

### 1.4 PayPay æ±ºæ¸ˆ API å®Ÿè£…

`src/app/api/payments/paypay/create-payment/route.ts` ã‚’ä½œæˆ:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import paypayopa from '@paypay/paypayopa';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/nextauth';
import prisma from '@/lib/prisma';

// PayPay SDK è¨­å®š
paypayopa.Configure({
  clientId: process.env.PAYPAY_CLIENT_ID!,
  clientSecret: process.env.PAYPAY_CLIENT_SECRET!,
  merchantId: process.env.PAYPAY_MERCHANT_ID!,
  productionMode: process.env.PAYPAY_ENVIRONMENT === 'production',
});

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'èªè¨¼ãŒå¿…è¦ã§ã™' }, { status: 401 });
    }

    const userId = parseInt(session.user.id, 10);
    const { pointAmount, planId } = await request.json();

    // ãƒã‚¤ãƒ³ãƒˆãƒ—ãƒ©ãƒ³ã®å®šç¾©
    const POINT_PLANS: Record<string, { points: number; price: number }> = {
      plan_100: { points: 100, price: 120 },
      plan_500: { points: 500, price: 600 },
      plan_1000: { points: 1000, price: 1200 },
      plan_3000: { points: 3000, price: 3400 },
      plan_5000: { points: 5000, price: 5500 },
      plan_10000: { points: 10000, price: 10000 },
    };

    const selectedPlan = POINT_PLANS[planId];
    if (!selectedPlan) {
      return NextResponse.json({ error: 'ç„¡åŠ¹ãªãƒ—ãƒ©ãƒ³ã§ã™' }, { status: 400 });
    }

    // æ³¨æ–‡IDã‚’ç”Ÿæˆ
    const orderId = `order_${userId}_${Date.now()}`;

    // PayPay æ±ºæ¸ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
    const payload = {
      merchantPaymentId: orderId,
      amount: {
        amount: selectedPlan.price,
        currency: 'JPY',
      },
      orderDescription: `${selectedPlan.points}ãƒã‚¤ãƒ³ãƒˆè³¼å…¥`,
      userAgent: request.headers.get('user-agent') || 'namos-chat',
    };

    // PayPay QRã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ç”Ÿæˆ
    const response = await paypayopa.code.createQRCode(payload);

    if (response.STATUS !== 'SUCCESS') {
      console.error('PayPayæ±ºæ¸ˆä½œæˆã‚¨ãƒ©ãƒ¼:', response);
      return NextResponse.json(
        { error: 'PayPayæ±ºæ¸ˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ' },
        { status: 500 }
      );
    }

    // æ±ºæ¸ˆæƒ…å ±ã‚’DBã«ä¿å­˜ï¼ˆpendingçŠ¶æ…‹ï¼‰
    await prisma.payment_transactions.create({
      data: {
        userId: userId,
        orderId: orderId,
        paymentMethod: 'paypay',
        amount: selectedPlan.price,
        pointAmount: selectedPlan.points,
        status: 'pending',
        paymentData: JSON.stringify(response.DATA),
      },
    });

    // QRã‚³ãƒ¼ãƒ‰URLã¨ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã‚’è¿”ã™
    return NextResponse.json({
      success: true,
      paymentUrl: response.DATA.url, // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹URL
      deeplink: response.DATA.deeplink, // ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªç”¨
      orderId: orderId,
      expiresAt: response.DATA.expiryDate,
    });
  } catch (error) {
    console.error('PayPayæ±ºæ¸ˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'æ±ºæ¸ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' },
      { status: 500 }
    );
  }
}
```

### 1.5 PayPay Webhook å®Ÿè£…

`src/app/api/payments/paypay/webhook/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import paypayopa from '@paypay/paypayopa';
import prisma from '@/lib/prisma';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { merchantPaymentId } = body;

    console.log('PayPay Webhookå—ä¿¡:', body);

    // PayPay APIã§æ±ºæ¸ˆçŠ¶æ…‹ã‚’ç¢ºèª
    const paymentDetails = await paypayopa.payment.getPaymentDetails(merchantPaymentId);

    if (paymentDetails.STATUS !== 'SUCCESS') {
      return NextResponse.json({ error: 'æ±ºæ¸ˆç¢ºèªå¤±æ•—' }, { status: 400 });
    }

    const paymentData = paymentDetails.DATA;

    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
    const transaction = await prisma.payment_transactions.findUnique({
      where: { orderId: merchantPaymentId },
    });

    if (!transaction) {
      return NextResponse.json({ error: 'ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' }, { status: 404 });
    }

    // æ—¢ã«å‡¦ç†æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if (transaction.status === 'completed') {
      return NextResponse.json({ message: 'æ—¢ã«å‡¦ç†æ¸ˆã¿' });
    }

    // æ±ºæ¸ˆãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆ
    if (paymentData.status === 'COMPLETED') {
      await prisma.$transaction(async (tx) => {
        // ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸
        await tx.points.update({
          where: { user_id: transaction.userId },
          data: {
            paid_points: { increment: transaction.pointAmount },
          },
        });

        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
        await tx.payment_transactions.update({
          where: { id: transaction.id },
          data: {
            status: 'completed',
            completedAt: new Date(),
            paymentData: JSON.stringify(paymentData),
          },
        });

        // ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã«è¨˜éŒ²
        await tx.point_history.create({
          data: {
            userId: transaction.userId,
            type: 'purchase',
            amount: transaction.pointAmount,
            paymentMethod: 'paypay',
            orderId: merchantPaymentId,
            description: `PayPayæ±ºæ¸ˆ - ${transaction.pointAmount}ãƒã‚¤ãƒ³ãƒˆè³¼å…¥`,
          },
        });
      });

      console.log(`âœ… PayPayæ±ºæ¸ˆå®Œäº†: User ${transaction.userId} ã« ${transaction.pointAmount} ãƒã‚¤ãƒ³ãƒˆä»˜ä¸`);

      return NextResponse.json({ success: true });
    }

    // æ±ºæ¸ˆå¤±æ•—ã®å ´åˆ
    if (paymentData.status === 'FAILED' || paymentData.status === 'CANCELED') {
      await prisma.payment_transactions.update({
        where: { id: transaction.id },
        data: {
          status: 'failed',
          paymentData: JSON.stringify(paymentData),
        },
      });

      return NextResponse.json({ message: 'æ±ºæ¸ˆå¤±æ•—ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«' });
    }

    return NextResponse.json({ message: 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªå®Œäº†' });
  } catch (error) {
    console.error('PayPay Webhook ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({ error: 'Webhookå‡¦ç†ã‚¨ãƒ©ãƒ¼' }, { status: 500 });
  }
}
```

### 1.6 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

`src/app/points/page.tsx` ã«PayPayãƒœã‚¿ãƒ³ã‚’è¿½åŠ :

```typescript
const handlePayPayPayment = async (planId: string) => {
  try {
    setLoading(true);
    
    const response = await fetch('/api/payments/paypay/create-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ planId }),
    });

    const data = await response.json();

    if (data.success) {
      // PayPayæ±ºæ¸ˆç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      window.location.href = data.paymentUrl;
      
      // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨
      // if (isMobile) {
      //   window.location.href = data.deeplink;
      // }
    } else {
      alert('æ±ºæ¸ˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (error) {
    console.error('PayPayæ±ºæ¸ˆã‚¨ãƒ©ãƒ¼:', error);
    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  } finally {
    setLoading(false);
  }
};

// UIã«è¿½åŠ 
<button
  onClick={() => handlePayPayPayment('plan_1000')}
  className="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg"
>
  PayPayã§è³¼å…¥ (1,200å††)
</button>
```

---

## ğŸ’³ 2. PayPal æ±ºæ¸ˆã®å®Ÿè£…

### âš ï¸ é‡è¦: ç”³è«‹ãƒ»æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹

**PayPalã‚‚ã€Œç™»éŒ²ã—ã¦ã™ãä½¿ãˆã‚‹ã€ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼**

å®Ÿéš›ã®å®Ÿè£…ã«ã¯ä»¥ä¸‹ãŒå¿…è¦ã§ã™ï¼š
- âœ… PayPal Business ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- âœ… ãƒ“ã‚¸ãƒã‚¹æƒ…å ±ç™»éŒ²ãƒ»æœ¬äººç¢ºèªï¼ˆ1ã€œ2é€±é–“ï¼‰
- âœ… éŠ€è¡Œå£åº§é€£æºãƒ»ç¢ºèªï¼ˆ2ã€œ3å–¶æ¥­æ—¥ï¼‰
- âœ… å¯©æŸ»é€šé
- âœ… REST API ã‚­ãƒ¼å–å¾—
- âœ… ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ1é€±é–“ï¼‰
- âœ… æœ¬ç•ªç’°å¢ƒç”³è«‹

**ç›®å®‰æœŸé–“: ç´„1ã€œ2ãƒ¶æœˆ**

è©³ç´°ãªç”³è«‹ãƒ—ãƒ­ã‚»ã‚¹ã¯ `PAYMENT_APPLICATION_PROCESS.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### 2.1 PayPal ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š

1. **PayPal Business ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
   - URL: https://www.paypal.com/jp/business
   - ãƒ“ã‚¸ãƒã‚¹æƒ…å ±ç™»éŒ²
   - æœ¬äººç¢ºèªæ›¸é¡ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
   
2. **å¯©æŸ»ãƒ—ãƒ­ã‚»ã‚¹**ï¼ˆ1ã€œ2é€±é–“ï¼‰
   - ãƒ“ã‚¸ãƒã‚¹ã®å®Ÿåœ¨æ€§ç¢ºèª
   - æœ¬äººç¢ºèª
   - äº‹æ¥­å†…å®¹ã®é©åˆ‡æ€§ç¢ºèª

3. **REST API ã‚­ãƒ¼å–å¾—**ï¼ˆå¯©æŸ»é€šéå¾Œï¼‰
   - https://developer.paypal.com/ ã«ãƒ­ã‚°ã‚¤ãƒ³
   - ã€ŒMy Apps & Credentialsã€ã‹ã‚‰ Client ID ã¨ Secret ã‚’å–å¾—
   - ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç”¨ã¨æœ¬ç•ªç”¨ã§ç•°ãªã‚‹

### 2.2 ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
PAYPAL_CLIENT_ID=your_paypal_client_id
PAYPAL_CLIENT_SECRET=your_paypal_client_secret
PAYPAL_MODE=sandbox  # æœ¬ç•ªç’°å¢ƒã§ã¯ 'live'
```

### 2.3 PayPal SDK ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @paypal/checkout-server-sdk
```

### 2.4 PayPal æ±ºæ¸ˆ API å®Ÿè£…

`src/app/api/payments/paypal/create-order/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import checkoutNodeJssdk from '@paypal/checkout-server-sdk';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/nextauth';
import prisma from '@/lib/prisma';

// PayPalç’°å¢ƒè¨­å®š
function environment() {
  const clientId = process.env.PAYPAL_CLIENT_ID!;
  const clientSecret = process.env.PAYPAL_CLIENT_SECRET!;

  if (process.env.PAYPAL_MODE === 'live') {
    return new checkoutNodeJssdk.core.LiveEnvironment(clientId, clientSecret);
  }
  return new checkoutNodeJssdk.core.SandboxEnvironment(clientId, clientSecret);
}

const client = () => new checkoutNodeJssdk.core.PayPalHttpClient(environment());

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'èªè¨¼ãŒå¿…è¦ã§ã™' }, { status: 401 });
    }

    const userId = parseInt(session.user.id, 10);
    const { planId } = await request.json();

    const POINT_PLANS: Record<string, { points: number; price: number }> = {
      plan_100: { points: 100, price: 120 },
      plan_500: { points: 500, price: 600 },
      plan_1000: { points: 1000, price: 1200 },
      plan_3000: { points: 3000, price: 3400 },
      plan_5000: { points: 5000, price: 5500 },
      plan_10000: { points: 10000, price: 10000 },
    };

    const selectedPlan = POINT_PLANS[planId];
    if (!selectedPlan) {
      return NextResponse.json({ error: 'ç„¡åŠ¹ãªãƒ—ãƒ©ãƒ³ã§ã™' }, { status: 400 });
    }

    const orderId = `paypal_${userId}_${Date.now()}`;

    // PayPalæ³¨æ–‡ä½œæˆ
    const orderRequest = new checkoutNodeJssdk.orders.OrdersCreateRequest();
    orderRequest.prefer('return=representation');
    orderRequest.requestBody({
      intent: 'CAPTURE',
      purchase_units: [
        {
          reference_id: orderId,
          description: `${selectedPlan.points}ãƒã‚¤ãƒ³ãƒˆè³¼å…¥`,
          amount: {
            currency_code: 'JPY',
            value: selectedPlan.price.toString(),
          },
        },
      ],
      application_context: {
        return_url: `${process.env.NEXTAUTH_URL}/points?status=success`,
        cancel_url: `${process.env.NEXTAUTH_URL}/points?status=cancel`,
        brand_name: 'namos-chat',
        user_action: 'PAY_NOW',
      },
    });

    const order = await client().execute(orderRequest);

    // DBã«ä¿å­˜
    await prisma.payment_transactions.create({
      data: {
        userId: userId,
        orderId: orderId,
        paymentMethod: 'paypal',
        amount: selectedPlan.price,
        pointAmount: selectedPlan.points,
        status: 'pending',
        paymentData: JSON.stringify(order.result),
      },
    });

    // æ‰¿èªURLã‚’è¿”ã™
    const approvalUrl = order.result.links?.find((link: any) => link.rel === 'approve')?.href;

    return NextResponse.json({
      success: true,
      orderId: order.result.id,
      approvalUrl: approvalUrl,
    });
  } catch (error) {
    console.error('PayPalæ³¨æ–‡ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({ error: 'æ±ºæ¸ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼' }, { status: 500 });
  }
}
```

### 2.5 PayPal æ±ºæ¸ˆç¢ºå®š API

`src/app/api/payments/paypal/capture-order/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import checkoutNodeJssdk from '@paypal/checkout-server-sdk';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/nextauth';
import prisma from '@/lib/prisma';

// (environment, client é–¢æ•°ã¯ä¸Šè¨˜ã¨åŒã˜)

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'èªè¨¼ãŒå¿…è¦ã§ã™' }, { status: 401 });
    }

    const { orderID } = await request.json();

    // PayPalæ±ºæ¸ˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    const captureRequest = new checkoutNodeJssdk.orders.OrdersCaptureRequest(orderID);
    captureRequest.requestBody({});

    const capture = await client().execute(captureRequest);

    if (capture.result.status !== 'COMPLETED') {
      return NextResponse.json({ error: 'æ±ºæ¸ˆãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“' }, { status: 400 });
    }

    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
    const paymentData = capture.result;
    const referenceId = paymentData.purchase_units[0].reference_id;

    const transaction = await prisma.payment_transactions.findUnique({
      where: { orderId: referenceId },
    });

    if (!transaction || transaction.status === 'completed') {
      return NextResponse.json({ message: 'æ—¢ã«å‡¦ç†æ¸ˆã¿' });
    }

    // ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
    await prisma.$transaction(async (tx) => {
      await tx.points.update({
        where: { user_id: transaction.userId },
        data: { paid_points: { increment: transaction.pointAmount } },
      });

      await tx.payment_transactions.update({
        where: { id: transaction.id },
        data: {
          status: 'completed',
          completedAt: new Date(),
          paymentData: JSON.stringify(paymentData),
        },
      });

      await tx.point_history.create({
        data: {
          userId: transaction.userId,
          type: 'purchase',
          amount: transaction.pointAmount,
          paymentMethod: 'paypal',
          orderId: referenceId,
          description: `PayPalæ±ºæ¸ˆ - ${transaction.pointAmount}ãƒã‚¤ãƒ³ãƒˆè³¼å…¥`,
        },
      });
    });

    return NextResponse.json({ success: true, points: transaction.pointAmount });
  } catch (error) {
    console.error('PayPalæ±ºæ¸ˆç¢ºå®šã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({ error: 'æ±ºæ¸ˆç¢ºå®šã‚¨ãƒ©ãƒ¼' }, { status: 500 });
  }
}
```

---

## ğŸ—„ï¸ 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒè¿½åŠ 

`prisma/schema.prisma` ã«è¿½åŠ :

```prisma
model payment_transactions {
  id            Int       @id @default(autoincrement())
  userId        Int       @map("user_id")
  orderId       String    @unique @map("order_id")
  paymentMethod String    @map("payment_method") // 'paypay' or 'paypal'
  amount        Int       // æ±ºæ¸ˆé‡‘é¡ï¼ˆå††ï¼‰
  pointAmount   Int       @map("point_amount") // ä»˜ä¸ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆæ•°
  status        String    @default("pending") // 'pending', 'completed', 'failed'
  paymentData   String?   @map("payment_data") @db.Text // JSONå½¢å¼ã®æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")
  
  user          users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}

model point_history {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  type          String   // 'purchase', 'consume', 'attend', 'admin'
  amount        Int      // å¤‰å‹•é‡ï¼ˆæ­£æ•°=ç²å¾—ã€è² æ•°=æ¶ˆè²»ï¼‰
  paymentMethod String?  @map("payment_method") // 'paypay', 'paypal', null
  orderId       String?  @map("order_id")
  description   String
  createdAt     DateTime @default(now()) @map("created_at")
  
  user          users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("point_history")
}
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ:

```bash
npx prisma migrate dev --name add_payment_tables
npx prisma generate
```

---

## ğŸ¨ 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Œå…¨å®Ÿè£…

`src/app/points/page.tsx` ã®å®Œå…¨ç‰ˆ:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';

const POINT_PLANS = [
  { id: 'plan_100', points: 100, price: 120, bonus: 0 },
  { id: 'plan_500', points: 500, price: 600, bonus: 0 },
  { id: 'plan_1000', points: 1000, price: 1200, bonus: 50, popular: true },
  { id: 'plan_3000', points: 3000, price: 3400, bonus: 200 },
  { id: 'plan_5000', points: 5000, price: 5500, bonus: 500 },
  { id: 'plan_10000', points: 10000, price: 10000, bonus: 1500 },
];

export default function PointPurchasePage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [selectedPlan, setSelectedPlan] = useState<string | null>(null);
  const [paymentMethod, setPaymentMethod] = useState<'paypay' | 'paypal'>('paypay');

  if (status === 'unauthenticated') {
    router.push('/login');
    return null;
  }

  const handlePurchase = async () => {
    if (!selectedPlan) {
      alert('ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    setLoading(true);

    try {
      if (paymentMethod === 'paypay') {
        // PayPayæ±ºæ¸ˆ
        const response = await fetch('/api/payments/paypay/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ planId: selectedPlan }),
        });

        const data = await response.json();
        if (data.success) {
          window.location.href = data.paymentUrl;
        } else {
          alert('æ±ºæ¸ˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } else {
        // PayPalæ±ºæ¸ˆ
        const response = await fetch('/api/payments/paypal/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ planId: selectedPlan }),
        });

        const data = await response.json();
        if (data.success) {
          window.location.href = data.approvalUrl;
        } else {
          alert('æ±ºæ¸ˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    } catch (error) {
      console.error('æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-900 text-white p-6">
      <div className="max-w-6xl mx-auto">
        <h1 className="text-3xl font-bold mb-8">ãƒã‚¤ãƒ³ãƒˆè³¼å…¥</h1>

        {/* æ±ºæ¸ˆæ–¹æ³•é¸æŠ */}
        <div className="mb-8">
          <h2 className="text-xl font-bold mb-4">æ±ºæ¸ˆæ–¹æ³•ã‚’é¸æŠ</h2>
          <div className="flex gap-4">
            <button
              onClick={() => setPaymentMethod('paypay')}
              className={`px-6 py-3 rounded-lg font-bold ${
                paymentMethod === 'paypay'
                  ? 'bg-red-600 text-white'
                  : 'bg-gray-700 text-gray-300'
              }`}
            >
              PayPay ï¼ˆæ¨å¥¨ï¼‰
            </button>
            <button
              onClick={() => setPaymentMethod('paypal')}
              className={`px-6 py-3 rounded-lg font-bold ${
                paymentMethod === 'paypal'
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-700 text-gray-300'
              }`}
            >
              PayPal
            </button>
          </div>
        </div>

        {/* ãƒ—ãƒ©ãƒ³é¸æŠ */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {POINT_PLANS.map((plan) => (
            <div
              key={plan.id}
              onClick={() => setSelectedPlan(plan.id)}
              className={`relative p-6 rounded-lg border-2 cursor-pointer transition ${
                selectedPlan === plan.id
                  ? 'border-blue-500 bg-blue-900'
                  : 'border-gray-600 bg-gray-800 hover:border-gray-500'
              } ${plan.popular ? 'ring-2 ring-yellow-400' : ''}`}
            >
              {plan.popular && (
                <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-black px-4 py-1 rounded-full text-sm font-bold">
                  äººæ°—
                </div>
              )}
              <div className="text-center">
                <div className="text-3xl font-bold mb-2">{plan.points}P</div>
                {plan.bonus > 0 && (
                  <div className="text-yellow-400 text-sm mb-2">+{plan.bonus}P ãƒœãƒ¼ãƒŠã‚¹!</div>
                )}
                <div className="text-2xl font-bold">Â¥{plan.price}</div>
                <div className="text-gray-400 text-sm mt-2">
                  ({(plan.price / plan.points).toFixed(2)}å††/P)
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* è³¼å…¥ãƒœã‚¿ãƒ³ */}
        <div className="mt-8 text-center">
          <button
            onClick={handlePurchase}
            disabled={!selectedPlan || loading}
            className={`px-8 py-4 rounded-lg font-bold text-lg ${
              !selectedPlan || loading
                ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                : paymentMethod === 'paypay'
                ? 'bg-red-600 hover:bg-red-700'
                : 'bg-blue-600 hover:bg-blue-700'
            }`}
          >
            {loading ? 'å‡¦ç†ä¸­...' : `${paymentMethod === 'paypay' ? 'PayPay' : 'PayPal'}ã§è³¼å…¥`}
          </button>
        </div>
      </div>
    </div>
  );
}
```

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### PayPayï¼ˆç”³è«‹ãƒ—ãƒ­ã‚»ã‚¹ï¼‰
- [ ] äº‹æ¥­è€…ç™»éŒ²ï¼ˆæ³•äººã¾ãŸã¯å€‹äººäº‹æ¥­ä¸»ï¼‰
- [ ] éŠ€è¡Œå£åº§é–‹è¨­ï¼ˆæ³•äººåç¾©ã¾ãŸã¯å€‹äººäº‹æ¥­ä¸»åç¾©ï¼‰
- [ ] ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆæº–å‚™ï¼ˆæœ€ä½é™ã®ãƒšãƒ¼ã‚¸ï¼‰
- [ ] PayPay for Business ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- [ ] äº‹æ¥­è€…æƒ…å ±ç™»éŒ²ãƒ»æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- [ ] éŠ€è¡Œå£åº§ç™»éŒ²ãƒ»ç¢ºèª
- [ ] å¯©æŸ»é€šéï¼ˆ2ã€œ4é€±é–“ï¼‰
- [ ] API ã‚­ãƒ¼å–å¾—
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] `@paypay/paypayopa` ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] æ±ºæ¸ˆä½œæˆ API å®Ÿè£…
- [ ] Webhook API å®Ÿè£…
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
- [ ] ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ1ã€œ2é€±é–“ï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒç”³è«‹ï¼ˆ1é€±é–“ï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒé–‹å§‹

**åˆè¨ˆæœŸé–“: ç´„2ã€œ3ãƒ¶æœˆ**

### PayPalï¼ˆç”³è«‹ãƒ—ãƒ­ã‚»ã‚¹ï¼‰
- [ ] PayPal Business ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
- [ ] ãƒ“ã‚¸ãƒã‚¹æƒ…å ±ç™»éŒ²
- [ ] æœ¬äººç¢ºèªæ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- [ ] éŠ€è¡Œå£åº§ç™»éŒ²ãƒ»ç¢ºèª
- [ ] å¯©æŸ»é€šéï¼ˆ1ã€œ2é€±é–“ï¼‰
- [ ] REST API ã‚­ãƒ¼å–å¾—ï¼ˆDeveloper Portalï¼‰
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] `@paypal/checkout-server-sdk` ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] æ³¨æ–‡ä½œæˆ API å®Ÿè£…
- [ ] æ±ºæ¸ˆç¢ºå®š API å®Ÿè£…
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
- [ ] ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆ1é€±é–“ï¼‰
- [ ] æœ¬ç•ªç’°å¢ƒç”³è«‹
- [ ] æœ¬ç•ªç’°å¢ƒé–‹å§‹

**åˆè¨ˆæœŸé–“: ç´„1ã€œ2ãƒ¶æœˆ**

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- [ ] `payment_transactions` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] `point_history` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **äºŒé‡æ±ºæ¸ˆé˜²æ­¢**: `orderId` ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„
2. **é‡‘é¡æ¤œè¨¼**: ã‚µãƒ¼ãƒãƒ¼å´ã§å¿…ãšé‡‘é¡ã‚’å†è¨ˆç®—
3. **Webhookèªè¨¼**: PayPay/PayPalã®ç½²åæ¤œè¨¼
4. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**: ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã¯å¿…ãšDBãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
5. **ç’°å¢ƒå¤‰æ•°**: æœ¬ç•ªAPIã‚­ãƒ¼ã¯çµ¶å¯¾ã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### PayPay
- **ã‚µãƒãƒ¼ãƒˆ**: https://paypay.ne.jp/business/support/
- **é›»è©±**: 0120-628-628ï¼ˆå¹³æ—¥ 9:00ã€œ18:00ï¼‰
- **ãƒ¡ãƒ¼ãƒ«**: business-support@paypay.ne.jp

### PayPal
- **ã‚µãƒãƒ¼ãƒˆ**: https://www.paypal.com/jp/smarthelp/home
- **é›»è©±**: 0120-271-888ï¼ˆ24æ™‚é–“å¯¾å¿œï¼‰
- **ãƒ¡ãƒ¼ãƒ«**: ã‚µãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã‹ã‚‰å•ã„åˆã‚ã›

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **è©³ç´°ãªç”³è«‹ãƒ—ãƒ­ã‚»ã‚¹**: `PAYMENT_APPLICATION_PROCESS.md` ã‚’å‚ç…§
  - ç”³è«‹ã«å¿…è¦ãªæ›¸é¡ä¸€è¦§
  - å¯©æŸ»ãƒ—ãƒ­ã‚»ã‚¹ã®è©³ç´°
  - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆç›®å®‰ï¼‰
  - ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

---

## â° å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ¨å¥¨ï¼‰

### é–‹ç™ºé–‹å§‹2ã€œ3ãƒ¶æœˆå‰
1. **äº‹æ¥­è€…ç™»éŒ²**ï¼ˆæ³•äººè¨­ç«‹ã¾ãŸã¯å€‹äººäº‹æ¥­ä¸»é–‹æ¥­å±Šï¼‰
2. **éŠ€è¡Œå£åº§é–‹è¨­**
3. **ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆæº–å‚™**ï¼ˆæœ€ä½é™ã®ãƒšãƒ¼ã‚¸ï¼‰

### é–‹ç™ºé–‹å§‹1ãƒ¶æœˆå‰
1. **PayPayç”³è«‹é–‹å§‹**ï¼ˆå¯©æŸ»æœŸé–“2ã€œ4é€±é–“ï¼‰
2. **PayPalç”³è«‹é–‹å§‹**ï¼ˆå¯©æŸ»æœŸé–“1ã€œ2é€±é–“ã€ä¸¦è¡Œç”³è«‹å¯èƒ½ï¼‰

### é–‹ç™ºä¸­
1. **ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç’°å¢ƒã§é–‹ç™º**ï¼ˆæ‰¿èªå‰ã§ã‚‚é–‹ç™ºå¯èƒ½ï¼‰
2. **ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å‹•ä½œç¢ºèª**

### ãƒªãƒªãƒ¼ã‚¹ç›´å‰
1. **æœ¬ç•ªç’°å¢ƒç”³è«‹**
2. **æœ€çµ‚ãƒ†ã‚¹ãƒˆ**
3. **æœ¬ç•ªç’°å¢ƒé–‹å§‹**



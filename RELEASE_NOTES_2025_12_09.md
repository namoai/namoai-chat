# 📋 リリースノート - 2025年12月9日

## 🎯 概要

本リリースでは、2024年12月4日（コミット `24254cb`）以降の主要な変更点をまとめています。主な機能追加として、Stripe決済システムの統合、管理者パネルでのユーザー年齢管理機能、および環境変数ローディングシステムの改善が含まれています。

---

## ✨ 新機能

### 💳 Stripe決済システム統合

**ポイント購入機能**
- Stripe Checkoutを使用した安全な決済システムを実装
- 4つのポイントパッケージを提供：
  - 100ポイント: ¥1,100
  - 250ポイント: ¥2,200
  - 700ポイント: ¥5,500
  - 1,500ポイント: ¥11,000
- 決済成功後の自動ポイント付与
- 決済セッション検証機能

**Webhook処理**
- Stripe Webhookによる決済完了の自動検証
- 決済ステータスの自動更新
- エラーハンドリングの改善

**テスト決済について**
⚠️ **重要**: テスト環境での決済テストには、以下のテスト用カード番号を使用してください：
- **カード番号**: `4242 4242 4242 4242`
- **有効期限**: 任意の未来の日付
- **CVC**: 任意の3桁の数字
- **郵便番号**: 任意の数字

このカード番号はStripeのテストモード専用で、実際の決済は発生しません。

---

### 👥 管理者パネル - ユーザー年齢管理機能

**生年月日・年齢管理**
- 管理者がユーザーの生年月日を直接編集可能
- 18歳未満フラグの手動設定機能
- 生年月日から自動的に年齢を計算
- ユーザー編集モーダルに生年月日入力フィールドを追加

**機能詳細**
- 生年月日フィールド: 日付選択UIで直接編集可能
- 「18歳未満として扱う」チェックボックス: 手動で未成年ステータスを設定可能
- 自動計算: 生年月日から18歳未満かどうかを自動判定

---

### 🔓 決済制限の緩和

**全ユーザーがポイント購入可能に**
- 以前は18歳未満のアカウントではポイント購入が制限されていましたが、本リリースより全ユーザーがポイントを購入できるようになりました
- 決済には親権者（法定代理人）の同意が必要である旨の注意書きを表示

---

## 🔧 技術的改善

### 🔐 環境変数ローディングシステム

**AWS Systems Manager Parameter Store統合**
- Lambda環境での環境変数自動ローディング機能を復元
- 12月4日の動作していた設定に戻しました
- 以下の環境変数が自動的にロードされます：
  - `STRIPE_SECRET_KEY` (必須)
  - `STRIPE_WEBHOOK_SECRET` (必須)
  - `NEXT_PUBLIC_APP_URL` (オプション)
  - その他の認証・データベース関連変数

**改善点**
- `.env.production.local`ファイルからの環境変数読み込み
- AWS SSM Parameter Storeからの動的ローディング
- 複数のパスでの環境変数ファイル検索
- エラーハンドリングとリトライ機能の改善

---

### 🏗️ ビルド・デプロイ改善

**Next.js Standaloneモード対応**
- `output: 'standalone'`モードを有効化
- AWS Amplifyデプロイメントとの互換性向上
- ビルドアーティファクトの最適化

**Webpack設定の最適化**
- サーバーサイドバンドリングの問題を解決
- Node.js組み込みモジュールの適切な外部化
- ビルドエラーの解消

---

## 🐛 バグ修正

### データベース接続
- ランタイム環境変数ローディングの問題を修正
- Lambda環境でのデータベース接続エラーを解消

### 型安全性の改善
- TypeScriptの型エラーを修正
- Prismaスキーマとの整合性を確保
- `dateOfBirth`フィールドの正しい使用

---

## 📊 変更されたファイル

### 新規追加
- `src/app/api/stripe/create-checkout-session/route.ts` - Stripe決済セッション作成API
- `src/app/api/stripe/webhook/route.ts` - Stripe Webhook処理API
- `src/app/api/stripe/verify-session/route.ts` - 決済セッション検証API

### 主要変更
- `src/app/points/page.tsx` - ポイント購入ページ（決済機能統合）
- `src/app/admin/users/page.tsx` - 管理者パネル（年齢管理機能追加）
- `src/app/api/admin/users/edit/route.ts` - ユーザー編集API（生年月日対応）
- `src/lib/load-env-vars.ts` - 環境変数ローディング（Stripe変数追加）
- `next.config.ts` - Standaloneモード有効化
- `amplify.yml` - ビルド設定の最適化

---

## ⚠️ 重要な注意事項

### 環境変数の設定
以下の環境変数がAWS AmplifyコンソールまたはSSM Parameter Storeに設定されていることを確認してください：

**必須環境変数:**
- `STRIPE_SECRET_KEY` - Stripe API秘密鍵
- `STRIPE_WEBHOOK_SECRET` - Stripe Webhook署名検証用シークレット
- `DATABASE_URL` - PostgreSQLデータベース接続URL
- `NEXTAUTH_SECRET` - NextAuthセッション暗号化キー

**オプション環境変数:**
- `NEXT_PUBLIC_APP_URL` - アプリケーションURL（未設定の場合はリクエストヘッダーから自動検出）

### データベースマイグレーション
本リリースではデータベーススキーマの変更はありませんが、既存のユーザーデータに生年月日情報がない場合は、管理者パネルから手動で設定する必要があります。

---

## 🚀 デプロイ手順

1. 最新のコードをプル
   ```bash
   git pull origin main
   ```

2. 依存関係のインストール
   ```bash
   npm ci
   ```

3. 環境変数の確認
   - AWS Amplifyコンソールで環境変数が正しく設定されているか確認
   - SSM Parameter Storeに必要な変数が登録されているか確認

4. ビルドとデプロイ
   - AWS Amplifyが自動的にビルドとデプロイを実行します

---

## 📝 既知の問題

現在、既知の問題はありません。問題が発生した場合は、GitHubのIssuesまたは管理者にお知らせください。

---

## 🙏 謝辞

本リリースの実装にあたり、ご協力いただいた皆様に感謝申し上げます。

---

**リリース日**: 2025年12月9日  
**ベースコミット**: `24254cb` (2024年12月4日)  
**現在のコミット**: `19ae61e`


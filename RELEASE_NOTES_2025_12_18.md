# リリースノート — 2025-12-18

## ハイライト
- CloudFront / プロキシヘッダーを用いた判定を強化し、管理画面のIP監視を改善（公開IPと内部IPの集計をより分かりやすく表示）。
- ページ/APIアクセスのログ保存（ベストエフォート）を拡張し、管理ツール上でユーザー単位のIP確認を可能に。
- プロフィール/ユーザー画像のフィールドマッピング（`users.image`）を修正しつつ、互換性のため `image_url` も返すように整備。
- Amplifyビルドの安定化：サーバー専用の環境変数ロードを強化し、未対応の `NextRequest.ip` 参照を排除。

## 変更内容
### 管理 / セキュリティ
- CDN/プロキシヘッダー（例：`x-forwarded-for`、`cloudfront-viewer-address`）から解決したクライアントIPをログ/表示。
- 管理ページおよび非APIのページ遷移についてもアクセスログを保存。
- セッションから取得できる場合、アクセスログに `userId` を併記してユーザーIP検索を可能に。
- 管理者IP監視のユーザー検索フローに、ユーザーIP統計と最近のアクセスログ表示を追加。
- メール認証フローの復旧、管理者アクセス制御の堅牢化（IP許可リスト、照合ロジック等）。
- 2FA関連・認証周りの型/実装整合（ビルド・運用時の安定化）。

### ビルド / インフラ
- Node組み込み（`fs`、`path`）のバンドル問題を回避し、ビルド時の `node:` スキームimportを避けるよう調整。
- SSMから必須環境変数をロードすることを強制し、欠落時は早期に失敗するように修正。
- Amplify(Lambda)環境での環境変数ロードの信頼性改善（リトライ/分岐、ログ整備）。

### API / データ
- Prismaのselectを `users.image`（DBカラムのマップ先）に修正し、互換性のためレスポンスに `image_url` も含めるよう正規化。
- APIのリクエスト/レスポンス型を整合（例：`complete-profile` に `name` を含む）。
- プロフィール/通知/コメント等のAPIで画像フィールドの不整合を解消（フロント互換のため `image_url` を維持）。

## 注記
- アクセスログはベストエフォートです。ランタイム挙動によっては、内部のサーバーサイドfetchがループバック/プライベートIPとして記録される場合があります。

## 12/18 の主なコミット（抜粋）
- ビルド修正：`load-env-vars` の Node 組み込み import 回避、SSM強制ロード、型/ESLint修正
- 認証/セキュリティ：メール認証フロー復旧、管理者アクセス制御の堅牢化、`NextRequest.ip` 参照の排除
- IP監視：IPヘッダーデバッグ/生ログ表示、公開IP/内部IPの分離、ユーザー単位のIP検索対応
- アクセスログ：ページ遷移をクライアントから `/api/log-access` に送信して確実に記録（CloudFront IP + userId を保存）

## 参考：直近リリースで含まれることが多い関連変更（過去コミット由来）
> ※下記は「12/18前後の配布で一緒に入った」として話題に上がりやすい変更です。実際の導入日はコミット履歴に依存します。

### 決済（Stripe）/ セキュリティ
- Stripe/NextAuthのビルドブロッカー解消、Webhook/セッション検証周りの整備（例：`73db4a8`）
- Stripe必須環境変数の追加（`STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` 等：`d2c9bc5`, `f6aabaf`）
- SQLインジェクション対策および不要なデバッグログ除去（`4bddc1f`）
- 画像アップロードAPIの入力検証強化（`43723ad`）

### 認証/登録フロー
- Google OAuth セッション処理・プロフィール遷移の修正（`e6797ca`）
- パスワードポリシー/クライアント側バリデーションの整合（`c3fe359`, `3f3c4f0`）

### セーフティ/コンテンツフィルタ
- セーフティフィルタの挙動改善（null取り扱い、キャッシュ回避、UI改善、チャット/管理画面の適用拡大など：`ac6d18e`, `a77c99e`）

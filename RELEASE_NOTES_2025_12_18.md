# リリースノート — 2025-12-18

## ハイライト
- CloudFront / プロキシヘッダーを用いた判定を強化し、管理画面のIP監視を改善（公開IPと内部IPの集計をより分かりやすく表示）。
- ページ/APIアクセスのログ保存（ベストエフォート）を拡張し、管理ツール上でユーザー単位のIP確認を可能に。
- プロフィール/ユーザー画像のフィールドマッピング（`users.image`）を修正しつつ、互換性のため `image_url` も返すように整備。
- Amplifyビルドの安定化：サーバー専用の環境変数ロードを強化し、未対応の `NextRequest.ip` 参照を排除。

## 変更内容
### 管理 / セキュリティ
- CDN/プロキシヘッダー（例：`x-forwarded-for`、`cloudfront-viewer-address`）から解決したクライアントIPをログ/表示。
- 管理ページおよび非APIのページ遷移についてもアクセスログを保存。
- セッションから取得できる場合、アクセスログに `userId` を併記してユーザーIP検索を可能に。
- 管理者IP監視のユーザー検索フローに、ユーザーIP統計と最近のアクセスログ表示を追加。

### ビルド / インフラ
- Node組み込み（`fs`、`path`）のバンドル問題を回避し、ビルド時の `node:` スキームimportを避けるよう調整。
- SSMから必須環境変数をロードすることを強制し、欠落時は早期に失敗するように修正。

### API / データ
- Prismaのselectを `users.image`（DBカラムのマップ先）に修正し、互換性のためレスポンスに `image_url` も含めるよう正規化。
- APIのリクエスト/レスポンス型を整合（例：`complete-profile` に `name` を含む）。

## 注記
- アクセスログはベストエフォートです。ランタイム挙動によっては、内部のサーバーサイドfetchがループバック/プライベートIPとして記録される場合があります。

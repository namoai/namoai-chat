# 🔒 セキュリティチェックリストおよび実装ガイド

## ✅ 既に実装済みのセキュリティ対策

### 1. 認証・認可
- ✅ NextAuthによるセッションベース認証
- ✅ bcrypt（saltRounds: 10）によるパスワードハッシュ
- ✅ RBAC（ロールベースアクセス制御）
- ✅ セッションタイムアウト（30分間の非操作で自動ログアウト）
- ✅ ログイン状態保持オプション

### 2. データベースセキュリティ
- ✅ Prisma ORM（SQLインジェクション対策）
- ✅ トランザクション管理
- ✅ 入力値バリデーション（一部）

### 3. コンテンツフィルタリング
- ✅ セーフティフィルター機能
- ✅ アダルトコンテンツキーワードフィルタリング

---

## ⚠️ 今後実装が必要な項目

### 🔴 高優先度（即時対応推奨）

#### 1. Rate Limiting（APIリクエスト制限）
**目的**: DDoS攻撃・総当たり攻撃の防止

**実装ヒント**:
```typescript
// src/lib/rate-limit.ts を新規作成
// - IPベースのリクエスト制限
// - ユーザー単位のリクエスト制限
// - Redis またはインメモリカウンターを利用
```

**チェックリスト**:
- [ ] ログインAPI: 15分に5回まで
- [ ] 会員登録API: 1時間に3回まで
- [ ] チャットAPI: 1分に100回まで
- [ ] その他API: 1時間に1000回まで
- ✅ Upstash Redis 기반の共通レートリミッター (`src/lib/rateLimit.ts`) を実装
- ✅ `/api/register` に IP 単位 (1時間3回) 制限を適用
- ✅ `/api/chat/messages` に ユーザー単位 (1分60回) 制限を適用

#### 2. 入力値バリデーション & サニタイズ
**目的**: XSS / SQL Injection / コマンドインジェクションの防止

**実装ヒント**:
```typescript
// - zod / joi などでスキーマバリデーション
// - DOMPurify 等でHTMLをサニタイズ
// - 正規表現で危険文字列をフィルタ
```

**チェックリスト**:
- [ ] 全入力項目の検証
- [ ] HTMLタグの除去 / エスケープ
- [ ] ファイル名のサニタイズ強化
- [ ] JSONパース時のエラーハンドリング

#### 3. ファイルアップロードの強化
**目的**: 悪意あるファイルのアップロード防止

**チェックリスト**:
- ✅ MIMEタイプ + 拡張子の二重チェック（`validateImageFile`で署名検査 + allowed list）
- ✅ ファイルサイズ制限（キャラクター画像/5MB、アバター/3MB）
- ✅ マジックナンバーによる実体検証（PNG/JPEG/WebP/GIFを判定）
- ✅ ファイル名のサニタイズ（UUID付き安全ファイル名を自動生成）
- [ ] 画像のリサイズ・最適化
- [ ] ウイルススキャン（任意）

#### 4. セキュリティヘッダー設定
**目的**: XSS / Clickjacking / MIMEスニッフィング対策

**実装ヒント**:
```typescript
// middleware.ts または next.config.ts で一括設定
```

**チェックリスト**:
- ✅ Content-Security-Policy (CSP) — `next.config.ts`で `default-src 'self'` などを強制
- ✅ X-Frame-Options: DENY
- ✅ X-Content-Type-Options: nosniff
- ✅ Strict-Transport-Security (HSTS)
- ✅ Referrer-Policy: strict-origin-when-cross-origin
- ✅ Permissions-Policy: 高リスク機能を全面禁止

#### 5. CORS設定
**目的**: 不正ドメインからのAPIアクセス遮断

**チェックリスト**:
- ✅ 許可ドメインのホワイトリスト化（`CORS_ALLOWED_ORIGINS` + ローカル/Netlifyデフォルト）
- ✅ Credentialsの扱いを明示（`Access-Control-Allow-Credentials: true`）
- ✅ OPTIONSリクエストの正しい応答（`middleware.ts`で204/403をハンドリング）

---

### 🟡 中優先度（1〜2週間以内）

#### 6. ログ収集と監視
**目的**: セキュリティイベントの追跡・異常検知

**チェックリスト**:
- [ ] ログイン失敗の記録
- [ ] 不審な行動パターンのログ
- [ ] APIエラーの集計
- [ ] セキュリティイベントの通知仕組み

#### 7. CSRF対策の強化
**目的**: Cross-Site Request Forgery の防止

**チェックリスト**:
- [ ] NextAuthのCSRFトークン確認
- [ ] APIリクエストでのCSRFトークン検証
- [ ] SameSite属性の再確認

#### 8. 環境変数の安全管理
**目的**: 機密情報の漏えい防止

**チェックリスト**:
- [ ] `.env` ファイルの `.gitignore` 登録確認
- [ ] 値の整合性・必須チェック
- [ ] 強力なパスワードポリシー
- [ ] APIキーのローテーションポリシー

#### 9. セッションセキュリティ
**目的**: セッションハイジャック対策

**チェックリスト**:
- [ ] セッション固定攻撃の防止
- [ ] IPアドレスの急な変化検出
- [ ] User-Agentの変化検出
- [ ] 同時ログイン数の制限

#### 10. エラーハンドリング改善
**目的**: 情報漏えいの抑止

**チェックリスト**:
- [ ] 本番で詳細なエラーメッセージを非表示
- [ ] スタックトレースを隠す
- [ ] ユーザー向けメッセージは汎用文に統一

---

### 🟢 低優先度（長期計画）

#### 11. 2段階認証（2FA）
**目的**: アカウント乗っ取りリスクの低減

**チェックリスト**:
- [ ] TOTP方式（例: Google Authenticator）
- [ ] SMS認証（任意）
- [ ] バックアップコード発行

#### 12. パスワードポリシー強化
**目的**: 脆弱なパスワードの排除

**チェックリスト**:
- [ ] 最小文字数: 8文字
- [ ] 文字種の複雑性（大小英字・数字・記号）
- [ ] 既知の弱いパスワードとの照合
- [ ] パスワード再利用の禁止

#### 13. API認証の強化
**目的**: 無権限アクセスの封じ込め

**チェックリスト**:
- [ ] APIキーによる認証（必要に応じて）
- [ ] JWTの有効期限短縮
- [ ] リフレッシュトークンの更新制御

#### 14. データ暗号化
**目的**: 機微情報の保護

**チェックリスト**:
- [ ] 伝送経路の暗号化（HTTPS）
- [ ] 保存時の暗号化（必要に応じて）
- [ ] 個人情報カラムの暗号化

#### 15. セキュリティ監査
**目的**: 定期的な脆弱性診断

**チェックリスト**:
- [ ] 依存パッケージの脆弱性スキャン
- [ ] 定期的なセキュリティレビュー
- [ ] ペネトレーションテスト
- [ ] コードレビュー体制

---

## 🛠️ 実装優先度サマリー

### 今週中に対応
1. ✅ Rate Limiting
2. ✅ 入力値バリデーション & サニタイズ
3. ✅ ファイルアップロードの強化
4. ✅ セキュリティヘッダー

### 1〜2週間で対応
5. ✅ ログ & モニタリング
6. ✅ CORS設定
7. ✅ エラーハンドリング改善

### 1〜3か月内の計画
8. ✅ 2段階認証
9. ✅ パスワードポリシー強化
10. ✅ セキュリティ監査体制

---

## 📚 参考資料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Next.js Security Best Practices](https://nextjs.org/docs/app/building-your-application/configuring/security-headers)
- [NextAuth Security](https://next-auth.js.org/configuration/options#security)

---

**作成日**: 2025-01-27  
**最終更新日**: 2025-01-27  
**バージョン**: 1.0


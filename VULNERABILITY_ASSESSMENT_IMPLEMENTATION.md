# ğŸ”’ è„†å¼±æ€§è©•ä¾¡ã¨ä¾µå…¥ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ æ¦‚è¦

"è„†å¼±æ€§è©•ä¾¡ã¨ä¾µå…¥ãƒ†ã‚¹ãƒˆã‚’å®šæœŸçš„ã«å®Ÿè¡Œ"ã¯ã€ä»¥ä¸‹ã®2ã¤ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¾ã™ï¼š

1. **è‡ªå‹•åŒ–å¯èƒ½ãªæ©Ÿèƒ½**ï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
   - ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆnpm auditï¼‰
   - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®çµ±åˆ
   - è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

2. **æ‰‹å‹•ã§å®Ÿæ–½ã™ã‚‹ãƒ†ã‚¹ãƒˆ**ï¼ˆãƒ—ãƒ­ã‚»ã‚¹è¨­å®šï¼‰
   - ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
   - å®Ÿéš›ã®æ”»æ’ƒã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

---

## âœ… ç¾åœ¨å®Ÿè£…æ¸ˆã¿

### 1. æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸**: `/admin/security-test`
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ãƒ†ã‚¹ãƒˆ
  - XSS/HTMLã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
  - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
  - Rate Limitingãƒ†ã‚¹ãƒˆ
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆAPI
- `/api/security-tests/sanitize` - XSSå¯¾ç­–ãƒ†ã‚¹ãƒˆ
- `/api/security-tests/upload` - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¤œè¨¼ãƒ†ã‚¹ãƒˆ
- `/api/security-tests/rate-limit` - Rate Limitingãƒ†ã‚¹ãƒˆ

---

## ğŸ”§ å®Ÿè£…ãŒå¿…è¦ãªæ©Ÿèƒ½

### 1. npm auditã®å®šæœŸå®Ÿè¡Œï¼ˆè‡ªå‹•åŒ–ï¼‰

**ç›®çš„**: ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’è‡ªå‹•æ¤œå‡º

**å®Ÿè£…æ–¹æ³•**:
- `package.json`ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ 
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ±åˆï¼ˆGitHub Actionsæ¨å¥¨ï¼‰

**å®Ÿè£…å†…å®¹**:

#### package.json ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ 

```json
{
  "scripts": {
    "security:audit": "npm audit",
    "security:audit:fix": "npm audit fix",
    "security:audit:json": "npm audit --json > security-audit-report.json"
  }
}
```

#### GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ`.github/workflows/security-audit.yml`ï¼‰

```yaml
name: Security Audit

on:
  schedule:
    - cron: '0 0 * * 1' # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰0æ™‚
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
        id: audit
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: |
            security-audit-report.json
            npm-debug.log
      
      - name: Comment PR with audit results
        if: github.event_name == 'pull_request' && steps.audit.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ npm audit found security vulnerabilities. Please review the audit report.'
            })
```

---

### 2. å®šæœŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**ç›®çš„**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã‚’å®šæœŸçš„ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆ

**å®Ÿè£…å†…å®¹**:

#### `scripts/security-test-runner.mjs`

```javascript
#!/usr/bin/env node

/**
 * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * å®Ÿè¡Œ: npm run security:test
 */

import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';

const BASE_URL = process.env.SECURITY_TEST_BASE_URL || 'http://localhost:3000';
const ADMIN_EMAIL = process.env.ADMIN_EMAIL;
const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD;

const tests = [
  {
    name: 'XSS Protection Test',
    endpoint: '/api/security-tests/sanitize',
    method: 'POST',
    body: { input: '<script>alert("XSS")</script>' },
    expected: (result) => !result.sanitized.includes('<script>'),
  },
  {
    name: 'Rate Limiting Test',
    endpoint: '/api/security-tests/rate-limit',
    method: 'POST',
    expected: (result) => result.success !== undefined,
  },
];

async function runSecurityTests() {
  console.log('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...\n');
  
  const results = [];
  
  for (const test of tests) {
    try {
      console.log(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­: ${test.name}...`);
      
      // å®Ÿéš›ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå®Ÿè£…ãŒå¿…è¦ï¼‰
      const response = await fetch(`${BASE_URL}${test.endpoint}`, {
        method: test.method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: test.body ? JSON.stringify(test.body) : undefined,
      });
      
      const data = await response.json();
      const passed = test.expected ? test.expected(data) : response.ok;
      
      results.push({
        name: test.name,
        passed,
        status: response.status,
        data,
      });
      
      console.log(passed ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—');
    } catch (error) {
      console.log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      results.push({
        name: test.name,
        passed: false,
        error: error.message,
      });
    }
  }
  
  // çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  const report = {
    timestamp: new Date().toISOString(),
    tests: results,
    summary: {
      total: results.length,
      passed: results.filter(r => r.passed).length,
      failed: results.filter(r => !r.passed).length,
    },
  };
  
  const reportPath = path.join(process.cwd(), 'security-test-report.json');
  fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));
  
  console.log('\nğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ:');
  console.log(`  ç·æ•°: ${report.summary.total}`);
  console.log(`  æˆåŠŸ: ${report.summary.passed}`);
  console.log(`  å¤±æ•—: ${report.summary.failed}`);
  console.log(`\nãƒ¬ãƒãƒ¼ãƒˆä¿å­˜å…ˆ: ${reportPath}`);
  
  process.exit(report.summary.failed > 0 ? 1 : 0);
}

runSecurityTests().catch(console.error);
```

#### package.json ã«è¿½åŠ 

```json
{
  "scripts": {
    "security:test": "node scripts/security-test-runner.mjs"
  }
}
```

---

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰API

**ç›®çš„**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ…‹ã‚’ç›£è¦–ãƒ»è¨˜éŒ²

**å®Ÿè£…å†…å®¹**:

#### `src/app/api/admin/security-status/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { authOptions } from '@/lib/nextauth';
import { Role } from '@prisma/client';
import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';

export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (session?.user?.role !== Role.SUPER_ADMIN) {
      return NextResponse.json({ error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' }, { status: 403 });
    }

    // npm auditçµæœã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆï¼‰
    let auditResult = null;
    const auditReportPath = path.join(process.cwd(), 'security-audit-report.json');
    if (fs.existsSync(auditReportPath)) {
      try {
        auditResult = JSON.parse(fs.readFileSync(auditReportPath, 'utf-8'));
      } catch {
        // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
      }
    }

    // æœ€å¾Œã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœã‚’å–å¾—
    let testResult = null;
    const testReportPath = path.join(process.cwd(), 'security-test-report.json');
    if (fs.existsSync(testReportPath)) {
      try {
        testResult = JSON.parse(fs.readFileSync(testReportPath, 'utf-8'));
      } catch {
        // ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
      }
    }

    return NextResponse.json({
      audit: auditResult,
      tests: testResult,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error('[Security Status] ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚' },
      { status: 500 }
    );
  }
}
```

---

## ğŸ“ æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ï¼ˆãƒ—ãƒ­ã‚»ã‚¹è¨­å®šï¼‰

### å®šæœŸçš„ãªãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

**å®Ÿæ–½é »åº¦**: å››åŠæœŸã”ã¨ï¼ˆ3ãƒ¶æœˆã«1å›ï¼‰

**ãƒ†ã‚¹ãƒˆé …ç›®**:
1. **SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒ**
   - æ¤œç´¢æ©Ÿèƒ½ã§ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è©¦è¡Œ
   - ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã§ã®SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è©¦è¡Œ

2. **XSSæ”»æ’ƒ**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æ¬„ã§ã®XSSè©¦è¡Œ
   - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã®XSSè©¦è¡Œ

3. **èªè¨¼ãƒã‚¤ãƒ‘ã‚¹**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¸ãƒ£ãƒƒã‚¯è©¦è¡Œ
   - èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸æ­£ä½¿ç”¨è©¦è¡Œ

4. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ”»æ’ƒ**
   - æ‚ªæ„ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è©¦è¡Œ
   - ãƒ•ã‚¡ã‚¤ãƒ«åã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è©¦è¡Œ

5. **CSRFæ”»æ’ƒ**
   - ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ã‚©ãƒ¼ã‚¸ã‚§ãƒªè©¦è¡Œ

**ãƒ†ã‚¹ãƒˆçµæœè¨˜éŒ²**:
- ãƒ†ã‚¹ãƒˆæ—¥æ™‚
- ãƒ†ã‚¹ãƒˆé …ç›®
- çµæœï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰
- ç™ºè¦‹ã•ã‚ŒãŸè„†å¼±æ€§
- ä¿®æ­£å¯¾å¿œ

---

## ğŸš€ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

### Step 1: npm auditã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ  âœ…ï¼ˆã™ãå®Ÿè£…å¯èƒ½ï¼‰

```bash
# package.jsonã«è¿½åŠ 
npm pkg set scripts.security:audit="npm audit"
npm pkg set scripts.security:audit:fix="npm audit fix"
```

### Step 2: GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä½œæˆï¼ˆ.github/workflows/security-audit.ymlï¼‰

### Step 3: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆï¼ˆscripts/security-test-runner.mjsï¼‰

### Step 4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹APIä½œæˆï¼ˆsrc/app/api/admin/security-status/route.tsï¼‰

### Step 5: æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹æ–‡æ›¸åŒ–ï¼ˆã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰

---

## ğŸ“Š ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¦ä»¶ã¸ã®å¯¾å¿œ

### âœ… å®Ÿè£…å¯èƒ½ãªæ©Ÿèƒ½
- [x] npm auditã®å®šæœŸå®Ÿè¡Œ â†’ **GitHub Actionsã§è‡ªå‹•åŒ–**
- [x] ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³è‡ªå‹•åŒ– â†’ **GitHub Actionsã§è‡ªå‹•åŒ–**
- [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆçµæœã®è¨˜éŒ²ãƒ»è¿½è·¡ â†’ **ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ**

### âš ï¸ æ‰‹å‹•å®Ÿæ–½ãŒå¿…è¦
- [ ] å®šæœŸçš„ãªãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ â†’ **ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦è¨­å®š**
- [ ] å®Ÿéš›ã®æ”»æ’ƒã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ â†’ **ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦è¨­å®š**

---

## ğŸ” ã¾ã¨ã‚

**"è„†å¼±æ€§è©•ä¾¡ã¨ä¾µå…¥ãƒ†ã‚¹ãƒˆã‚’å®šæœŸçš„ã«å®Ÿè¡Œ"ã¯ä»¥ä¸‹ã®çµ„ã¿åˆã‚ã›ã§å¯¾å¿œï¼š**

1. **è‡ªå‹•åŒ–ï¼ˆæ©Ÿèƒ½å®Ÿè£…ï¼‰**:
   - npm auditè‡ªå‹•å®Ÿè¡Œï¼ˆGitHub Actionsï¼‰
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
   - çµæœã®è¨˜éŒ²ãƒ»ç›£è¦–ï¼ˆAPIï¼‰

2. **æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆãƒ—ãƒ­ã‚»ã‚¹è¨­å®šï¼‰**:
   - ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼ˆå››åŠæœŸã”ã¨ï¼‰
   - å®Ÿéš›ã®æ”»æ’ƒã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

**è¦ä»¶ã‚’æº€ãŸã™ã«ã¯**:
- è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£… âœ…ï¼ˆæ©Ÿèƒ½ã¨ã—ã¦å®Ÿè£…ï¼‰
- æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã‚’æ–‡æ›¸åŒ–ãƒ»è¨­å®š âœ…ï¼ˆãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦è¨­å®šï¼‰


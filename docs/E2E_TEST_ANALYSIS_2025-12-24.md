# E2E 테스트 결과 분석 (2025-12-24)

## 테스트 실행 요약

- **총 테스트 수**: 87개
- **성공**: 약 30개 (관리자 테스트 대부분)
- **실패**: 약 20개 (주로 사용자 테스트)
- **스킵**: 약 5개

---

## 주요 문제점

### 1. 로그아웃 함수 타임아웃 ⚠️ (테스트 코드 문제)

**문제**: `logout` 함수에서 `waitForURL` 타임아웃이 5초로 설정되어 있어, 로그아웃 후 리다이렉트가 느릴 경우 타임아웃 발생

**에러 메시지**:
```
TimeoutError: page.waitForURL: Timeout 5000ms exceeded.
at logout (e2e/helpers/auth.ts:428:16)
```

**영향받는 테스트**:
- `auth.spec.ts` - 모든 테스트의 `afterEach` 훅
- 계정 잠금 해제 후 로그아웃 시도 시 실패

**해결 방법**: 타임아웃을 늘리거나 더 유연한 대기 로직 추가

---

### 2. CSRF 토큰 에러 ⚠️ (테스트 코드 문제)

**문제**: 계정 잠금 해제 API 호출 시 CSRF 토큰이 유효하지 않음

**에러 메시지**:
```
[resetAccountLockStatus] 계정 잠금 해제 실패: parksc957662@gmail.com {
  error: {
    code: 'CSRF_TOKEN_INVALID',
    message: 'CSRFトークンが無効です。',
    timestamp: '2025-12-24T00:51:24.998Z'
  }
}
```

**영향받는 테스트**:
- `auth.spec.ts` - 계정 잠금 해제 시도 시 실패
- 사용자 테스트들의 `beforeAll`/`afterAll` 훅

**해결 방법**: CSRF 토큰을 올바르게 가져오거나, API 호출 방식 개선

---

### 3. 로그인 실패 ⚠️ (기능 버그 후보)

**문제**: 여러 사용자 테스트에서 로그인이 실패함

**에러 메시지**:
```
[loginWithEmail] 로그인 실패 (연속 실패: 1회)
[loginWithEmail] 로그인 실패 (연속 실패: 2회)
```

**영향받는 테스트**:
- `character-search.spec.ts` - 모든 테스트 실패
- `chat.spec.ts` - 모든 테스트 실패
- `auth.spec.ts` - 일부 테스트 실패
- `misc-features.spec.ts` - 모든 테스트 실패
- `points-critical.spec.ts` - 실패

**원인 분석 필요**:
- 계정 잠금 상태?
- 잘못된 자격 증명?
- 네트워크 문제?
- 서버 측 문제?

---

### 4. 사용자 테스트 대량 실패 ⚠️ (기능 버그 후보)

**실패한 테스트 목록**:

#### `character-search.spec.ts`
- `キャラクター一覧ページが表示される` ❌
- `キャラクターを検索できる` ❌
- `キャラクター詳細ページに遷移できる` ❌

#### `chat.spec.ts`
- `キャラクター詳細ページからチャットを開始できる` ❌
- `メッセージを送信できる` ❌
- `AI応答を受信できる` ❌
- `チャット履歴確認` ❌
- `チャットキャンセル` ❌

#### `misc-features.spec.ts`
- `チャット後ランキング反映確認` ❌
- `セーフティフィルターON時OFFキャラクターブロック` ❌
- `チャットノート機能` ❌

#### `points-critical.spec.ts`
- `P0-1: 新規登録 → 初期ポイント確認 → チャット1往復 → ポイント減少` ❌

#### `auth.spec.ts`
- `メールアドレスとパスワードでログインできる` ❌
- `ログアウトできる` ❌

**공통 원인**: 로그인 실패로 인한 연쇄 실패

---

### 5. 관리자 테스트 실패 ⚠️ (기능 버그 후보)

#### `admin-user-management.spec.ts`
- `2-2-5: ユーザー停止` ❌
  - 원인: 확인 버튼 클릭 또는 성공 메시지 확인 실패 가능성

#### `admin.spec.ts`
- `一般ユーザーは管理画面にアクセスできない` ⏭️ (스킵)
  - 원인: 로그인 실패로 인해 스킵됨

---

### 6. 스킵된 테스트 (기능 버그 후보)

다음 테스트들이 스킵되었습니다:

- `admin-character-management.spec.ts:143:7` - `2-3-5: キャラクター削除` ⏭️
- `admin-character-management.spec.ts:116:7` - `2-3-3: キャラクター公開/非公開切替` ⏭️
- `admin-character-management.spec.ts:171:7` - `2-3-7: ナモアイフレンズ登録/解除` ⏭️
- `admin-ip-management.spec.ts:70:7` - `2-10-2: IPブロック解除` ⏭️
- `admin-reports.spec.ts:110:7` - `2-8-4: 通報状態変更` ⏭️

**원인**: 테스트 조건 미충족 (예: 데이터 없음, 버튼 없음 등)

---

## 성공한 테스트

### 관리자 테스트 (대부분 성공 ✅)

- `admin-banners.spec.ts` - 모든 테스트 성공
- `admin-guides.spec.ts` - 모든 테스트 성공
- `admin-ip-management.spec.ts` - 일부 성공
- `admin-notices.spec.ts` - 모든 테스트 성공
- `admin-reports.spec.ts` - 일부 성공
- `admin-terms.spec.ts` - 모든 테스트 성공
- `admin-user-management.spec.ts` - 대부분 성공
- `admin-character-management.spec.ts` - 일부 성공
- `admin.spec.ts` - 대부분 성공

### 인증 테스트
- `auth.spec.ts` - `間違ったパスワードでログインできない` ✅

---

## 수정 완료 사항 ✅

### 테스트 코드 문제 수정

1. **logout 함수 타임아웃 증가** ✅
   - 수정 전: 5초
   - 수정 후: 15초 + 더 유연한 대기 로직
   - 로그아웃 버튼이 없거나 타임아웃 발생 시 로그인 페이지로 강제 이동

2. **CSRF 토큰 처리 개선** ✅
   - `resetAccountLockStatus` 함수에서 `/api/csrf-token` 엔드포인트를 호출하여 CSRF 토큰 가져오기
   - API 호출 시 `x-csrf-token` 헤더에 토큰 포함

3. **로그인 실패 원인 분석 개선** ✅
   - 로그인 실패 시 더 자세한 정보 출력:
     - 계정 이메일
     - 현재 URL
     - 에러 파라미터
     - 계정 잠금/정지 상태 확인
   - 계정 상태 확인 로직 추가 (잠금/정지 상태 자동 감지)

## 추가 수정 필요 사항

### 조사 필요 (기능 버그 후보)

### 조사 필요 (기능 버그 후보)

1. **사용자 로그인 실패 원인**
   - 계정 잠금 상태 확인
   - 자격 증명 확인
   - 서버 측 로그 확인

2. **사용자 테스트 대량 실패**
   - 로그인 실패가 원인인지 확인
   - 개별 테스트 실행하여 정확한 원인 파악

3. **관리자 테스트 실패**
   - `2-2-5: ユーザー停止` 테스트의 정확한 실패 원인 확인

---

## 다음 단계

1. ✅ logout 함수 타임아웃 수정
2. ✅ CSRF 토큰 처리 개선
3. ✅ 로그인 실패 원인 분석 및 수정
4. ⏳ 사용자 테스트 재실행 및 결과 확인
5. ⏳ 기능 버그 후보 테스트 상세 분석


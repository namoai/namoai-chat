# E2E テストシナリオ（P0: クリティカル）

**最終更新**: 2025年12月22日  
**対象環境**: develop環境（NAMOAIChat）

---

## 対象シナリオ（P0）

### 1) 新規登録 or ログイン → 初期ポイント確認 → チャット1往復 → ポイント減少

**テストファイル**: `e2e/points-critical.spec.ts` (P0-1)

**ステップ**:
1. テスト用ユーザーを作成（または既存ユーザーでログイン）
2. ログイン実行
3. 初期ポイントを確認（UI表示）
4. 初期ポイントを確認（APIレスポンス）
5. キャラクター一覧から最初のキャラクターを選択
6. キャラクター詳細ページでチャット開始
7. チャット1往復（メッセージ送信 → AI応答受信）
8. ポイント減少を確認（UI表示）
9. ポイント減少を確認（APIレスポンス）

**期待結果**:
- 初期ポイントが正しく表示される
- チャット後にポイントが減少する
- UIとAPIの両方でポイントが一致する

---

### 2) 画像作成 → 生成成功 → ポイント減少（失敗時は減らない）

**テストファイル**: `e2e/points-critical.spec.ts` (P0-2)

**ステップ**:
1. ログイン
2. 初期ポイントを確認（API）
3. キャラクター作成ページに移動
4. 画像生成機能を探す
5. 画像生成モーダルを開く
6. プロンプトを入力
7. 生成ボタンをクリック
8. 画像生成完了を待つ（最大60秒）
9. 成功時: ポイント減少を確認
10. 失敗時: ポイントが減っていないことを確認

**期待結果**:
- 成功時のみポイントが減少する
- 失敗時はポイントが減らない
- エラーメッセージが適切に表示される

**注意**: 外部API（Replicate）が不安定な場合、モック/スタブの実装を推奨

---

### 3) ポイント0でチャット不可 → 「ポイント購入が必要です」表示 + 購入導線

**テストファイル**: `e2e/points-critical.spec.ts` (P0-3)

**ステップ**:
1. ログイン
2. ポイントを0に設定（管理者APIまたは直接DB操作）
3. キャラクター詳細ページに移動
4. チャット開始を試みる
5. エラーメッセージまたはポイント不足メッセージを確認
6. 購入導線（ポイント購入ページへのリンク）を確認

**期待結果**:
- エラーメッセージが表示される
- 「ポイント購入が必要です」または類似のメッセージが表示される
- 購入ページへのリンクが表示される

**実装状況**: ポイントを0に設定する機能は実装に応じて調整が必要

---

### 4) ポイント0で画像作成不可 → 同上

**テストファイル**: `e2e/points-critical.spec.ts` (P0-4)

**ステップ**:
1. ログイン
2. ポイントを0に設定（実装に応じて）
3. キャラクター作成ページに移動
4. 画像生成を試みる
5. エラーメッセージを確認
6. 購入導線を確認

**期待結果**:
- エラーメッセージが表示される
- 購入ページへのリンクが表示される

---

### 5) 通信断/LLM失敗時 → エラー表示 + ポイント減らない + 再試行できる

**テストファイル**: `e2e/points-critical.spec.ts` (P0-5)

**ステップ**:
1. ログイン
2. 初期ポイントを確認（API）
3. チャットページに移動
4. ネットワークをオフラインに設定（通信断をシミュレート）
5. メッセージ送信を試みる
6. エラーメッセージを確認
7. ポイントが減っていないことを確認
8. ネットワークをオンラインに戻す
9. 再試行できることを確認（再送信ボタンまたはメッセージ再送信）
10. 正常に応答が返ることを確認
11. 再試行後はポイントが減ることを確認

**期待結果**:
- エラーメッセージが表示される
- ポイントが減らない
- 再試行可能
- 再試行後は正常に動作し、ポイントが減る

---

### 6) ログアウト→再ログインでキャラ/履歴/ポイント保持（仕様に合わせる）

**テストファイル**: `e2e/points-critical.spec.ts` (P0-6)

**ステップ**:
1. ログイン
2. 初期ポイントを確認（API）
3. チャットを1往復
4. チャット履歴を記録
5. ログアウト
6. 再ログイン
7. ポイントが保持されていることを確認
8. チャット履歴が保持されていることを確認

**期待結果**:
- ポイントが正しく保持される
- チャット履歴が正しく保持される
- キャラクター情報が正しく保持される

---

## 実装状況

### ✅ 実装済み

- P0-1: 新規登録/ログイン → チャット → ポイント減少
- P0-2: 画像作成 → ポイント減少（成功/失敗）
- P0-3: ポイント0でチャット不可
- P0-4: ポイント0で画像作成不可
- P0-5: 通信断/LLM失敗時のエラーハンドリング
- P0-6: ログアウト→再ログインでデータ保持

### ⚠️ 要調整

- **ポイント0設定**: 管理者APIまたはDB直接操作が必要（実装に応じて調整）
- **画像生成モック**: 外部APIが不安定な場合のモック/スタブ実装を推奨
- **テストユーザー作成**: `createTestUser`/`deleteTestUser`関数を実際のAPIと連携する必要がある

---

## 自動化要件の対応状況

| 要件 | 対応状況 | 備考 |
|------|---------|------|
| Playwright（TypeScript）で実装 | ✅ 完了 | すべてのテストがTypeScriptで実装済み |
| テストID（data-testid）を優先 | ✅ 実装済み | フォールバックでrole/label/textを使用 |
| UI操作でログイン | ✅ 実装済み | `loginUser`関数でUI操作によるログイン |
| ポイント残高の二重チェック | ✅ 実装済み | UI表示とAPIレスポンスの両方で確認 |
| 画像作成のモック/スタブ | ⚠️ 要実装 | 外部APIが不安定な場合の対応が必要 |
| 失敗時のスクショ/動画/トレース保存 | ✅ 設定済み | `playwright.config.ts`で設定済み |
| READMEに実行方法 | ✅ 完了 | `e2e/README.md`に記載 |
| テストケース一覧（表） | ✅ 完了 | `docs/E2E_TEST_CASES.md`に記載 |

---

## 実行方法

### ローカル実行

```bash
# すべてのP0テストを実行
npm run test:e2e -- e2e/points-critical.spec.ts

# UIモードで実行（デバッグ）
npm run test:e2e:ui -- e2e/points-critical.spec.ts

# ヘッドモードで実行
npm run test:e2e:headed -- e2e/points-critical.spec.ts
```

### CI/CD実行

GitHub Actionsで自動実行されます（`.github/workflows/e2e-tests.yml`参照）

---

## 参考

- [E2Eテストケース一覧](./E2E_TEST_CASES.md)
- [E2Eテスト実行ガイド](../e2e/README.md)
- [テストシナリオ詳細（韓国語）](../E2E_TEST_SCENARIOS_KO.md)









[functions]
  included_files = ["gcp/sa.json"]
  # OpenAI Embedding 生成など時間のかかる処理のためタイムアウトを30秒に延長
  node_bundler = "esbuild"

[functions."*"]
  # 全てのFunctionに対して30秒のタイムアウトを設定
  max_duration = 30
  # 画像アップロードのため最大ペイロードサイズを30MBに拡大（Netlifyの最大値）
  # ※ Netlify Proプラン以上で利用可能
  payload_size_limit = "30mb"

[build]
  # ▼▼▼【GSM】既存のSUPABASE_URLとSUPABASE_ANON_KEYをNEXT_PUBLIC_*として使用 ▼▼▼
  command = """
    node -e "
    const { SecretManagerServiceClient } = require('@google-cloud/secret-manager');
    const fs = require('fs');
    
    async function loadSecrets() {
      try {
        const client = new SecretManagerServiceClient({ fallback: true });
        const projectId = process.env.GOOGLE_PROJECT_ID;
        
        // 既存のSUPABASE_URLを読み込み
        const [urlSecret] = await client.accessSecretVersion({
          name: \`projects/\${projectId}/secrets/SUPABASE_URL/versions/latest\`
        });
        const url = Buffer.from(urlSecret.payload.data).toString('utf8').trim();
        
        // 既存のSUPABASE_ANON_KEYを読み込み
        const [keySecret] = await client.accessSecretVersion({
          name: \`projects/\${projectId}/secrets/SUPABASE_ANON_KEY/versions/latest\`
        });
        const key = Buffer.from(keySecret.payload.data).toString('utf8').trim();
        
        // NEXT_PUBLIC_*として.env.localに書き込み
        const envContent = \`NEXT_PUBLIC_SUPABASE_URL=\${url}\\nNEXT_PUBLIC_SUPABASE_ANON_KEY=\${key}\\n\`;
        fs.writeFileSync('.env.local', envContent);
        
        console.log('✅ GSMから環境変数をロードしました');
        console.log('✅ NEXT_PUBLIC_SUPABASE_URL:', url.substring(0, 30) + '...');
        console.log('✅ NEXT_PUBLIC_SUPABASE_ANON_KEY:', key.substring(0, 30) + '...');
      } catch (error) {
        console.error('❌ GSMロード失敗:', error.message);
        process.exit(1);
      }
    }
    
    loadSecrets();
    " && npm run build
  """
  # ▲▲▲

[build.environment]
  # Secret Manager を使用するため secrets scanning を無効化
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"
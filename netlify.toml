[functions]
  included_files = ["gcp/sa.json"]
  # OpenAI Embedding 生成など時間のかかる処理のためタイムアウトを30秒に延長
  node_bundler = "esbuild"

[functions."*"]
  # 全てのFunctionに対して30秒のタイムアウトを設定
  max_duration = 30
  # 画像アップロードのため最大ペイロードサイズを30MBに拡大（Netlifyの最大値）
  # ※ Netlify Proプラン以上で利用可能
  payload_size_limit = "30mb"

# Next.js App Router API routesのタイムアウト設定
# Next.js 15のサーバーレス関数は別途設定が必要な場合があります
[functions."app/api/main-page/route"]
  max_duration = 30

[functions."app/api/auth/*"]
  max_duration = 30

[functions."app/api/chat/*/route"]
  max_duration = 30

[functions."app/api/chat/messages/route"]
  max_duration = 60

[functions."app/api/chat/*/detailed-memories/route"]
  max_duration = 30

[functions."app/api/chat/*/back-memory/route"]
  max_duration = 60

[build]
  # ▼▼▼【GSM】ビルド時にGSM認証を設定してNEXT_PUBLIC変数をロード ▼▼▼
  command = "node scripts/load-gsm-secrets.js && npm run build"
  # ▲▲▲

[build.environment]
  # Secret Manager を使用するため secrets scanning を無効化
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"

# ▼▼▼【デプロイ設定】Productionデプロイをmainブランチのみに制限 ▼▼▼
# Production: mainブランチのみ
[context.production]
  command = "node scripts/load-gsm-secrets.js && npm run build"
  publish = ".next"

# Deploy Preview: PRや他のブランチ (クレジット消費が少ない)
[context.deploy-preview]
  command = "node scripts/load-gsm-secrets.js && npm run build"
  publish = ".next"

# Branch deploys: 特定のブランチ (例: develop) もBranch deployとして設定可能
# [context.branch-deploy]
#   command = "node scripts/load-gsm-secrets.js && npm run build"
#   publish = ".next"
# ▲▲▲
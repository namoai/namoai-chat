generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model characters {
  id                      Int                @id @default(autoincrement())
  name                    String
  description             String?
  systemTemplate          String?
  firstSituation          String?
  firstMessage            String?
  visibility              String?
  safetyFilter            Boolean?
  category                String?
  hashtags                String[]
  detailSetting           String?
  author_id               Int?
  isOfficial              Boolean            @default(false)
  createdAt               DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime           @default(now()) @updatedAt @db.Timestamptz(6)
  firstSituationDate      DateTime?          @db.Timestamptz(6)
  firstSituationPlace     String?
  statusWindowPrompt      String?            @db.Text
  statusWindowDescription String?            @db.Text
  characterImages         character_images[]
  author                  users?             @relation(fields: [author_id], references: [id])
  chat                    chat[]
  comments                comments[]
  embeddings              embeddings[]
  favorites               favorites[]
  interactions            interactions[]
  lorebooks               lorebooks[]
  reports                 reports[]
}

model users {
  id                            Int                         @id @default(autoincrement())
  email                         String                      @unique
  password                      String?
  name                          String
  phone                         String?                     @unique
  nickname                      String                      @unique
  dateOfBirth                   DateTime?
  declaredAdult                 Boolean?
  needsProfileCompletion        Boolean                     @default(false)
  created_at                    DateTime?                   @default(now()) @db.Timestamp(6)
  // NextAuth / PrismaAdapter compatibility: use standard field name `image`
  // while keeping the existing DB column name `image_url`.
  image                         String?                     @map("image_url")
  bio                           String?
  safetyFilter                  Boolean                     @default(true)
  defaultPersonaId              Int?
  role                          Role                        @default(USER)
  emailVerified                 DateTime?
  suspendedUntil                DateTime? // ユーザー停止期限
  suspensionReason              String? // 停止理由
  loginAttempts                 Int                         @default(0) // ログイン失敗回数
  lockedUntil                   DateTime? // アカウントロック期限
  twoFactorEnabled              Boolean                     @default(false) // 2FA有効化フラグ
  twoFactorSecret               String? // TOTPシークレット（ハッシュ化推奨）
  twoFactorBackupCodes          String[]                    @default([]) // バックアップコード（ハッシュ化）
  adultVerificationDate          DateTime? @db.Timestamptz(6) // 成人認証実施日時（証明文書用）
  adultVerificationBirthdate     DateTime? @db.Timestamptz(6) // 成人認証時に入力した生年月日（証明文書用）
  adultVerificationAgreed        Boolean? // 成人認証時の同意内容（証明文書用）
  referralCode                  String?   @unique @db.VarChar(10) // 自分の紹介コード
  referredByUserId              Int? // 誰が自分を紹介したか
  referredBy                    users?    @relation("ReferralRelation", fields: [referredByUserId], references: [id], onDelete: SetNull)
  referrals                     users[]   @relation("ReferralRelation") // 自分が紹介したユーザー
  accounts                      Account[]                   @relation("UserAccounts")
  Block_Block_blockerIdTousers  Block[]                     @relation("Block_blockerIdTousers")
  Block_Block_blockingIdTousers Block[]                     @relation("Block_blockingIdTousers")
  sessions                      Session[]                   @relation("UserSessions")
  characters                    characters[]
  chat                          chat[]
  comments                      comments[]
  favorites                     favorites[]
  following                     follows[]                   @relation("follower")
  followers                     follows[]                   @relation("following")
  interactions                  interactions[]
  personas                      personas[]
  points                        points?
  payments                      payments[]
  reports                       reports[]                   @relation("Reporter")
  notifications                 notifications[]             @relation("NotificationReceiver")
  notificationsSent             notifications[]             @relation("NotificationActor")
  emailVerificationTokens       email_verification_tokens[]
  pointTransactions             point_transactions[]
  pointUsageHistory             point_usage_history[]
  referralRewardsGiven          referral_rewards[]          @relation("ReferrerRewards") // 自分が与えた報酬
  referralRewardsReceived       referral_rewards[]          @relation("ReferredRewards") // 自分が受け取った報酬
  // ▼▼▼【修正】エラーを引き起こす重複した'sessions'フィールドを削除しました。▼▼▼
}

model character_images {
  id           Int        @id @default(autoincrement())
  imageUrl     String
  keyword      String?
  isMain       Boolean    @default(false)
  displayOrder Int        @default(0)
  createdAt    DateTime?  @default(now()) @db.Timestamptz(6)
  characterId  Int
  character    characters @relation(fields: [characterId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_character")
}

model favorites {
  id           Int         @id @default(autoincrement())
  user_id      Int?
  character_id Int?
  created_at   DateTime?   @default(now()) @db.Timestamp(6)
  characters   characters? @relation(fields: [character_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users        users?      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, character_id])
}

model interactions {
  id           Int         @id @default(autoincrement())
  user_id      Int?
  character_id Int?
  message      String
  is_user      Boolean
  created_at   DateTime?   @default(now()) @db.Timestamp(6)
  characters   characters? @relation(fields: [character_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users        users?      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model points {
  id                  Int       @id @default(autoincrement())
  user_id             Int       @unique
  free_points         Int       @default(0)
  paid_points         Int       @default(0)
  updated_at          DateTime  @default(now())
  lastAttendedAt      DateTime? @db.Timestamptz(6)
  freePointsExpiresAt DateTime? @db.Timestamptz(6) // 無料ポイント有効期限（1年）
  paidPointsExpiresAt DateTime? @db.Timestamptz(6) // 有料ポイント有効期限（1年）
  users               users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

// ポイント取引履歴テーブル（バッチ別管理）
model point_transactions {
  id          Int      @id @default(autoincrement())
  user_id     Int
  type        String   @db.VarChar(50) // 'free' or 'paid'
  amount      Int // 取得した量（正の値）
  balance     Int // このバッチの残高
  source      String   @db.VarChar(100) // 'attendance', 'purchase', 'admin_grant', 'migration'
  description String?  @db.Text // 詳細説明
  payment_id  Int? // paymentsテーブルのID（購入の場合）
  acquired_at DateTime @default(now()) @db.Timestamptz(6) // 取得日時
  expires_at  DateTime @db.Timestamptz(6) // 有効期限
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, balance])
  @@index([user_id, expires_at])
  @@index([user_id, type])
  @@index([expires_at])
}

// ポイント使用履歴テーブル
model point_usage_history {
  id                   Int      @id @default(autoincrement())
  user_id              Int
  points_used          Int // 使用したポイント数
  usage_type           String   @db.VarChar(50) // 'chat', 'image_generation', 'boost', 'other'
  description          String?  @db.Text // 詳細説明
  related_chat_id      Int? // 関連チャットID
  related_message_id   Int? // 関連メッセージID
  transaction_details  Json // どのバッチからいくら消費したかの詳細
  created_at           DateTime @default(now()) @db.Timestamptz(6)
  users                users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([usage_type])
  @@index([related_chat_id])
}

model payments {
  id                Int       @id @default(autoincrement())
  user_id           Int
  stripe_payment_id String?   @unique
  stripe_session_id String?   @unique
  amount            Int // 金額（円単位）
  points            Int // 付与ポイント数
  status            String    @default("pending") // pending, completed, failed, refunded
  currency          String    @default("jpy")
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  completed_at      DateTime? @db.Timestamptz(6)
  users             users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  referralRewards   referral_rewards[] // この決済によって発生した紹介報酬

  @@index([user_id])
  @@index([stripe_payment_id])
  @@index([stripe_session_id])
  @@index([status])
  @@index([created_at])
}

model chat {
  id                  Int                    @id @default(autoincrement())
  userId              Int
  characterId         Int
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  userNote            String?
  backMemory          String?                @db.Text
  backMemoryEmbedding Unsupported("vector")?
  autoSummarize       Boolean                @default(true)
  characters          characters             @relation(fields: [characterId], references: [id], onDelete: Cascade)
  users               users                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  chat_message        chat_message[]
  detailed_memories   detailed_memories[]

  // Note: backMemoryEmbedding index is created manually via SQL (ivfflat)
  // @@index([backMemoryEmbedding]) - removed to use ivfflat index
}

model chat_message {
  id        Int                    @id @default(autoincrement())
  chatId    Int
  role      String                 @db.VarChar(255)
  content   String
  createdAt DateTime               @default(now())
  turnId    Int?
  version   Int                    @default(1)
  isActive  Boolean                @default(true)
  embedding Unsupported("vector")?
  chat      chat                   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  // Note: embedding index is created manually via SQL (ivfflat)
  // @@index([embedding]) - removed to use ivfflat index

  @@index([chatId, turnId, isActive])
  @@index([chatId, isActive, createdAt], map: "chat_message_chatId_isActive_createdAt_idx")
}

model follows {
  followerId  Int
  followingId Int
  follower    users @relation("follower", fields: [followerId], references: [id])
  following   users @relation("following", fields: [followingId], references: [id])

  @@id([followerId, followingId])
}

model personas {
  id          Int      @id @default(autoincrement())
  nickname    String   @db.VarChar(20)
  age         Int?
  gender      String?  @db.VarChar(255)
  description String   @db.VarChar(1000)
  createdAt   DateTime @default(now())
  authorId    Int
  users       users    @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
}

model notices {
  id        Int      @id @default(autoincrement())
  category  String   @db.VarChar(50)
  title     String   @db.VarChar(255)
  content   String
  createdAt DateTime @default(now()) @db.Timestamp(6)
}

model guides {
  id           Int      @id @default(autoincrement())
  mainCategory String   @db.VarChar(100)
  subCategory  String   @db.VarChar(100)
  title        String   @db.VarChar(255)
  content      String
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@index([mainCategory, subCategory])
}

model lorebooks {
  id          Int                    @id @default(autoincrement())
  content     String
  keywords    String[]
  characterId Int
  embedding   Unsupported("vector")?
  characters  characters             @relation(fields: [characterId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([embedding])
}

model comments {
  id             Int        @id @default(autoincrement())
  content        String
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  characterId    Int
  authorId       Int
  parentId       Int?
  users          users      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  characters     characters @relation(fields: [characterId], references: [id], onDelete: Cascade)
  comments       comments?  @relation("commentsTocomments", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_comments comments[] @relation("commentsTocomments")

  @@index([authorId])
  @@index([characterId])
}

model Block {
  blockerId                     Int
  blockingId                    Int
  createdAt                     DateTime @default(now())
  users_Block_blockerIdTousers  users    @relation("Block_blockerIdTousers", fields: [blockerId], references: [id], onDelete: Cascade)
  users_Block_blockingIdTousers users    @relation("Block_blockingIdTousers", fields: [blockingId], references: [id], onDelete: Cascade)

  @@id([blockerId, blockingId])
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              users   @relation("UserAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         users    @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model email_verification_tokens {
  id        Int      @id @default(autoincrement())
  userId    Int
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([email])
  @@index([expires])
}

model embeddings {
  id           Int                    @id @default(autoincrement())
  character_id Int?
  content      String?
  embedding    Unsupported("vector")?
  characters   characters?            @relation(fields: [character_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([embedding])
  @@index([embedding], map: "embeddings_embedding_idx1")
}

model detailed_memories {
  id          Int                    @id @default(autoincrement())
  chatId      Int
  content     String                 @db.Text
  keywords    String[] // キーワード配列
  embedding   Unsupported("vector")?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  lastApplied DateTime? // 最後に適用された時刻
  chat        chat                   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  // Note: embedding index is created manually via SQL (ivfflat)
  // @@index([embedding]) - removed to use ivfflat index

  @@index([chatId, createdAt])
}

// ▼▼▼【修正】不要で重複エラーを引き起こす'sessions'モデルを削除しました。▼▼▼

model reports {
  id          Int         @id @default(autoincrement())
  type        String // CHARACTER_REPORT, SUGGESTION, INQUIRY, SYSTEM_ISSUE, REFUND_REQUEST, FEATURE_REQUEST, BUG_REPORT, OTHER
  characterId Int?
  reporterId  Int
  title       String?     @db.VarChar(255)
  reason      String
  content     String      @db.Text
  status      String      @default("PENDING") // PENDING, REVIEWED, RESOLVED, REJECTED
  adminNotes  String?     @db.Text
  reviewedBy  Int?
  reviewedAt  DateTime?   @db.Timestamptz(6)
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @updatedAt @db.Timestamptz(6)
  characters  characters? @relation(fields: [characterId], references: [id], onDelete: Cascade)
  reporter    users       @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([reporterId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model notifications {
  id          Int      @id @default(autoincrement())
  userId      Int // 通知を受け取るユーザー
  type        String // FOLLOWER_CHARACTER, LIKE, COMMENT, INQUIRY_RESPONSE, FOLLOW
  title       String   @db.VarChar(255)
  content     String   @db.Text
  link        String? // 通知クリック時の遷移先URL
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  actorId     Int? // アクションを実行したユーザーID
  characterId Int? // 関連キャラクターID
  commentId   Int? // 関連コメントID
  reportId    Int? // 関連レポートID
  user        users    @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)
  actor       users?   @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([userId, createdAt])
}

model terms {
  id        Int      @id @default(autoincrement())
  slug      String   @unique @db.VarChar(255) // URL用の識別子 (例: "terms-of-service", "privacy-policy")
  title     String   @db.VarChar(255) // 表示タイトル (例: "ナモアイ利用規約")
  content   String   @db.Text // マークダウン形式の内容
  displayOrder Int   @default(0) // 表示順序
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([slug])
}

model banners {
  id          Int      @id @default(autoincrement())
  title       String?  @db.VarChar(255)
  description String?  @db.VarChar(500)
  imageUrl    String   @db.Text
  link        String?  @db.VarChar(500)
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([displayOrder])
  @@index([isActive])
}

model referral_rewards {
  id                Int      @id @default(autoincrement())
  referrer_user_id  Int // 紹介者ID
  referred_user_id  Int // 被紹介者ID
  points_awarded    Int // 付与されたポイント
  payment_id        Int? // 初回決済のpayments.id
  rewarded_at       DateTime @default(now()) @db.Timestamptz(6) // 報酬付与日時
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  referrer          users    @relation("ReferrerRewards", fields: [referrer_user_id], references: [id], onDelete: Cascade)
  referred          users    @relation("ReferredRewards", fields: [referred_user_id], references: [id], onDelete: Cascade)
  payment           payments? @relation(fields: [payment_id], references: [id], onDelete: SetNull)

  @@unique([referred_user_id]) // 被紹介者は一度だけ報酬を生成できる
  @@index([referrer_user_id])
  @@index([referred_user_id])
  @@index([rewarded_at])
}

enum Role {
  USER
  MODERATOR
  CHAR_MANAGER
  SUPER_ADMIN
}

# セキュリティ修正と問題対応記録

## 📋 概要

本プロジェクトで発見・修正したセキュリティ脆弱性とデータベース接続問題の詳細記録です。

---

## 🔴 1. SQL Injection脆弱性の修正

### エラー内容
**問題**: ベクトル検索機能（チャットメッセージや記憶の類似検索）で、悪意のあるユーザーがSQLコマンドを注入してデータベースを操作できる可能性がありました。

**具体的なリスク**:
- データベース内の全データを削除される可能性
- 他のユーザーの情報を不正に取得される可能性
- システム全体が停止する可能性

### 原因
検索機能で使用するテーブル名や検索条件が、適切にチェックされずにそのままデータベースのSQL文に組み込まれていました。これにより、悪意のあるコードがSQL文の一部として実行される危険性がありました。

### 対応内容
1. **テーブル名・カラム名の制限**: 使用可能なテーブル名とカラム名を事前にリスト化し、そのリストに含まれるもののみ使用可能にしました。
2. **数値パラメータの検証**: 検索条件として使用する数値（チャットIDなど）を、必ず数値に変換してから使用するようにし、不正な値が混入しないようにしました。
3. **エラーハンドリングの改善**: 不正な値が検出された場合は、エラーを返すのではなく安全に処理を中断するようにしました。

### 対策
- ✅ すべてのSQLクエリで、外部から入力される値は必ず検証・変換してから使用
- ✅ 使用可能なテーブル名・カラム名をホワイトリストで管理
- ✅ 数値パラメータは必ず数値型に変換し、不正な値は除外
- ✅ 開発環境でのみ詳細なエラーログを出力（本番環境では機密情報を保護）

---

## 🔴 2. 画像アップロード検証の不足

### エラー内容
**問題**: 画像アップロード機能で、ファイルの種類やサイズをチェックしていなかったため、以下の問題が発生する可能性がありました。

**具体的なリスク**:
- 5MBを超える大きなファイルがアップロードされ、サーバーの容量を圧迫
- 画像ファイルを装った悪意のあるプログラム（ウイルスなど）がアップロードされる
- ファイル名に特殊文字が含まれ、システムエラーが発生する

### 原因
他の機能（キャラクター作成など）では画像検証を行っていましたが、クライアントサイドからの直接アップロード用のAPIでは検証処理が実装されていませんでした。

### 対応内容
1. **ファイルサイズ制限**: 最大5MBまでに制限しました。
2. **ファイル形式の検証**: PNG、JPEG、WebP、GIFのみを許可し、それ以外の形式は拒否しました。
3. **マジックナンバー検証**: ファイルの拡張子ではなく、ファイルの中身（ヘッダー情報）を確認して、本当に画像ファイルかどうかを判定するようにしました。これにより、`.exe`ファイルを`.jpg`にリネームしてアップロードするような偽装を防げます。
4. **安全なファイル名生成**: アップロードされたファイル名にUUID（一意の識別子）を付与し、特殊文字による問題を防ぎました。

### 対策
- ✅ すべての画像アップロードエンドポイントで統一された検証を適用
- ✅ ファイルサイズ制限（5MB）を設定
- ✅ マジックナンバー検証でファイルタイプの偽装を防止
- ✅ 安全なファイル名生成（UUID付き）でファイル名インジェクションを防止

---

## 🔴 3. 本番環境での機密情報漏洩リスク

### エラー内容
**問題**: 本番環境（実際にユーザーが使用する環境）で、システムの設定情報や機密情報がログに出力されていました。

**具体的なリスク**:
- 環境変数のキー名がログに出力され、どのような設定が存在するか推測される
- エラーメッセージに機密情報が含まれ、外部に漏洩する可能性
- 攻撃者がシステムの内部構造を把握しやすくなる

### 原因
開発環境と本番環境を区別せずに、すべての環境で詳細なデバッグ情報をログに出力していました。開発時には便利ですが、本番環境ではセキュリティリスクとなります。

### 対応内容
1. **条件付きログ出力**: すべてのログ出力を「開発環境でのみ」という条件で制限しました。本番環境では詳細なログは出力されません。
2. **エラーメッセージの統一**: 本番環境では、ユーザー向けの汎用的なエラーメッセージのみを返すようにしました。詳細な技術情報は開発環境でのみ表示されます。
3. **機密情報の保護**: 環境変数の値やキー名、内部的なエラー詳細は、本番環境では一切出力しないようにしました。

### 対策
- ✅ すべてのログ出力を開発環境でのみ実行するように条件分岐
- ✅ 本番環境では機密情報を含むログを一切出力しない
- ✅ エラーメッセージはユーザー向けの汎用的なメッセージに統一
- ✅ 開発環境でのみ詳細なデバッグ情報を出力

---

## 🔴 4. データベース接続問題（環境別URL対応）

### エラー内容
**問題**: AWS環境（本番環境やテスト環境）でデータベースに接続できないエラーが発生していました。

**具体的な症状**:
- 「ポイントデータの取得に失敗しました」などのエラーが表示される
- データの読み書きができない
- アプリケーションが正常に動作しない

### 原因
システムは複数の環境（開発環境、テスト環境、本番環境）で動作しますが、それぞれ異なるデータベースURLを使用する必要がありました。しかし、環境を自動的に判別して適切なデータベースURLを選択する機能が実装されていませんでした。

**環境の種類**:
- **開発環境**: ローカル開発用のデータベース
- **テスト環境（Integration）**: テスト用のデータベース
- **ステージング環境**: 本番前の最終確認用データベース
- **本番環境**: 実際のユーザーが使用するデータベース

### 対応内容
1. **環境自動判別機能の追加**: システム起動時に環境変数`APP_ENV`を確認し、現在の環境を自動的に判別するようにしました。
2. **環境別URLの優先順位設定**: 
   - テスト環境の場合 → `IT_DATABASE_URL`を使用
   - ステージング環境の場合 → `STAGING_DATABASE_URL`を使用
   - 上記が設定されていない場合 → `DATABASE_URL`を使用（既存コードとの互換性）
3. **ログ出力の改善**: どの環境のデータベースURLを使用しているかをログに出力し、問題発生時のデバッグを容易にしました。

### 対策
- ✅ 環境変数`APP_ENV`に基づいて適切なDATABASE_URLを自動選択
- ✅ 後方互換性を維持（`DATABASE_URL`がフォールバックとして機能）
- ✅ ログ出力で使用中のURLを明確化（デバッグ用）
- ✅ AWS Lambda環境での環境変数読み込みタイミングに対応

---

## 📊 修正サマリー

| 問題 | 深刻度 | 影響範囲 | ステータス |
|------|--------|----------|-----------|
| SQL Injection脆弱性 | 🔴 高 | ベクトル検索機能（チャット、記憶検索） | ✅ 修正済み |
| 画像検証の不足 | 🟡 中 | 画像アップロード機能 | ✅ 修正済み |
| 機密情報漏洩リスク | 🟡 中 | 全API（NextAuth、Cloudflare、画像アップロード） | ✅ 修正済み |
| データベース接続問題 | 🟡 中 | 全データベース操作 | ✅ 修正済み |

---

## 🔒 セキュリティベストプラクティス

### 実装済みの対策
- ✅ **入力値の検証**: すべてのユーザー入力は必ず検証・サニタイズしてから使用
- ✅ **SQL Injection対策**: データベースクエリではホワイトリスト検証とパラメータ変換を実施
- ✅ **ファイルアップロード検証**: ファイルサイズ、形式、内容を多層的に検証
- ✅ **機密情報保護**: 本番環境では機密情報を含むログを一切出力しない
- ✅ **環境別設定**: 各環境に適切な設定を自動的に適用

### 今後の推奨事項
- [ ] **Rate Limiting**: APIへの過剰なリクエストを制限（DDoS攻撃対策）
- [ ] **CSRF対策の強化**: クロスサイトリクエストフォージェリ攻撃の防止
- [ ] **セキュリティヘッダーの追加**: ブラウザのセキュリティ機能を活用
- [ ] **定期的なセキュリティ監査**: 定期的に脆弱性をチェック

---

## 📝 参考情報

### 修正コミット
- `4bddc1f`: SQL Injection脆弱性の修正と機密情報漏洩対策
- `43723ad`: 画像アップロード検証の追加
- `e1b6ff9`: 環境別データベースURL対応とAWS Lambda信頼性向上

### 修正ファイル一覧
- `src/lib/vector-search.ts`: ベクトル検索のSQL Injection対策
- `src/app/api/upload-image/route.ts`: 画像検証の追加
- `src/app/api/auth/[...nextauth]/route.ts`: ログ出力の条件分岐
- `src/lib/cloudflare-images.ts`: ログ出力の条件分岐
- `src/lib/prisma.ts`: 環境別データベースURL対応

---

## 💡 まとめ

今回の修正により、以下のセキュリティリスクと運用問題を解決しました：

1. **SQL Injection攻撃の防止**: データベースへの不正アクセスを防ぐ仕組みを実装
2. **不正ファイルアップロードの防止**: 画像ファイルのみを受け付ける検証を追加
3. **機密情報の保護**: 本番環境での情報漏洩リスクを排除
4. **環境別設定の自動化**: 各環境で適切なデータベースに接続できるように改善

これらの修正により、システムのセキュリティと信頼性が大幅に向上しました。

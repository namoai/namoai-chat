# 必要な実装・修正リスト（簡易版）

**プロジェクト**: namos-chat-v1  
**作成日**: 2025年12月17日

---

## ✅ 既に実装済み

1. ✅ ユーザー認証・登録
2. ✅ キャラクター管理（CRUD）
3. ✅ チャット機能
4. ✅ ポイントシステム（free/paid分離）
5. ✅ Stripe決済連携
6. ✅ 通報機能（reports）
7. ✅ 管理者機能（SUPER_ADMIN）
8. ✅ 一時停止機能（suspendedUntil）
9. ✅ 通知機能
10. ✅ セーフティフィルター（基本）
11. ✅ 出席チェック（lastAttendedAt）

---

## 🔴 Critical: ローンチ前必須（未実装・要修正）

### 1. 年齢確認システム強化 ⭐⭐⭐⭐⭐
**現状**: `users.dateOfBirth`フィールドはあるが、13歳未満ブロックの実装なし  
**必要な対応**:
- [ ] 登録時に年齢計算して13歳未満は登録不可
- [ ] 13～18歳は保護者同意チェックボックス必須
- [ ] DB追加: `users.ageGroup`, `users.parentalConsent`

---

### 2. チャットログ90日自動削除 ⭐⭐⭐⭐⭐
**現状**: 削除機能なし  
**必要な対応**:
- [ ] DB追加: `chat.lastActivityAt`, `chat.deletedAt`
- [ ] バッチスクリプト作成: 90日以上経過したチャット削除
- [ ] Cronジョブ設定（毎日実行）

---

### 3. アカウント削除30日処理 ⭐⭐⭐⭐⭐
**現状**: 即時削除のみ  
**必要な対応**:
- [ ] DB追加: `users.deletionRequestedAt`, `users.deletionScheduledAt`, `users.deletedAt`
- [ ] 削除申請API追加
- [ ] キャンセルAPI追加
- [ ] バッチスクリプト: 30日経過後に実行
- [ ] 通知メール送信

---

### 4. AI学習オプトアウト ⭐⭐⭐⭐⭐
**現状**: 設定なし  
**必要な対応**:
- [ ] DB追加: `users.aiTrainingOptOut`, `chat_message.canUseForTraining`
- [ ] 設定ページ追加
- [ ] API追加: オプトアウト設定変更

---

### 5. Cookieコンセントバナー ⭐⭐⭐⭐⭐
**現状**: なし  
**必要な対応**:
- [ ] フロントエンド: Cookie同意バナーコンポーネント
- [ ] LocalStorage: 同意状況保存
- [ ] Google Analytics条件付き読み込み

---

### 6. ポイント有効期限管理 ⭐⭐⭐⭐
**現状**: 有効期限フィールドなし  
**必要な対応**:
- [ ] DB追加: `points.freePointsExpiresAt`
- [ ] 無償ポイント付与時に1年後の期限設定
- [ ] バッチスクリプト: 期限切れポイント削除
- [ ] 期限7日前の通知メール

---

### 7. ポイント購入制限 ⭐⭐⭐⭐
**現状**: 制限なし  
**必要な対応**:
- [ ] 1日の購入上限チェック（10万円）
- [ ] アカウント保有上限チェック（100万ポイント）
- [ ] 未成年者の月間上限チェック（1万円）
- [ ] DB追加: 購入履歴集計用テーブル

---

### 8. 不正取引検知 ⭐⭐⭐⭐
**現状**: なし  
**必要な対応**:
- [ ] 短時間高額購入検知
- [ ] 新規アカウント高額購入検知
- [ ] 同一IP複数アカウント検知
- [ ] 管理画面アラート機能

---

### 9. 利用規約・プライバシーポリシー表示ページ ⭐⭐⭐⭐⭐
**現状**: 確認必要  
**必要な対応**:
- [ ] `/terms` ページ作成
- [ ] `/privacy` ページ作成
- [ ] `/tokushoho` ページ作成
- [ ] `/shikin-kessai` ページ作成
- [ ] フッターリンク追加

---

### 10. 管理者: キャラクター一括削除機能 ⭐⭐⭐⭐
**現状**: `/admin/characters`はあるが削除機能確認必要  
**必要な対応**:
- [ ] 削除理由記録機能
- [ ] 削除ログ保存（バックアップ）
- [ ] 作成者への通知メール
- [ ] 悪質な場合のアカウント停止処理

---

### 11. セーフティフィルター強化 ⭐⭐⭐⭐⭐
**現状**: 基本的なフィルターはあり  
**必要な対応**:
- [ ] キーワードブラックリスト拡充
- [ ] 回避パターン検知（例: "s e x"）
- [ ] 違反カウント機能
- [ ] 3回違反で自動停止
- [ ] DB追加: `users.safetyViolationsCount`

---

### 12. メール通知システム整備 ⭐⭐⭐⭐
**現状**: 通知テーブルはあるがメール送信確認必要  
**必要な対応**:
- [ ] 規約変更通知メール
- [ ] アカウント停止通知メール
- [ ] キャラクター削除通知メール
- [ ] チャット削除予告メール
- [ ] アカウント削除予告メール
- [ ] ポイント期限通知メール

---

## 🟡 High: ローンチ後1ヶ月以内

### 13. チャット履歴削除機能 ⭐⭐⭐⭐
**現状**: なし  
**必要な対応**:
- [ ] 個別チャット削除API
- [ ] 一括削除API
- [ ] フロントエンド: 削除ボタン・確認ダイアログ

---

### 14. データダウンロード機能 ⭐⭐⭐⭐
**現状**: なし  
**必要な対応**:
- [ ] ユーザーデータエクスポートAPI（JSON形式）
- [ ] ダウンロードボタン（マイページ）

---

### 15. クリエイター育成プログラム ⭐⭐⭐⭐
**現状**: なし  
**必要な対応**:
- [ ] DB新規: `creator_applications`, `creator_earnings`, `creator_earning_transactions`
- [ ] 申請フォーム
- [ ] 管理者: 承認/却下機能
- [ ] ツリー計算バッチ
- [ ] 換金申請フォーム
- [ ] 銀行口座登録機能

---

### 16. 領収書・購入履歴ページ ⭐⭐⭐
**現状**: `payments`テーブルはあるが表示画面なし  
**必要な対応**:
- [ ] 購入履歴一覧ページ
- [ ] 領収書PDF生成機能

---

### 17. 2FA（二要素認証） ⭐⭐⭐
**現状**: なし  
**必要な対応**:
- [ ] TOTP対応
- [ ] QRコード生成
- [ ] バックアップコード発行
- [ ] DB追加: `users.twoFactorSecret`, `users.twoFactorEnabled`

---

## 🟠 Medium: ローンチ後3ヶ月以内

### 18. プライバシーダッシュボード ⭐⭐⭐
**必要な対応**:
- [ ] データサマリー表示
- [ ] プライバシー設定一元管理
- [ ] AI学習オプトアウト
- [ ] Cookie設定
- [ ] データダウンロード
- [ ] アカウント削除

---

### 19. 個人情報開示請求フォーム ⭐⭐
**必要な対応**:
- [ ] 開示請求フォーム
- [ ] 本人確認プロセス
- [ ] 手数料決済（1,000円）

---

### 20. キャラクター検索・フィルタ強化 ⭐⭐⭐
**現状**: 基本検索はあり  
**必要な対応**:
- [ ] カテゴリフィルタ
- [ ] タグフィルタ
- [ ] 人気順・新着順ソート

---

### 21. 通知設定 ⭐⭐
**必要な対応**:
- [ ] メール通知ON/OFF
- [ ] 通知種別ごとの設定

---

## 📊 DB修正サマリー

### 追加テーブル
```sql
-- クリエイター関連
CREATE TABLE creator_applications (...);
CREATE TABLE creator_earnings (...);
CREATE TABLE creator_earning_transactions (...);

-- 削除ログ
CREATE TABLE data_deletion_logs (...);
```

### 既存テーブル修正
```sql
-- users
ALTER TABLE users ADD COLUMN ageGroup VARCHAR(20);
ALTER TABLE users ADD COLUMN parentalConsent BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN deletionRequestedAt TIMESTAMP;
ALTER TABLE users ADD COLUMN deletionScheduledAt TIMESTAMP;
ALTER TABLE users ADD COLUMN deletedAt TIMESTAMP;
ALTER TABLE users ADD COLUMN aiTrainingOptOut BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN safetyViolationsCount INT DEFAULT 0;
ALTER TABLE users ADD COLUMN twoFactorSecret VARCHAR(255);
ALTER TABLE users ADD COLUMN twoFactorEnabled BOOLEAN DEFAULT FALSE;

-- chat
ALTER TABLE chat ADD COLUMN lastActivityAt TIMESTAMP DEFAULT NOW();
ALTER TABLE chat ADD COLUMN deletedAt TIMESTAMP;

-- chat_message
ALTER TABLE chat_message ADD COLUMN canUseForTraining BOOLEAN DEFAULT TRUE;

-- points
ALTER TABLE points ADD COLUMN freePointsExpiresAt TIMESTAMP;
```

---

## 📋 優先順位付き実装チェックリスト

### Phase 1: ローンチ前（3週間）
- [ ] 1. 年齢確認システム強化
- [ ] 2. Cookieコンセントバナー
- [ ] 3. 利用規約・プライバシーポリシーページ
- [ ] 4. セーフティフィルター強化
- [ ] 5. ポイント有効期限管理
- [ ] 6. ポイント購入制限
- [ ] 7. 不正取引検知
- [ ] 8. 管理者キャラクター削除機能
- [ ] 9. メール通知システム整備

### Phase 2: ローンチ後1週間以内
- [ ] 10. チャットログ90日自動削除
- [ ] 11. アカウント削除30日処理
- [ ] 12. AI学習オプトアウト

### Phase 3: ローンチ後1ヶ月以内
- [ ] 13. チャット履歴削除機能
- [ ] 14. データダウンロード機能
- [ ] 15. クリエイター育成プログラム
- [ ] 16. 領収書・購入履歴ページ
- [ ] 17. 2FA

### Phase 4: ローンチ後3ヶ月以内
- [ ] 18. プライバシーダッシュボード
- [ ] 19. 個人情報開示請求フォーム
- [ ] 20. キャラクター検索・フィルタ強化
- [ ] 21. 通知設定

---

## 🎯 最優先（今すぐ対応）

1. **年齢確認システム** - 法的リスク最大
2. **Cookieバナー** - EU GDPR対応
3. **利用規約・プライバシーポリシーページ** - 法定表示義務
4. **セーフティフィルター強化** - 性的コンテンツ防止
5. **ポイント購入制限** - マネロン・未成年保護

---

**作成者**: 株式会社NAMOS  
**最終更新**: 2025年12月17日


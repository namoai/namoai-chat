

# **UI基本設計書: ナモアイ**

## **第1部：機能モジュール仕様（システム設計）**

### **第1章: 01\_認証及びユーザー管理**

本章では、アプリケーションの基盤となる認証プロセスとユーザーアカウント管理機能に関するシステム全体の仕様を定義します 1。

#### **1\. 画面概要**

* **機能名:** 認証及びユーザー管理  
* **対象画面:** 会員登録、ログイン、マイページ、プロフィール編集、パスワード変更、プロフィール閲覧、アカウント停止ページ  
* **技術スタック:** Next.js 15, TypeScript, NextAuth v4, Prisma, PostgreSQL 1

#### **2\. 前提・制約**

* セッション取得は getServerSession() によるサーバーサイド実行を基本とします。  
* 未ログインユーザーは /login へリダイレクトされます。  
* 停止中（suspendedUntil が未来日時のユーザー）はログインをブロックし、/suspended へリダイレクトします 1。  
* Google OAuthのみで登録したユーザーは、パスワード変更機能が非表示となります（hasPassword フラグで判定）。  
* 画像アップロードは最大5MB（対応形式: jpg, jpeg, png, gif, webp）に制限されます 1。

#### **3\. 関連URL・遷移**

* /register (会員登録ページ)  
* /login (ログインページ)  
* /MyPage (マイページ)  
* /profile-edit (プロフィール編集ページ)  
* /change-password (パスワード変更ページ)  
* /profile/\[userId\] (ユーザープロフィール閲覧ページ)  
* /suspended (アカウント停止専用ページ) 1

#### **4\. 役割・権限**

* **一般ユーザー:** 全ての認証機能にアクセス可能です。自分のプロフィールのみ編集できます。  
* **停止ユーザー:** ログイン不可。既存セッションも無効化され、マイページなど認証必須ページへのアクセス時に /suspended へ強制遷移させられます 1。  
* **削除済みユーザー:** ログイン不可。セッションは無効化されますが、同じメールアドレスでの再登録は可能です 1。

#### **5\. 主要機能一覧**

* メールアドレス、パスワード、ニックネームによる会員登録。  
* Google OAuthによるワンクリック登録およびログイン。  
* ログイン時の停止状態チェック機能。  
* プロフィール編集（ニックネーム、プロフィール画像、自己紹介）。  
* パスワード変更（既存パスワードの確認必須、OAuthユーザーは非表示）。  
* セーフティフィルター（不適切コンテンツのフィルタリング）のオン/オフ設定 1。  
* 会員退会（2段階確認モーダルによるアカウント削除）。退会時、ユーザーが作成したキャラクターデータは作成者を匿名化して保持されますが、個人データは完全削除されます 1。

#### **6\. 画面構成（UIブロック）**

* **共通:** ヘッダー（ロゴ、ナビ）、ボトムナビ（モバイル専用）。  
* **フォーム:** 会員登録フォーム、ログインフォーム（Google OAuthボタン含む）。  
* **停止処理:**  
  * 停止モーダル: 一般ログイン試行時に停止理由と期限を表示 1。  
  * 停止ページ: OAuthログイン試行時、またはセッション有効中に停止されたユーザーがアクセスした際に表示される専用画面（ログアウトのみ可能）1。  
* **マイページ:** ダッシュボード形式。プロフィール情報、作成キャラクター一覧、ポイント表示、各種設定へのリンク 1。  
* **モーダル:** 会員退会確認モーダル（2段階構成。キャラクター保持に関する説明を含む）1。

#### **7\. 画面項目定義**

*本セクションは、認証およびプロフィール関連の主要なデータ項目を定義します。*

| 項目名 | 型 | バリデーション / 制約 | 備考 |
| :---- | :---- | :---- | :---- |
| 【登録】メールアドレス | string | 必須, メール形式チェック, 既存ユーザー重複チェック | 一意制約 1 |
| 【登録】パスワード | string | 必須, 8文字以上, 英数字推奨 | bcryptでハッシュ化 1 |
| 【登録】ニックネーム | string | 必須, 1〜50文字 | 1 |
| 【プロフ編集】プロフィール画像 | file | 任意, 最大5MB, jpg/jpeg/png/gif/webp | アップロード後にURLとして保存 1 |
| 【プロフ編集】自己紹介 | string | 任意, 最大500文字 | テキストエリア 1 |
| 【PW変更】現在のパスワード | string | 必須, 既存パスワードと一致確認 | 1 |
| 【PW変更】新しいパスワード | string | 必須, 8文字以上 | 1 |

#### **8\. フィルタ仕様**

* **停止ユーザーフィルター:** users.suspendedUntil カラムのタイムスタンプが現在時刻より未来の場合、「停止中」と判定します 1。  
* **セーフティフィルター:** users.safetyFilterEnabled (boolean) の値に基づき、キャラクター表示やチャット応答のフィルタリングを切り替えます 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/register | POST | { email, password, nickname } | { success, userId } | 新規会員登録API 1 |
| /api/auth/\[...nextauth\] | POST/GET | NextAuth標準 | { session, user } | NextAuth認証ハンドラー（ログイン・OAuth）1 |
| /api/users/profile | GET | クエリなし | { user: {...} } | 自分のプロフィール情報取得API 1 |
| /api/users/profile | PUT | { nickname, image, bio } | { success, message } | プロフィール更新API 1 |
| /api/users/change-password | POST | { currentPassword, newPassword } | { success, message } | パスワード変更API 1 |
| /api/users/safety-filter | PUT | { enabled: boolean } | { success } | セーフティフィルター設定API 1 |
| /api/users/account | DELETE | クエリなし | { success, message } | アカウント削除API（会員退会）1 |
| /api/profile/\[userId\] | GET | (URLパラメータ) | { user: {...} } | 特定ユーザープロフィール取得API 1 |

#### **10\. エラー・通知文言**

| 表示タイミング | 文言 |
| :---- | :---- |
| 重複メール登録時 | このメールアドレスは既に登録されています。 1 |
| 認証失敗時 | メールアドレスまたはパスワードが正しくありません。 1 |
| 停止中ユーザーのログイン時 | あなたのアカウントは停止されています。 理由: {reason} ・ 期限: {date} 1 |
| 削除済みアカウントのログイン時 | このアカウントは削除されました。 1 |
| パスワード不一致時 | 現在のパスワードが正しくありません。 1 |
| 画像サイズオーバー時 | 画像サイズは5MB以下にしてください。 1 |
| プロフィール更新成功時 | プロフィールを更新しました。 1 |

#### **11\. モーダル仕様**

* **停止通知モーダル:** 停止中ユーザーの一般ログイン時にトリガー。停止理由と期限を表示 1。  
* **会員退会確認モーダル（1段階目）:** 退会ボタン押下時。アカウント削除の影響と、キャラクターデータが匿名化されて保持される旨を説明 1。  
* **会員退会確認モーダル（2段階目）:** 1段階目で「次へ」押下時。最終確認。「本当に削除しますか？」1。

#### **12\. 認証・ガード**

* **認証チェック:** 全ページで getServerSession() を使用し、未ログインであれば /login へリダイレクトします 1。  
* **停止チェック:** マイページなど主要な認証済みページへのアクセス時、セッション情報だけでなくデータベースの users.suspendedUntil を再確認します。セッション有効中に停止された場合でも、/suspended へリダイレクトさせます 1。  
* **OAuth専用ユーザー:** hasPassword フラグ（または類似の判定）に基づき、パスワード変更メニューを非表示にします 1。

#### **13\. 非機能要件**

* **パフォーマンス:** セッション情報はRedisでキャッシュし、プロフィール画像はCDN経由で配信します 1。  
* **セキュリティ:** パスワードはbcrypt（saltRounds: 10）でハッシュ化し、CSRF保護を有効にします 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| 会員登録: 異常系 | 重複メールで登録失敗。バリデーションエラー表示 1。 |
| ログイン: 異常系 | 間違ったパスワードでエラー表示 1。 |
| 停止ユーザー: ログイン拒否 | 停止中ユーザーのログインを拒否し、停止情報を表示 1。 |
| 停止ユーザー: セッション無効化 | 停止中ユーザーの既存セッションを無効化。マイページアクセス時にリダイレクト 1。 |
| OAuth: メニュー制御 | OAuth専用ユーザーのパスワード変更メニューが非表示であること 1。 |
| プロフィール編集: 異常系 | 画像サイズオーバーでエラー表示 1。 |
| 会員退会: 正常系 | 2段階確認を経て削除成功。キャラクターが匿名化されていることを確認 1。 |

#### **15\. 今後の拡張余地**

* SMS・認証アプリによる2段階認証（2FA）の実装。  
* Twitter / Facebook / Apple IDなど、ソーシャルログインの追加。  
* メールによるパスワード再設定（パスワードリセット）機能 1。

### **第2章: 02\_キャラクター管理**

本章では、AIチャットの核となる「キャラクター」の作成、編集、閲覧、および管理に関する仕様を定義します 1。

#### **1\. 画面概要**

* **機能名:** キャラクター管理  
* **対象画面:** キャラクター一覧、キャラクター作成、キャラクター編集、キャラクター詳細、自分のキャラクター管理  
* **技術スタック:** Next.js 15, TypeScript, Prisma, PostgreSQL, pgvector, AWS S3 / Supabase Storage 1  
* **分析:** pgvector 1 の採用は、本システムが単純なキーワード検索ではなく、AIによるセマンティック検索（意味検索）を前提としていることを示します。これは「ローブック（Lorebook）」機能と直結しており、AIがキャラクターの背景設定を文脈に応じて理解するために使用されます。

#### **2\. 前提・制約**

* 画像は複数枚アップロード可能（最大10枚、各画像5MBまで）1。  
* 編集・削除は作成者、または CHAR\_MANAGER 以上の権限を持つ管理者のみ可能です。  
* ローブックは pgvector でベクトル埋め込みされ、チャット時に自動検索されます 1。  
* 他プラットフォーム（例：他のキャラクターAIサービス）のキャラクターをJSON形式でインポートする機能をサポートします 1。

#### **3\. 関連URL・遷移**

* /charlist (キャラクター一覧ページ)  
* /characters/create (キャラクター作成ページ)  
* /characters/edit/\[id\] (キャラクター編集ページ)  
* /characters/\[characterId\] (キャラクター詳細ページ)  
* /character-management (自分のキャラクター管理ページ) 1

#### **4\. 役割・権限**

* **一般ユーザー:** 閲覧、お気に入り、コメント、自作キャラクターの作成・編集・削除が可能です。  
* **CHAR\_MANAGER:** 全てのキャラクター（他人のキャラクター含む）を編集・削除可能です 1。  
* **SUPER\_ADMIN:** 全てのキャラクター管理機能にアクセス可能です 1。

#### **5\. 主要機能一覧**

* **キャラクター作成:** 名前、説明、カテゴリー、ハッシュタグ、システムプロンプト、最初の台詞を設定します 1。  
* **画像アップロード:** drag\&drop対応、メイン画像とサブ画像の区別が可能です。  
* **公開/非公開設定:** 非公開キャラクターは作成者のみ閲覧可能です。  
* **ローブック管理:** AIの知識ベースとなる背景知識・設定を登録します。これが pgvector によるベクトル検索の対象となります 1。  
* **SNS機能:** お気に入り機能、コメント機能、星評価（1～5）機能 1。  
* **インポート機能:** JSON形式のキャラクターデータをインポートします。  
* **検索機能:** カテゴリー（ファンタジー、現代など）およびハッシュタグによるフィルタリングが可能です 1。

#### **6\. 画面構成（UIブロック）**

* **キャラクターカード (CharacterCard.tsx):** 一覧表示用の基本コンポーネント。画像、名前、説明抜粋、お気に入り数を表示 1。  
* **一覧グリッド:** レスポンシブ対応（PC: 4列、タブレット: 3列、モバイル: 2列）。  
* **キャラクター作成フォーム (CharacterForm.tsx):** 作成・編集で使用する共通フォーム 1。  
* **画像アップロードエリア:** プレビュー表示、メイン画像選択、画像削除ボタン。  
* **ローブックエディタ:** 複数のローブックエントリ（タイトル、内容）を追加・削除可能 1。  
* **キャラクター詳細タブ:** 「概要」「設定」「ローブック」「コメント」のタブで情報を切り替えます 1。  
* **自分のキャラクター一覧 (CharacterRow.tsx):** テーブル形式で表示。編集・削除ボタン、公開/非公開ステータスを表示 1。

#### **7\. 画面項目定義**

*本セクションは、キャラクター作成・管理の主要なデータ項目を定義します。*

| 項目名 | 型 | バリデーション / 制約 | 備考 |
| :---- | :---- | :---- | :---- |
| 【作成】キャラクター名 | string | 必須, 1〜100文字 | 1 |
| 【作成】説明 | string | 必須, 10〜1000文字 | 1 |
| 【作成】カテゴリー | string | 必須, 事前定義されたカテゴリーから選択 | ファンタジー / 現代 / SF / 恋愛 / ホラーなど 1 |
| 【作成】ハッシュタグ | string | 任意, 各タグ20文字以内, 最大10個 | カンマ区切り入力 1 |
| 【作成】システムプロンプト | string | 必須, 10〜2000文字 | キャラクターのAI設定 1 |
| 【作成】最初の台詞 | string | 任意, 1〜500文字 | チャット開始時の挨拶 1 |
| 【作成】画像 | file | 任意, jpg/jpeg/png/gif/webp, 各5MB, 最大10枚 | 1 |
| 【作成】公開設定 | boolean | 必須, true (公開) / false (非公開) | デフォルト: true 1 |
| 【ローブック】タイトル | string | 必須, 1〜200文字 | 1 |
| 【ローブック】内容 | string | 必須, 10〜5000文字 | ベクトル埋め込み対象 1 |
| 【コメント】コメント内容 | string | 必須, 1〜500文字 | 1 |
| 【コメント】評価 | number | 任意, 1〜5の整数 | 星評価 1 |

#### **8\. フィルタ仕様**

* **カテゴリーフィルター:** URLクエリパラメータ category で指定。複数選択可能です（カンマ区切り）1。  
* **ハッシュタグフィルター:** URLクエリパラメータ tags で指定。  
* **並び替え:** 作成日順（新しい/古い）、お気に入り数順、評価順でソート可能です 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/charlist | GET | { search?, category?, tags?, sort?, page, limit } | { characters:, total } | 高度なフィルタリング対応一覧API 1 |
| /api/characters | POST | { name, description,... } | { success, characterId } | キャラクター作成API 1 |
| /api/characters?mode=my | GET | { page, limit } | { characters: } | 自分のキャラクター一覧取得API 1 |
| /api/characters/\[id\] | GET | (URLパラメータ) | { character: {...} } | キャラクター詳細取得API 1 |
| /api/characters/\[id\] | PUT | { name, description,... } | { success } | キャラクター更新API 1 |
| /api/characters/\[id\] | DELETE | (URLパラメータ) | { success, message } | キャラクター削除API 1 |
| /api/characters/\[id\]/favorite | POST | (URLパラメータ) | { success, isFavorite } | お気に入り追加・削除API 1 |
| /api/characters/\[id\]/comments | GET | { page, limit } | { comments:, total } | コメント一覧取得API 1 |
| /api/characters/\[id\]/comments | POST | { content, rating } | { success, commentId } | コメント投稿API 1 |
| /api/characters/\[id\]/import | POST | { importData: JSON } | { success, characterId } | キャラクターインポートAPI 1 |

#### **10\. エラー・通知文言**

| 表示タイミング | 文言 |
| :---- | :---- |
| 名前未入力時 | キャラクター名は必須です。 1 |
| 説明が短すぎる時 | 説明は10文字以上入力してください。 1 |
| 画像サイズオーバー時 | 画像サイズは5MB以下にしてください。 1 |
| 画像枚数オーバー時 | 画像は最大10枚までアップロードできます。 1 |
| 他人のキャラクター編集時 | このキャラクターを編集する権限がありません。 1 |
| 削除ボタン押下時 | このキャラクターを削除してもよろしいですか？ 関連するチャットとコメントも削除されます。 1 |
| お気に入り追加時 | お気に入りに追加しました。 1 |

#### **11\. モーダル仕様**

* **キャラクター削除確認:** 削除ボタン押下時。関連データ（チャット、コメント）削除の警告を表示 1。  
* **画像プレビュー:** 画像クリック時。ライトボックスで拡大表示し、左右矢印で画像切り替え 1。  
* **ローブック追加:** ローブック追加ボタン押下時。タイトル・内容の入力フォーム 1。  
* **インポート:** インポートボタン押下時。JSON入力エリアとフォーマット説明 1。

#### **12\. 認証・ガード**

* キャラクター作成、編集、削除はログイン必須です。  
* 編集・削除は作成者本人、または CHAR\_MANAGER 以上の権限を持つ管理者のみ可能です。権限不足時はエラーメッセージを表示します 1。  
* 非公開に設定されたキャラクターは、作成者または管理者以外には404（Not Found）として扱われます 1。

#### **13\. 非機能要件**

* **パフォーマンス:** キャラクター一覧はページネーション（1ページ20件）に対応。画像はCDN配信 1。  
* **セキュリティ:** 画像アップロード時にウイルススキャンを実施。XSS対策としてコンテンツ（説明文、コメントなど）をサニタイズします 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| 画像アップロード: 異常系（サイズ） | 5MBを超える画像でエラー表示 1。 |
| 画像アップロード: 異常系（枚数） | 10枚を超える画像でエラー表示 1。 |
| キャラクター編集: 異常系 | 他人のキャラクター編集を試行し、権限エラーが表示されること 1。 |
| 公開/非公開: 制御確認 | 非公開キャラクターが他ユーザー（管理者除く）に表示されない（404）ことを確認 1。 |
| ローブック: AI連携確認 | ローブックに情報を追加後、チャットで関連する応答が返ってくることを確認 1。 |
| インポート: 機能確認 | JSON形式のキャラクターデータをインポートし、正しく反映されることを確認 1。 |

#### **15\. 今後の拡張余地**

* キャラクター画像をAIで自動生成する機能。  
* 有料キャラクターの販売・購入を可能にするキャラクターマーケットプレイス機能。  
* 複数ユーザーによるキャラクターの共同編集機能 1。

### **第3章: 03\_チャットシステム**

本章では、ユーザーとAIキャラクター間の対話を実現するチャットインターフェースの仕様を定義します 1。

#### **1\. 画面概要**

* **機能名:** チャットシステム  
* **対象画面:** チャットメインページ (/chat/\[characterId\])、チャット一覧ページ (/chatlist)  
* **技術スタック:** Google Gemini AI, pgvector 1  
* **分析:** 本システムはAIモデルとして Google Gemini 1 を採用しています。第2章 1 で定義された pgvector（ローブック検索）と連携し、キャラクターのシステムプロンプト、ユーザーのペルソナ（第5章 1）、およびローブックの知識を動的に組み合わせる、高度なRAG（Retrieval-Augmented Generation）アーキテクチャを採用しています。

#### **2\. 前提・制約**

* 画像送信は1メッセージにつき1枚、最大5MBに制限されます 1。  
* チャットメッセージ送信時にポイントを消費します（第6章 1 参照）。消費は無料ポイントが優先されます 1。  
* AIの応答は「バージョン管理」されます。再生成したメッセージは全バージョンが保持され、切り替え可能です 1。  
* AIが応答を生成する際のコンテキストとして、最新100メッセージを使用します 1。

#### **3\. 関連URL・遷移**

* /chat/\[characterId\] (チャットメインページ)  
* /chatlist (チャット一覧ページ) 1

#### **4\. 役割・権限**

* **一般ユーザー:** 自分のチャットのみ閲覧・削除可能です。  
* **停止ユーザー:** チャット機能へのアクセスが不可となります 1。

#### **5\. 主要機能一覧**

* **メッセージ送受信:** テキストおよび画像の送信に対応。AIは画像も認識して応答します 1。  
* **AI応答生成:** Google Gemini AIを使用。システムプロンプト、ローブック、ペルソナを考慮します。  
* **メッセージ再生成:** AIの応答を再生成する機能。  
* **バージョン切り替え:** 再生成された過去の応答を \<2/4\> のようなバージョン番号と ◀▶ ボタンで閲覧する機能 1。  
* **メッセージ削除:**  
  * ユーザーメッセージ削除時: そのターンの全ての応答（AIの返信）も一括で削除されます。  
  * AIメッセージ削除時: 特定のバージョンのみ削除されます 1。  
* **初期状況表示:** チャット開始時の初期状況メッセージ（キャラクターの最初の台詞）を常時表示します 1。  
* **チャットノート:** チャットに関するメモ（プロットや重要情報）を記録します。  
* **チャット設定:** システムプロンプトのカスタマイズ、ペルソナ選択、セーフティフィルター設定。  
* **チャット一覧:** 検索機能、および複数チャットの選択一括削除機能 1。

#### **6\. 画面構成（UIブロック）**

* **チャットヘッダー (ChatHeader.tsx):** キャラクター情報、チャット設定ボタン、メニュー（削除・ノート）1。  
* **初期状況メッセージ:** チャット上部に常時表示される、キャラクターの最初の台詞 1。  
* **メッセージバブル（AI）:** 左側に表示。再生成ボタン、削除ボタン、バージョン切り替えボタン（◀▶）が配置されます 1。  
* **ローディングインジケーター:** AI応答生成中に「応答生成中...」というメッセージと回転アイコンを表示します 1。  
* **チャットフッター (ChatFooter.tsx):** メッセージ入力欄。Enterで送信、Shift+Enterで改行に対応します 1。  
* **チャット設定モーダル (ChatSettings.tsx):** プロンプトのカスタマイズ、ペルソナ選択、セーフティフィルター設定 1。  
* **画像ライトボックス (ImageLightbox.tsx):** チャット内の画像クリックで拡大表示 1。

#### **7\. 画面項目定義**

*本セクションは、チャットおよび関連設定の主要なデータ項目を定義します。*

| 項目名 | 型 | バリデーション / 制約 | 備考 |
| :---- | :---- | :---- | :---- |
| 【チャット】メッセージ内容 | string | 必須, 1〜2000文字 | テキストエリア 1 |
| 【チャット】画像 | file | 任意, jpg/jpeg/png/gif/webp, 最大5MB, 1枚 | 1 |
| 【設定】システムプロンプト | string | 任意, 最大2000文字 | キャラクターのデフォルトプロンプトに追加 1 |
| 【設定】ペルソナ | number | 任意 | ユーザーのペルソナID（第5章 1）を選択 1 |
| 【設定】セーフティフィルター | boolean | 必須, true / false | オン/オフ切り替え 1 |
| 【ノート】ノート内容 | string | 任意, 最大5000文字 | テキストエリア 1 |

#### **8\. フィルタ仕様**

* **セーフティフィルター:** ユーザー設定に基づき、AI応答生成時に不適切なコンテンツをフィルタリングします 1。  
* **ローブック検索:** メッセージ送信時、pgvector を使用してローブックをベクトル検索。関連度が高い上位3件をコンテキストに追加します 1。  
* **コンテキスト管理:** 最新100メッセージをコンテキストとして使用し、それ以前は要約して使用します 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/chat/new | POST | { characterId, note? } | { success, chatId } | 新規チャット作成API 1 |
| /api/chat/\[chatId\] | GET | (URLパラメータ) | { chat: {...} } | チャット情報取得API 1 |
| /api/chat/\[chatId\] | DELETE | (URLパラメータ) | { success, message } | チャット削除API 1 |
| /api/chat/\[chatId\]/note | PUT | { note: string } | { success } | チャットノート更新API 1 |
| /api/chat/messages | GET | { chatId, limit?, offset? } | { messages:, total } | チャットメッセージ一覧取得API 1 |
| /api/chat/messages | POST | { chatId, content, image?,... } | { success, message: {...} } | メッセージ送信API（AI応答）1 |
| /api/chat/messages/\[messageId\] | DELETE | (URLパラメータ) | { success } | メッセージ削除API 1 |
| /api/chat/messages/\[messageId\]/regenerate | POST | { currentVersion } | { success, message: {...} } | メッセージ再生成API 1 |
| /api/chats/find-or-create | POST | { characterId } | { chatId, isNew } | チャット検索または作成API 1 |
| /api/chatlist | GET | { search?, page?, limit? } | { chats:, total } | チャット一覧取得API（検索付）1 |

#### **10\. エラー・通知文言**

| 表示タイミング | 文言 |
| :---- | :---- |
| メッセージ送信失敗時 | メッセージを送信できませんでした。もう一度お試しください。 1 |
| ポイント不足時 | ポイントが不足しています。ポイントをチャージしてください。 1 |
| 画像サイズオーバー時 | 画像サイズは5MB以下にしてください。 1 |
| AI応答生成失敗時 | AI応答の生成に失敗しました。もう一度お試しください。 1 |
| ユーザーメッセージ削除時 | このメッセージを削除してもよろしいですか？ このターンの全ての応答も削除されます。 1 |
| AIメッセージ削除時 | このバージョンのメッセージを削除してもよろしいですか？ 1 |
| チャット削除時 | このチャットを削除してもよろしいですか？ 全てのメッセージとノートも削除されます。 1 |
| AI応答生成中 | 応答生成中... 1 |

#### **11\. モーダル仕様**

* **チャット設定モーダル:** チャット設定ボタン押下時。プロンプトカスタマイズ、ペルソナ選択、セーフティフィルター設定 1。  
* **チャットノートモーダル:** ノートボタン押下時。メモ入力用テキストエリア 1。  
* **画像ライトボックス:** 画像クリック時。拡大表示 1。  
* **メッセージ削除確認:** 削除ボタン押下時。削除対象（ユーザーメッセージかAIバージョンか）に応じた警告を表示 1。

#### **12\. 認証・ガード**

* チャット機能はログイン必須です。  
* チャットは作成者のみ閲覧・編集・削除可能です。他ユーザーのチャットにアクセスすると404表示となります 1。  
* メッセージ送信前にポイント残高（第6章 1）を確認し、不足時はエラーメッセージを表示します 1。  
* 停止中ユーザーはチャット機能にアクセスできません 1。

#### **13\. 非機能要件**

* **パフォーマンス:** メッセージはページネーション対応（初回50件、以降25件ずつ読み込み）1。  
* **セキュリティ:** メッセージ内容はXSS対策としてサニタイズします。画像アップロードはウイルススキャンを行います 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| メッセージ送信: 異常系 | ポイント不足でエラー表示 1。 |
| メッセージ再生成: 正常系 | 再生成ボタンで新しいバージョンが生成され、全バージョンが保持されることを確認 1。 |
| バージョン切り替え: 操作確認 | ◀▶ ボタンで過去バージョンを閲覧できること。バージョン番号表示を確認 1。 |
| メッセージ削除: ユーザー | ユーザーメッセージ削除時に、後続のAI応答も全て削除されることを確認 1。 |
| メッセージ削除: AI | AIメッセージ削除時に、特定バージョンのみ削除されることを確認 1。 |
| 初期状況表示: 常時表示 | チャット入力後も初期状況メッセージが消えないことを確認 1。 |
| チャット設定: AI反映 | システムプロンプトのカスタマイズがAI応答に反映されることを確認 1。 |
| ローブック検索: AI連携 | メッセージ送信時にローブックが自動検索され、応答に反映されることを確認 1。 |

#### **15\. 今後の拡張余地**

* 音声入力・音声出力による音声チャット機能。  
* チャットを他ユーザーと共有する機能。  
* チャット履歴のPDFやテキスト形式でのエクスポート機能。  
* 複数のキャラクターと同時にチャットするマルチキャラクターチャット機能 1。

### **第4章: 04\_ソーシャル機能**

本章では、ユーザー間のインタラクション（フォロー、ブロック）に関する仕様を定義します 1。

#### **1\. 画面概要**

* **機能名:** ソーシャル機能  
* **対象画面:** ユーザープロフィール閲覧ページ (/profile/\[userId\])、フォロワー一覧、フォロイング一覧、ブロックリスト 1

#### **2\. 前提/制約**

* ブロックリストは本人のみ閲覧可能です。  
* **ブロック制限:** ブロックしたユーザーとは、相互にプロフィール閲覧が不可（404表示）となります。また、フォロー、コメント、チャットも相互に不可となります 1。  
* フォローは一方向性です（相互フォローも可能）1。

#### **3\. 関連URL・遷移**

* /profile/\[userId\] (ユーザープロフィール閲覧ページ)  
* **遷移フロー:** ユーザー検索 → プロフィール閲覧 → フォロー or ブロック 1

#### **4\. 役割・権限**

* **一般ユーザー:** 他ユーザーをフォロー、アンフォロー、ブロック、ブロック解除できます。  
* **ブロックされたユーザー:** ブロックしたユーザーのプロフィール閲覧が不可となります 1。

#### **5\. 主要機能一覧**

* フォロー、アンフォロー。  
* フォロワー/フォロイング一覧の閲覧。  
* ブロック、ブロック解除。  
* ブロックリスト閲覧（本人のみ）。  
* プロフィール閲覧時、そのユーザーが作成した「公開」キャラクターの一覧を表示します（非公開キャラクターは表示しません）1。

#### **6\. 画面構成（UIブロック）**

* **プロフィールヘッダー:** ユーザー画像、ニックネーム、自己紹介、フォロー数、フォロワー数を表示。  
* **フォローボタン:** フォロー/アンフォローを切り替えるトグルボタン（本人の場合は非表示）。  
* **ブロックボタン:** ブロック/ブロック解除を切り替えるトグルボタン（本人の場合は非表示、確認ダイアログ付き）。  
* **作成キャラクター一覧:** 公開キャラクターのみをカードグリッドで表示 1。  
* **一覧:** フォロワー一覧、フォロイング一覧、ブロックリストはユーザーカードをリスト形式で表示 1。

#### **7\. 画面項目定義**

*本セクションは、プロフィール表示の主要なデータ項目を定義します。*

| 項目名 | 型 | 必須 | バリデーション | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| ユーザーID | string | 必須 | URLパラメータ | 1 |
| ニックネーム | string | 必須 | 1〜50文字 | 1 |
| プロフィール画像 | string | 任意 | 画像URL | 1 |
| 自己紹介 | string | 任意 | 最大500文字 | 1 |
| フォロー数 | number | 必須 | 0以上 | 1 |
| フォロワー数 | number | 必須 | 0以上 | 1 |

#### **8\. フィルタ仕様**

* **ブロックフィルター:** ブロックした/されたユーザーのプロフィールにアクセスした場合、404（Not Found）を表示します 1。  
* **公開設定フィルター:** プロフィール上の作成キャラクター一覧には、公開設定のキャラクターのみ表示します 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/profile/\[userId\] | GET | パスなし | { user: {...}, isFollowing, isBlocked } | ユーザープロフィール取得API 1 |
| /api/profile/\[userId\]/follow | POST | パスなし | { success, isFollowing } | フォロー/アンフォローAPI（トグル）1 |
| /api/profile/\[userId\]/followers | GET | { page?, limit? } | { followers:, total } | フォロワー一覧取得API 1 |
| /api/profile/\[userId\]/following | GET | { page?, limit? } | { following:, total } | フォロイング一覧取得API 1 |
| /api/profile/\[userId\]/block | POST | パスなし | { success, isBlocked } | ブロック/ブロック解除API（トグル）1 |
| /api/profile/\[userId\]/blocked-users | GET | { page?, limit? } | { blockedUsers:, total } | ブロックリスト取得API（本人のみ）1 |

#### **10\. エラー・通知文言**

| エラータイプ | 文言 | 表示タイミング |
| :---- | :---- | :---- |
| ブロックエラー | このユーザーのプロフィールは閲覧できません。 | ブロックされた/したユーザーのプロフィールアクセス時 1 |
| 権限エラー | ブロックリストは本人のみ閲覧できます。 | 他ユーザーのブロックリストアクセス時 1 |
| ブロック確認 | このユーザーをブロックしてもよろしいですか？相互にプロフィール閲覧・コメント・チャットができなくなります。 | ブロックボタン押下時 1 |
| 成功メッセージ | フォローしました。 / フォローを解除しました。 | フォロー/アンフォロー成功時 1 |

#### **11\. モーダル仕様**

* **ブロック確認モーダル:** ブロックボタン押下時。ブロックによる影響（相互閲覧不可など）を説明 1。  
* **フォロワー/フォロイング一覧モーダル:** フォロー数/フォロワー数クリック時。一覧をモーダルで表示 1。

#### **12\. 認証・ガード**

* ソーシャル機能（フォロー、ブロックなど）はログイン必須です。  
* ブロックリストは本人のみ閲覧可能です（他ユーザーは404）。  
* ブロックした/されたユーザーのプロフィールアクセスは404とします 1。

#### **13\. 非機能要件**

* **パフォーマンス:** フォロー・フォロワー数はキャッシュを利用します。フォロー・ブロック操作は非同期処理で行います 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| ブロック: 正常系 | ブロックボタンでブロック成功。その後、相互にプロフィールが閲覧不可（404）になることを確認 1。 |
| ブロック解除: 正常系 | ブロック解除ボタンで解除成功。再度プロフィールが閲覧可能になることを確認 1。 |
| ブロックリスト: 権限 | 本人のブロックリストは閲覧可能。他ユーザーのブロックリストにアクセスすると404になることを確認 1。 |
| 作成キャラクター一覧 | 公開キャラクターのみ表示され、非公開キャラクターは表示されないことを確認 1。 |

#### **15\. 今後の拡張余地**

* 特定ユーザーの投稿を非表示にするミュート機能。  
* プライベートアカウントに対するフォローリクエスト機能。  
* フォローされた時の通知機能 1。

### **第5章: 05\_ペルソナシステム**

本章では、ユーザーがAI（Gemini）との対話時に使用する「自分自身のペルソナ」を設定する機能について定義します 1。これはAIキャラクターのC設定ではなく、ユーザー側の設定です。

#### **1\. 画面概要**

* **機能名:** ペルソナシステム  
* **対象画面:** ペルソナ一覧ページ (/persona/list)、ペルソナ作成/編集ページ (/persona/form/\[\[...personaId\]\]) 1

#### **2\. 前提/制約**

* 本機能は、第3章 1 のチャットシステムと連携します。  
* ユーザーは1つのペルソナを「デフォルト」に設定可能で、チャット開始時に自動適用されます 1。  
* ペルソナ作成数に制限はありません（ただし実用的には10個程度を推奨）1。

#### **3\. 関連URL・遷移**

* /persona/list (ペルソナ一覧ページ)  
* /persona/form (ペルソナ作成ページ)  
* /persona/form/\[personaId\] (ペルソナ編集ページ) 1

#### **4\. 役割・権限**

* **一般ユーザー:** 自分のペルソナのみ作成・編集・削除可能です 1。

#### **5\. 主要機能一覧**

* **ペルソナ作成:** 名前、説明、性格、口調、背景、その他のメモを設定して新規ペルソナを作成します。  
* **ペルソナ編集:** 既存ペルソナの情報を編集します。  
* **ペルソナ削除:** ペルソナを削除します（確認ダイアログ付き）。  
* **デフォルトペルソナ設定:** 1つのペルソナをデフォルトに設定します。  
* **チャット時のペルソナ適用:** チャット開始時（またはチャット設定モーダル 1）でペルソナを選択し、AI応答に反映させます 1。

#### **6\. 画面構成（UIブロック）**

* **ペルソナ一覧テーブル:** ペルソナ名、説明（抜粋）、編集/削除ボタン。  
* **デフォルトバッジ:** デフォルトペルソナに「デフォルト」バッジを表示します 1。  
* **ペルソナ作成フォーム:** 各項目（性格、口調、背景など）の入力欄。デフォルトに設定するチェックボックス 1。

#### **7\. 画面項目定義**

*本セクションは、ペルソナ設定の主要なデータ項目を定義します。*

| 項目名 | 型 | 必須 | バリデーション | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| ペルソナ名 | string | 必須 | 1〜100文字 | 1 |
| 説明 | string | 任意 | 最大500文字 | ペルソナの簡単な説明 1 |
| 性格 | string | 任意 | 最大1000文字 | 性格設定（例：明るい、内向的）1 |
| 口調 | string | 任意 | 最大500文字 | 話し方の特徴（例：丁寧語、タメ口）1 |
| 背景 | string | 任意 | 最大1000文字 | 背景設定（例：職業、趣味）1 |
| デフォルト設定 | boolean | 任意 | true/false | 1 |

#### **8\. フィルタ仕様**

* **デフォルトフィルター:** デフォルトペルソナを一覧の最上部に表示します 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/persona | GET | クエリなし | { personas: } | ペルソナ一覧取得API（ログインユーザーのみ）1 |
| /api/persona | POST | { name, description,... } | { success, personaId } | ペルソナ作成API 1 |
| /api/persona/\[personaId\] | GET | パスなし | { persona: {...} } | ペルソナ詳細取得API 1 |
| /api/persona/\[personaId\] | PUT | { name, description,... } | { success } | ペルソナ更新API 1 |
| /api/persona/\[personaId\] | DELETE | パスなし | { success, message } | ペルソナ削除API 1 |

#### **10\. エラー・通知文言**

| エラータイプ | 文言 | 表示タイミング |
| :---- | :---- | :---- |
| 作成エラー | ペルソナ名は必須です。 | 名前未入力時 1 |
| 削除確認 | このペルソナを削除してもよろしいですか？ | 削除ボタン押下時 1 |
| デフォルトペルソナ削除警告 | このペルソナはデフォルトに設定されています。削除してもよろしいですか？ | デフォルトペルソナ削除時 1 |
| 成功メッセージ | ペルソナを作成しました。 | 作成成功時 1 |

#### **11\. モーダル仕様**

* **ペルソナ削除確認:** 削除ボタン押下時。デフォルトペルソナの場合は警告メッセージを追加します 1。

#### **12\. 認証・ガード**

* ペルソナ機能はログイン必須です。  
* ペルソナは作成者のみ閲覧・編集・削除可能です。他ユーザーのペルソナIDにアクセスすると404表示となります 1。

#### **13\. 非機能要件**

* **セキュリティ:** ペルソナ情報は他ユーザーに非公開とし、APIアクセスを制限します 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| デフォルトペルソナ設定 | デフォルトペルソナ設定後に、一覧でバッジが表示されることを確認 1。 |
| チャット適用 (自動) | チャット開始時にデフォルトペルソナが自動選択されることを確認 1。 |
| チャット適用 (AI反映) | チャット設定で選択したペルソナの設定（例：口調）がAI応答に反映されることを確認 1。 |

#### **15\. 今後の拡張余地**

* よく使われるペルソナのテンプレートを提供。  
* ペルソナを他ユーザーと共有する機能。  
* ペルソナに画像を設定する機能 1。

### **第6章: 06\_ポイントシステム**

本章では、サービス内の有料機能（チャット送信など）を制御するためのポイントシステムについて定義します 1。

#### **1\. 画面概要**

* **機能名:** ポイントシステム  
* **対象画面:** ポイント管理ページ (/points) 1

#### **2\. 前提/制約**

* **ポイント種類:** 「無料ポイント」と「有料ポイント」を分離して管理します 1。  
* **消費優先順位:** ポイント消費時（例：チャット送信）は、「無料ポイント」から優先的に消費されます 1。  
* **出席チェック:** 1日1回の出席チェックで無料ポイントを獲得できます 1。  
* **ポイント消費:** チャットメッセージ送信時に10ポイントを消費します 1。

#### **3\. 関連URL・遷移**

* /points (ポイント管理ページ)  
* **遷移フロー:** マイページ → ポイント管理 → 出席チェック or ポイント購入 1

#### **4\. 役割・権限**

* **一般ユーザー:** ポイント閲覧、出席チェック、ポイント購入（将来実装）が可能です。  
* **管理者:** ユーザーのポイントを手動で増減可能です（第8章 1 参照）。

#### **5\. 主要機能一覧**

* **ポイント残高表示:** 無料ポイント、有料ポイント、合計ポイントを表示します。  
* **出席チェック:** 1日1回クリックで無料ポイントを獲得。連続出席ボーナス（例：7日連続で100ポイント、30日連続で500ポイント）があります 1。  
* **ポイント履歴閲覧:** ポイントの獲得・消費履歴（日時、種類、変動量、残高）を一覧表示します。  
* **ポイント消費:** チャットメッセージ送信時に自動的にポイントを消費します（無料ポイント優先）1。

#### **6\. 画面構成（UIブロック）**

* **ポイント残高カード:** 無料/有料/合計ポイントを大きく表示。  
* **出席チェックボタン:** 1日1回クリック可能。出席済みの場合は「出席済み」として無効化されます。連続出席日数も表示します 1。  
* **ポイント履歴テーブル:** 日時、種類（獲得/消費）、変動量、残高を表示。ページネーションに対応します 1。

#### **7\. 画面項目定義**

*本セクションは、ポイント履歴の主要なデータ項目を定義します。*

| 項目名 | 型 | 必須 | バリデーション | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| 日時 | datetime | 必須 | ISO 8601形式 | 1 |
| 種類 | string | 必須 | 獲得 / 消費 | 1 |
| 変動量 | number | 必須 | 正数（獲得）または負数（消費） | 1 |
| 残高 | number | 必須 | 0以上 | 取引後の残高 1 |
| 説明 | string | 任意 | 最大200文字 | 出席チェック、チャット使用など 1 |

#### **8\. フィルタ仕様**

* **ポイント消費優先順位:** 消費時は無料ポイント優先。無料ポイントが不足する場合は有料ポイントを消費します 1。  
* **出席チェック制限:** 1日1回のみ。前回の出席チェックから24時間経過後に再度可能となります 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/points | GET | クエリなし | { freePoints, paidPoints, totalPoints, checkInStreak } | ポイント情報取得API 1 |
| /api/points | POST | { type: 'check-in' } | { success, points, streak } | 出席チェックAPI 1 |
| /api/users/points | GET | クエリなし | { points: {...}, history: } | ユーザーポイント情報取得API（履歴含む）1 |

#### **10\. エラー・通知文言**

| エラータイプ | 文言 | 表示タイミング |
| :---- | :---- | :---- |
| 出席チェックエラー | 今日は既に出席チェックを行いました。明日またお越しください。 | 24時間以内の再出席チェック時 1 |
| ポイント不足エラー | ポイントが不足しています。ポイントをチャージしてください。 | ポイント不足時（例：チャット送信時 1）1 |
| 成功メッセージ | 出席チェック完了！{points}ポイントを獲得しました。 | 出席チェック成功時 1 |
| ボーナスメッセージ | {days}日連続出席達成！ボーナス{points}ポイントを獲得しました。 | 連続出席ボーナス獲得時 1 |

#### **11\. モーダル仕様**

* **出席チェック完了:** 出席チェック成功時。獲得ポイントと連続出席日数を表示 1。  
* **ポイント不足警告:** ポイント不足時。ポイント購入ページへのリンクを案内 1。

#### **12\. 認証・ガード**

* ポイント機能はログイン必須です 1。

#### **13\. 非機能要件**

* **スケーラビリティ:** ポイント消費はトランザクション処理を行い、同時実行制御（RACE CONDITION対策）を行います 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| 出席チェック: 異常系 | 24時間以内の再出席チェックでエラーが表示されることを確認 1。 |
| 連続出席ボーナス | 7日連続出席で100ポイント、30日連続出席で500ポイントのボーナスが獲得されることを確認 1。 |
| ポイント消費 (優先順位) | チャットメッセージ送信時に、無料ポイントが優先的に消費されることを確認 1。 |
| ポイント消費 (混合) | 無料ポイントが不足している場合、残りの無料ポイントを全て消費した後、有料ポイントが消費されることを確認 1。 |
| ポイント履歴 | ポイントの獲得・消費履歴が正確に記録され、残高が一致することを確認 1。 |

#### **15\. 今後の拡張余地**

* 決済システム（クレジットカード、PayPalなど）と連携した有料ポイント購入機能。  
* 他ユーザーにポイントを贈るポイントギフト機能。  
* 特定のタスク（例：プロフィール設定完了）を完了してポイントを獲得するミッション機能 1。

### **第7章: 07\_検索及びランキング**

本章では、ユーザーがキャラクターを発見するための検索機能およびランキング機能について定義します 1。

#### **1\. 画面概要**

* **機能名:** 検索及びランキング  
* **対象画面:** 検索ページ (/search)、ランキングページ (/ranking)、メインページ (/)  
* **技術スタック:** pgvector 1

#### **2\. 前提/制約**

* **検索対象:** キャラクター名、説明、ハッシュタグ（部分一致検索）。  
* **ベクトル検索:** pgvector を利用し、キャラクター説明のベクトル埋め込みを使用した意味検索（セマンティック検索）もサポートします 1。  
* **ランキング更新:** ランキングは1時間ごとに更新され、Redis等でキャッシュされます 1。  
* **人気度計算:** 人気度は「(お気に入り数 × 3\) \+ (チャット数 × 2\) \+ (コメント数 × 1)」の重み付けで計算されます 1。

#### **3\. 関連URL・遷移**

* /search (検索ページ)  
* /ranking (ランキングページ)  
* / (メインページ) 1

#### **4\. 役割・権限**

* **全ユーザー:** 検索・ランキング機能は未ログインでも閲覧可能です。  
* **ログインユーザー:** パーソナライズされた推薦が表示されます 1。

#### **5\. 主要機能一覧**

* **キーワード検索:** 部分一致検索。  
* **意味検索:** pgvector を使用したベクトル検索。  
* **フィルター:** カテゴリー（複数選択可）、ハッシュタグ（複数選択可）。  
* **ランキング:** 人気ランキング、新規ランキング、カテゴリー別ランキング。  
* **トレンド表示:** 24時間以内にお気に入り・チャットが急増したキャラクターを「トレンド」として表示します 1。  
* **パーソナライズ推薦:** ログインユーザーの過去のチャットやお気に入りを分析し、メインページ（/）で推薦キャラクターを表示します 1。  
* **並び替え:** 人気順、新しい順、古い順、お気に入り数順 1。

#### **6\. 画面構成（UIブロック）**

* **検索バー:** キーワード入力欄。リアルタイム検索候補表示（オートコンプリート）1。  
* **フィルターサイドバー:** カテゴリー、ハッシュタグ、並び替えオプション。  
* **検索結果グリッド:** キャラクターカードをグリッド表示（ページネーション付き）。  
* **ランキングリスト:** 順位、キャラクター情報、人気度を表示（1位～100位）。  
* **トレンドセクション:** メインページ（/）に横スクロールで表示。「トレンド」バッジ付き 1。  
* **推薦セクション:** メインページ（/）に「あなたへのおすすめ」として表示 1。

#### **7\. 画面項目定義**

*本セクションは、検索およびランキングAPIの主要なパラメータを定義します。*

| 項目名 | 型 | 必須/任意 | バリデーション | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| 検索キーワード (q) | string | 任意 | 最大100文字 | 1 |
| カテゴリー (category) | string | 任意 | 事前定義されたカテゴリーから選択 | 1 |
| ハッシュタグ (tags) | string | 任意 |  | 1 |
| 並び替え (sort) | string | 任意 | popularity / newest / oldest / favorites | デフォルト: popularity 1 |
| ランキング種類 (type) | string | 必須 | popular / new / category | 1 |
| 期間 (period) | string | 任意 | daily / weekly / monthly / all-time | デフォルト: all-time 1 |

#### **8\. フィルタ仕様**

* **検索フィルター:** キーワード、カテゴリー、ハッシュタグをAND条件で組み合わせてフィルタリングします 1。  
* **人気度計算式:** (お気に入り数 × 3\) \+ (チャット数 × 2\) \+ (コメント数 × 1\) 1。  
* **トレンド判定:** 24時間以内のお気に入り・チャット増加率が上位10%のキャラクターをトレンドと判定します 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/search | GET | { q, category?, tags?, sort?, page, limit } | { characters:, total, page, totalPages } | キャラクター検索API 1 |
| /api/ranking | GET | { type, category?, period?, limit } | { characters:, rankings: } | ランキング取得API 1 |
| /api/main-page | GET | クエリなし | { trending:, popular:, newest:, recommended: } | メインページデータ取得API 1 |

#### **10\. エラー・通知文言**

| エラータイプ | 文言 | 表示タイミング |
| :---- | :---- | :---- |
| 検索結果なし | 検索結果が見つかりませんでした。別のキーワードで検索してください。 | 検索結果0件時 1 |
| エラー | 検索に失敗しました。もう一度お試しください。 | 検索API失敗時 1 |

#### **11\. モーダル仕様**

* **フィルター詳細:** モバイル表示時、フィルターボタン押下でカテゴリー、ハッシュタグ、並び替えオプションをモーダル表示 1。

#### **12\. 認証・ガード**

* 検索およびランキング機能は未ログインでも閲覧可能です。  
* パーソナライズ推薦（「あなたへのおすすめ」）のみ、ログインユーザーに表示されます。未ログインユーザーには人気キャラクターを表示します 1。

#### **13\. 非機能要件**

* **パフォーマンス:** 検索結果・ランキングはキャッシュ（例：Redis）を使用し、1時間ごとに更新します。ページネーションに対応します 1。  
* **スケーラビリティ:** pgvector によるベクトル検索はインデックスを最適化し、大量データに対応します 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| 人気ランキング | 人気度計算式 (お気に入り\*3) \+ (チャット\*2) \+ (コメント\*1) に基づいて、ランキングが正しく表示されることを確認 1。 |
| トレンド表示 | 24時間以内の急増キャラクターがトレンドとして表示されることを確認 1。 |
| パーソナライズ推薦 (ログイン) | ログインユーザーの過去データ（チャット、お気に入り）に基づいて、推薦が表示されることを確認 1。 |
| パーソナライズ推薦 (未ログイン) | 未ログインユーザーには推薦セクションの代わりに人気キャラクターが表示されることを確認 1。 |
| 検索結果なし | 検索結果が0件の場合に「検索結果が見つかりませんでした。」のメッセージが表示されること 1。 |

#### **15\. 今後の拡張余地**

* 音声入力による検索機能。  
* 画像をアップロードして類似のキャラクターを検索する機能。  
* キャラクターだけでなく、ユーザー（作成者）も検索可能にする機能 1。

### **第8章: 08\_管理者機能**

本章では、MODERATOR 以上の権限を持つユーザーが使用する管理機能について定義します 1。

#### **1\. 画面概要**

* **機能名:** 管理者機能  
* **対象画面:** 管理者ダッシュボード (/admin)、ユーザー管理 (/admin/users)、キャラクター管理 (/admin/characters)、ガイド管理 (/admin/guides) 1

#### **2\. 前提/制約**

* **権限要件:** 管理者ページへのアクセスは MODERATOR 以上の権限が必要です 1。  
* **ユーザー停止:** ユーザーを停止する際は、停止期間（1日、3日、7日、1ヶ月、3ヶ月、100日、1年、永久停止から選択）と停止理由（必須入力）を指定します 1。  
* **ポイント管理:** 管理者が手動でユーザーの無料ポイント・有料ポイントを設定（増減）可能です 1。  
* **ユーザー削除:** 削除時、作成したキャラクターは匿名化して保持されます 1。

#### **3\. 関連URL・遷移**

* /admin (管理者ダッシュボード)  
* /admin/users (ユーザー管理ページ)  
* /admin/characters (キャラクター管理ページ)  
* /admin/guides (ガイド管理ページ) 1

#### **4\. 役割・権限**

* **SUPER\_ADMIN:** 全ての管理者機能にアクセス可能（ユーザー権限変更、停止、削除、ポイント管理など）1。  
* **CHAR\_MANAGER:** キャラクター管理機能にアクセス可能（他人のキャラクター承認、編集、削除）1。  
* **MODERATOR:** ユーザー管理機能（ユーザー停止）およびガイド管理機能にアクセス可能 1。  
* **USER:** 管理者機能にアクセス不可 1。

#### **5\. 主要機能一覧**

* **ユーザー管理:** 全ユーザー一覧、検索（ニックネーム、メール）、権限変更（ドロップダウンで選択）、ユーザー停止・停止解除、ユーザー情報編集 1。  
* **ポイント手動管理:** ユーザー編集モーダル内にて、無料ポイント・有料ポイントを手動で設定 1。  
* **ユーザー削除:** ユーザーを完全削除（キャラクターは匿名化）。  
* **キャラクター管理:** 全キャラクター一覧、承認（将来実装）、編集、削除（管理者権限）1。  
* **ガイド管理:** ガイド一覧、作成、編集、削除（第9章 1 と連携）1。  
* **統計情報表示:** ダッシュボードにユーザー数、キャラクター数、チャット数、ポイント消費量などの統計を表示 1。

#### **6\. 画面構成（UIブロック）**

* **管理者ダッシュボード:** 統計カード（ユーザー数、キャラクター数など）を4列で表示。  
* **ユーザー一覧テーブル:** ニックネーム、メール、権限、停止状態を表示。  
  * **停止バッジ:** 停止中ユーザーに「停止中」（赤）、正常ユーザーに「正常」（緑）バッジを表示。  
  * **権限ドロップダウン:** ユーザーの権限（USER, MODERATOR,...）を変更するドロップダウン。変更後は自動保存 1。  
* **ユーザー停止モーダル:** 停止期間選択（ドロップダウン）、停止理由入力（テキストエリア）、停止ボタン 1。  
* **ユーザー編集モーダル:** 名前、ニックネーム、メール、権限などの編集フォーム。**ポイント管理欄**（無料/有料ポイントの入力欄）を含む 1。  
* **キャラクター一覧テーブル:** 名前、作成者、カテゴリー、公開/非公開、アクションボタン 1。  
* **ガイド作成フォーム:** タイトル、内容（マークダウン）、メイン/サブカテゴリー入力欄 1。

#### **7\. 画面項目定義**

*本セクションは、管理者機能の主要なデータ項目を定義します。*

| 項目名 | 型 | 必須/任意 | バリデーション | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| 権限 (ユーザー管理) | string | 必須 | USER/MODERATOR/CHAR\_MANAGER/SUPER\_ADMIN | ドロップダウン 1 |
| 停止期間 (ユーザー管理) | string | 任意 | 1日/3日/7日/1ヶ月/3ヶ月/100日/1年/永久停止 | ドロップダウン 1 |
| 停止理由 (ユーザー管理) | string | 停止時必須 | 1〜500文字 | テキストエリア 1 |
| 無料ポイント (ユーザー管理) | number | 任意 | 0以上 | 手動設定 1 |
| 有料ポイント (ユーザー管理) | number | 任意 | 0以上 | 手動設定 1 |
| 内容 (ガイド管理) | string | 必須 | 10〜10000文字 | マークダウン対応 1 |

#### **8\. フィルタ仕様**

* **ユーザーフィルター:** 権限（Role）、停止状態（Suspended）でフィルタリング可能 1。  
* **キャラクターフィルター:** 公開/非公開、カテゴリーでフィルタリング可能 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/admin/users | GET | { search?, role?, page, limit } | { users:, total } | ユーザー一覧取得API 1 |
| /api/admin/users | PUT | { userId, role } | { success } | ユーザー権限変更API 1 |
| /api/admin/users/suspend | POST | { userId, duration, reason } | { success, suspendedUntil } | ユーザー停止API 1 |
| /api/admin/users/suspend | DELETE | { userId } | { success } | ユーザー停止解除API 1 |
| /api/admin/users/edit | PUT | { userId, name, nickname,..., freePoints, paidPoints } | { success } | ユーザー情報編集・ポイント管理API 1 |
| /api/admin/users/delete | DELETE | { userId } | { success, message } | ユーザー削除API 1 |
| /api/admin/characters | GET | { page, limit } | { characters:, total } | キャラクター一覧取得API (管理者用) 1 |
| /api/admin/characters | DELETE | { characterId } | { success } | キャラクター削除API (管理者用) 1 |
| /api/admin/guides | POST | { title, content,... } | { success, guideId } | ガイド作成API 1 |

#### **10\. エラー・通知文言**

| エラータイプ | 文言 | 表示タイミング |
| :---- | :---- | :---- |
| 権限エラー | この操作を実行する権限がありません。 | 権限不足時（例：MODERATORが権限変更を試みた時）1 |
| 停止エラー | 停止理由は必須です。 | 停止理由未入力時 1 |
| 削除確認 (ユーザー) | このユーザーを削除してもよろしいですか？作成したキャラクターは匿名化して保持されます。 | ユーザー削除ボタン押下時 1 |
| 削除確認 (キャラクター) | このキャラクターを削除してもよろしいですか？関連するチャットとコメントも削除されます。 | キャラクター削除ボタン押下時 1 |
| 成功メッセージ | ユーザー権限を変更しました。 | 権限変更成功時 1 |
| 成功メッセージ | ユーザーを停止しました。 | 停止成功時 1 |

#### **11\. モーダル仕様**

* **ユーザー停止モーダル:** 停止ボタン押下時。停止期間のドロップダウンと停止理由のテキストエリアを表示 1。  
* **ユーザー編集モーダル:** 編集ボタン押下時。ユーザー情報とポイント管理欄を含むフォームを表示 1。  
* **ユーザー削除確認:** 削除ボタン押下時。キャラクター匿名化に関する説明を含む確認メッセージ 1。

#### **12\. 認証・ガード**

* **権限チェック:** 全ての管理者ページ（/admin/\*\*）は、サーバーサイドで MODERATOR 以上の権限を確認します。権限不足時は403エラーを表示します 1。  
* **機能別権限:**  
  * ユーザー管理（停止・ガイド）: MODERATOR 以上  
  * キャラクター管理: CHAR\_MANAGER 以上  
  * ユーザー管理（権限変更・削除・ポイント）: SUPER\_ADMIN 1

#### **13\. 非機能要件**

* **セキュリティ:** 全ての管理者操作はログに記録されます。権限チェックはクライアント側（UIの表示/非表示）とサーバーサイド（API実行時）の両方で実施します 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| 権限チェック (不足) | USER 権限で /admin ページにアクセスし、アクセス不可（403またはリダイレクト）となることを確認 1。 |
| 権限チェック (機能別) | MODERATOR 権限でユーザー権限変更のドロップダウンが無効化されていることを確認 1。 |
| ユーザー停止: 正常系 | ユーザーを停止（例：7日間）し、理由と期限が記録されることを確認 1。 |
| ユーザー停止: ログイン | 停止されたユーザーがログイン不可となり、停止情報が表示されることを確認 1。 |
| ユーザー編集: ポイント | ユーザー編集モーダルで無料ポイントと有料ポイントを手動設定し、反映されることを確認 1。 |
| ユーザー削除: データ保持 | ユーザー削除後、当該ユーザーが作成したキャラクターが「匿名」作成者として保持されていることを確認 1。 |

#### **15\. 今後の拡張余地**

* 全ての管理者操作を記録・閲覧するための監査ログ機能。  
* 複数ユーザーを一括停止・削除する一括操作機能。  
* 新規キャラクターの承認プロセス（承認フロー）の実装 1。

### **第9章: 09\_お知らせ及びガイド**

本章では、全ユーザー（未ログイン含む）に公開される「お知らせ」および「ユーザーガイド」のコンテンツ管理仕様を定義します 1。

#### **1\. 画面概要**

* **機能名:** お知らせ及びガイド  
* **対象画面:**  
  * 閲覧: お知らせ一覧ページ (/notice)、お知らせ詳細ページ (/notice/\[noticeId\])、ガイドページ (/guide) 1  
  * 管理: お知らせ管理ページ (/notice/admin)、お知らせ編集ページ (/notice/admin/\[noticeId\]) 1

#### **2\. 前提/制約**

* **権限要件:** お知らせ・ガイドの作成・編集・削除は MODERATOR 以上の権限が必要です 1。  
* **マークダウン対応:** お知らせ・ガイドの本文はマークダウン形式で記述可能であり、表示時にHTMLに変換されます 1。  
* **カテゴリー:** ガイドはメインカテゴリー（例：基本操作、キャラクター）とサブカテゴリーで分類されます 1。

#### **3\. 関連URL・遷移**

* /notice (お知らせ一覧ページ)  
* /notice/\[noticeId\] (お知らせ詳細ページ)  
* /guide (ガイドページ)  
* /notice/admin (お知らせ管理ページ、管理者専用) 1

#### **4\. 役割・権限**

* **全ユーザー:** お知らせ・ガイドの閲覧は未ログインでも可能です。  
* **MODERATOR以上:** お知らせ・ガイドの作成・編集・削除が可能です 1。

#### **5\. 主要機能一覧**

* **お知らせ:** 一覧閲覧（タイトル、作成日時、要約）、詳細閲覧（マークダウンレンダリング）。  
* **ガイド:** カテゴリー別閲覧（メイン/サブカテゴリー）。  
* **\[管理者\] お知らせ:** 作成、編集、削除（マークダウンエディタ使用）。  
* **\[管理者\] ガイド:** 作成、編集、削除（第8章 1 と連携）1。

#### **6\. 画面構成（UIブロック）**

* **お知らせ一覧:** お知らせカードをリスト形式で表示（タイトル、作成日時、要約）。  
* **お知らせ詳細:** タイトル、作成日時、更新日時、内容（マークダウンをHTMLに変換）1。  
* **お知らせ管理テーブル:** 管理者専用。編集・削除ボタン付き 1。  
* **お知らせフォーム (NoticeForm.tsx):** 管理者専用。タイトル、内容（マークダウンエディタ）、プレビュー機能 1。  
* **ガイドページ:** メインカテゴリーをタブで表示。サブカテゴリーとガイド一覧をアコーディオン形式で表示（クリックで内容展開）1。

#### **7\. 画面項目定義**

*本セクションは、お知らせおよびガイドの主要なデータ項目を定義します。*

| 項目名 | 型 | 必須 | バリデーション | 備考 |
| :---- | :---- | :---- | :---- | :---- |
| タイトル (お知らせ) | string | 必須 | 1〜200文字 | 1 |
| 内容 (お知らせ) | string | 必須 | 10〜10000文字 | マークダウン対応 1 |
| タイトル (ガイド) | string | 必須 | 1〜200文字 | 1 |
| 内容 (ガイド) | string | 必須 | 10〜10000文字 | マークダウン対応 1 |
| メインカテゴリー (ガイド) | string | 必須 | 事前定義されたカテゴリーから選択 | 基本操作・キャラクター・チャットなど 1 |

#### **8\. フィルタ仕様**

* **ガイドフィルター:** メインカテゴリー、サブカテゴリーでフィルタリング可能 1。  
* **並び替え:** お知らせは作成日時順（最新順）に並び替えられます 1。

#### **9\. API I/F 仕様**

| エンドポイント | メソッド | パラメータ | レスポンス | 説明 |
| :---- | :---- | :---- | :---- | :---- |
| /api/notice | GET | { page?, limit? } | { notices:, total } | お知らせ一覧取得API 1 |
| /api/notice | POST | { title, content } | { success, noticeId } | お知らせ作成API（管理者専用）1 |
| /api/notice/\[noticeId\] | GET | パスなし | { notice: {...} } | お知らせ詳細取得API 1 |
| /api/notice/\[noticeId\] | PUT | { title, content } | { success } | お知らせ更新API（管理者専用）1 |
| /api/notice/\[noticeId\] | DELETE | パスなし | { success } | お知らせ削除API（管理者専用）1 |
| /api/guides | GET | { mainCategory?, subCategory? } | { guides: } | ガイド一覧取得API 1 |

#### **10\. エラー・通知文言**

| エラータイプ | 文言 | 表示タイミング |
| :---- | :---- | :---- |
| 作成エラー | タイトルは必須です。 | タイトル未入力時 1 |
| 作成エラー | 内容は10文字以上入力してください。 | 内容が短すぎる時 1 |
| 権限エラー | この操作を実行する権限がありません。 | 権限不足時（管理者機能）1 |
| 削除確認 | このお知らせを削除してもよろしいですか？ | お知らせ削除ボタン押下時 1 |
| 成功メッセージ | お知らせを作成しました。 | お知らせ作成成功時 1 |

#### **11\. モーダル仕様**

* **お知らせ削除確認:** 削除ボタン押下時。確認メッセージを表示 1。  
* **ガイド削除確認:** 削除ボタン押下時。確認メッセージを表示 1。  
* **プレビュー:** マークダウンエディタのプレビューボタン押下時。HTML変換後の内容をモーダル表示 1。

#### **12\. 認証・ガード**

* **閲覧:** お知らせ・ガイドの閲覧は未ログインでも可能です 1。  
* **CRUD:** 作成・編集・削除は MODERATOR 以上の権限が必要です。サーバーサイドで権限チェックを行い、権限不足時は403エラーを表示します 1。

#### **13\. 非機能要件**

* **セキュリティ:** マークダウン内容は表示時にXSS対策としてサニタイズされます 1。

#### **14\. テスト観点**

| 項目 | テストケース |
| :---- | :---- |
| お知らせ詳細: 表示 | マークダウン形式の内容がHTMLに正しく変換（例：見出し、リスト、リンク）されて表示されることを確認 1。 |
| 権限チェック (管理者) | MODERATOR 以上の権限で、お知らせ/ガイドの作成・編集・削除が可能であることを確認 1。 |
| 権限チェック (一般) | USER 権限または未ログインで、管理機能（作成ボタン、編集フォーム）にアクセス不可（403またはリダイレクト）であることを確認 1。 |
| ガイド閲覧: 動作 | カテゴリータブ切り替え、およびアコーディオン形式での内容展開が正しく動作することを確認 1。 |

#### **15\. 今後の拡張余地**

* 新しいお知らせ投稿時にユーザーに通知（プッシュ通知、メールなど）。  
* お知らせをカテゴリー（メンテナンス、イベントなど）別に分類。  
* 重要なお知らせを一覧の最上部に固定（ピン留め）する機能。  
* ガイドをキーワードで検索する機能。  
* ユーザーがガイドに評価（役に立った/役に立たなかった）を付ける機能 1。

## **第2部：画面別仕様（実装設計）**

本セクションは、第1部で定義されたシステム仕様を、具体的な画面（ページ）単位の実装レベルに落とし込んだ詳細設計書です。主に UI設計書\_ナモアイ.xlsx に含まれるシート 1 の内容に基づいています。

### **第10章: ホーム (メインページ)**

本章は、サイトのルート / 1 に関する実装仕様を定義します。第1部 1 のメインページAPI仕様と連携します。

#### **画面概要**

* **画面名:** ホーム（メインページ）  
* **目的:** 注目・新着・特集キャラクターを発見し、詳細ページへ誘導します。  
* **レイアウト:** ダークテーマ (bg-black text-white)。ヘッダー、告知バナー、4つのカードグリッドセクション 1。

#### **データ取得**

* 初回マウント時に GET /api/main-page を実行します 1。  
* レスポンスデータ型: { trendingCharacters, newTopCharacters, specialCharacters, generalCharacters } 1。  
* 各セクションの配列が空の場合、そのセクションは非表示 (return null) となります 1。

#### **UI構成**

* **ヘッダー:**  
  * 左: サービス名「ナモアイ」（text-2xl font-bold text-pink-500）1。  
  * 右: ショートカットアイコン（キャラクター一覧 /charlist、検索 /search、ランキング /ranking、マイページ /mypage）1。  
* **告知バナー:**  
  * 「毎日出席して最大10倍の報酬をゲット！」（ピンク背景）1。  
  * *分析:* これは第6章 1 および第14章 1 で定義されたポイント・出席システムへの導線です。  
* **セクション（CharacterRow コンポーネント）:**  
  * 今話題のキャラクター  
  * ホットな新作TOP10  
  * 見逃せない特集キャラクター  
  * 新規キャラクター紹介 1  
* **カード:** 画像、名前、説明（truncate）。ホバーで画像拡大（group-hover:scale-105）1。

#### **認証・ガード**

* 本画面に権限ガードはありません。未認証でも閲覧可能です 1。

### **第11章: キャラクター一覧**

本章は、/charlist 1 の実装仕様を定義します。第2章 1 のキャラクター管理仕様と連携します。

#### **画面概要**

* **画面名:** キャラクター一覧  
* **目的:** タグおよび並び替えでキャラクターを検索し、詳細へ遷移します。  
* **レイアウト:** スティッキーヘッダー、横スクロールのタグチップ、右上に並び替えドロップダウン、カードグリッド 1。

#### **データ取得**

* activeTag または activeSort の状態変更時に useEffect をトリガーし、GET /api/charlist?tag=${activeTag}\&sort=${activeSort.key} を実行します 1。  
* activeSort.key は newest (最新登録順), popular (チャット数順), likes (いいね数順) を含みます 1。

#### **UI構成**

* **ヘッダー:** 左に戻るボタン（window.history.back()）、中央にタイトル「キャラクター一覧」1。  
* **タグチップ:** 横スクロールコンテナ。  
  * アクティブ: bg-pink-500 text-white  
  * 非アクティブ: bg-gray-800 text-gray-300 1  
* **並び替え:** ドロップダウンメニュー。開閉時に ChevronDown アイコンが回転します 1。  
* **カード:** 画像（エラー時は placehold.co のプレースホルダー）、名前（truncate）、説明（truncate）、メタ情報（MessageSquareアイコン＋チャット数、Heartアイコン＋いいね数）1。

#### **認証・ガード**

* ガード無し（未認証でも閲覧可能）1。

### **第12章: 検索**

本章は、/search 1 の実装仕様を定義します。第7章 1 の検索仕様と連携します。

#### **画面概要**

* **画面名:** 検索  
* **目的:** 自由語検索。初期表示では「最近の検索語」と「人気の検索語」を提示し、検索行動を促進します 1。

#### **データ取得**

* **初期表示:** GET /api/search を実行し、{ popularKeywords } を取得 1。  
* **検索時:** GET /api/search?query=${encodeURIComponent(term)} を実行し、SearchResult を取得 1。

#### **ローカル保存**

* 検索履歴は localStorage('recentSearches') に最大5件まで保存されます。重複は排除され、新しいものが先頭に追加されます 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（window.history.back()）、検索バー（placeholder="話したいキャラクターを探す"）1。  
* **検索結果セクション（hasSearched=true 時）:**  
  * 見出し「検索結果」。  
  * カード型リスト（画像、名前、説明（line-clamp-2）、ハッシュタグ（ピル型））1。  
* **初期表示セクション（hasSearched=false 時）:**  
  * **最近の検索語:** 丸チップ列。クリックで検索実行、× で個別削除。「すべて削除」ボタン付き 1。  
  * **人気の検索語:** ランキング番号（1, 2,...）＋キーワード。クリックで検索実行 1。  
* **状態表示:** 検索中は「検索中...」、結果0件は「検索結果がありません。」を表示します 1。

#### **認証・ガード**

* ガード無し（未認証でも閲覧可能）1。

### **第13章: ランキング**

本章は、/ranking 1 の実装仕様を定義します。第7章 1 のランキング仕様と連携します。

#### **画面概要**

* **画面名:** ランキング  
* **目的:** 期間（リアルタイム／日間／週間／月間）ごとの人気キャラクターを表示します。  
* **レイアウト:** 戻る付きヘッダー、期間タブ、ランキングリスト 1。

#### **データ取得**

* activeTab の状態変更（タブクリック）のたびに、GET /api/ranking?period=${activeTab} を実行します。activeTab は 'realtime', 'daily', 'weekly', 'monthly' のいずれかです 1。  
* 取得失敗時は setRanking() とし、UIは「空表示」文言を中央に表示します 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（window.history.back()）、中央タイトル「ランキング」（text-2xl font-bold text-pink-500）1。  
* **期間タブ:** 4つのボタン。  
  * アクティブ: bg-pink-500 text-white  
  * 非アクティブ: bg-gray-800 text-gray-400 1  
* **ランキングリスト:**  
  * **順位:** 1～3位は王冠（Crown）アイコン（1位: yellow-400, 2位: gray-400, 3位: yellow-600）。4位以降は番号（gray-500）1。  
  * **メタ（右端）:** realtime タブのみ Flame アイコン（ピンク）。それ以外は MessageSquare アイコンとチャット数を表示 1。

#### **認証・ガード**

* 本画面に権限ガード無し（未認証でも閲覧可能）1。

### **第14章: ポイント（出席・購入）**

本章は、/points 1 の実装仕様を定義します。第6章 1 のポイントシステム仕様と連携します。

#### **画面概要**

* **画面名:** ポイント  
* **目的:** 保有ポイントの確認、毎日出席ボーナスの獲得、ポイント購入（プリセット）1。

#### **データ取得**

* 初回マウント時に GET /api/points を実行し、pointsData: { free\_points, paid\_points, attendedToday } を取得します 1。  
* ポイント数は toLocaleString() で桁区切り表示します 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（window.history.back()）、中央タイトル「ポイント」1。  
* **メッセージバナー:** APIの成否メッセージ（成功/失敗）を上部に一時表示します 1。  
* **保有ポイントカード:** 合計ポイント（text-4xl font-bold）、内訳（有料/無料）1。  
* **毎日出席イベントカード:**  
  * 見出し: text-lg font-bold  
  * ボタン（attendedToday \=== false）: 「出席して30ポイントGET」（bg-pink-500 \+ Gift アイコン）1。  
  * ボタン（attendedToday \=== true）: 「本日は出席済み」（bg-gray-700 \+ CheckCircle アイコン, cursor-not-allowed）1。  
* **ポイント購入セクション:**  
  * 見出し: 「ポイント購入」  
  * 商品行: ポイント数（＋ボーナス）、右端に価格ボタン（例：「￥100」）1。

#### **API実行**

* **出席:** 「出席して30ポイントGET」ボタンクリック時  
  * POST /api/points (Body: { action: 'attend' })  
  * 成功時: メッセージバナー表示、GET /api/points でポイントを再取得 1。  
* **課金:** 価格ボタンクリック時  
  * POST /api/points (Body: { action: 'charge', amount: \<points\> })  
  * *分析:* amount には yen (価格) ではなく points (ポイント数) を送信する設計になっています 1。  
  * 成功時: メッセージバナー表示、ポイントを再取得 1。

#### **認証・ガード**

* 画面自体にガードはありません。実際の課金・日次出席の可否は API 側で判定する前提です 1。

### **第15章: ユーザーガイド**

本章は、/guides 1 の実装仕様を定義します。第9章 1 および第8章 1 のガイド管理仕様と連携します。

#### **画面概要**

* **画面名:** ユーザーガイド  
* **目的:** 階層化（大分類／小分類）されたガイド記事をアコーディオン式サイドバーで選択し、閲覧します。  
* **レイアウト:** 左にアコーディオン式サイドバー、右に本文エリア 1。

#### **データ取得**

* セッション取得: GET /api/auth/session（管理者ボタン表示判定のため）1。  
* ガイド取得: GET /api/guides。レスポンスは階層化されたオブジェクト { \[main: string\]: { \[sub: string\]: Guide } } を想定 1。  
* **初期選択:** データ取得後、自動で先頭の大分類→小分類→最初の記事を選択し、本文エリアに表示します 1。

#### **UI構成**

* **ヘッダー:**  
  * 戻るボタン: /MyPage へリンク 1。  
  * タイトル: 「ユーザーガイド」  
  * **管理ボタン:** session.user.role \=== 'ADMIN' の時のみ「ガイド管理」ボタン（→ /admin/guides）を表示 1。  
* **サイドバー:**  
  * 大分類・小分類ごとに開閉（Chevronアイコンが回転）。  
  * 記事一覧: 選択中の記事は text-pink-400 font-bold で強調 1。  
* **本文エリア:**  
  * 記事タイトル（\<h1\>）。  
  * 本文: dangerouslySetInnerHTML でHTML文字列を描画。prose prose-invert クラスで可読性を確保 1。

#### **認証・ガード**

* 画面自体に権限ガードはありません（未認証でも閲覧可能）。  
* 「ガイド管理」ボタンのみ、セッションの user.role に基づいて表示制御されます 1。

### **第16章: 管理パネル（ダッシュボード）**

本章は、/admin 1 の実装仕様を定義します。これは第8章 1 で定義された管理者機能へのハブ（Hub）ページです。

#### **画面概要**

* **画面名:** 管理パネル（ダッシュボード）  
* **目的:** 管理者の役割（ロール）に応じて、各管理画面への導線を提供します。

#### **認証・ガード**

*本画面は厳格なアクセス制御を持ちます。*

* **セッション確認:** useSession() を使用し、status を管理します 1。  
* **status \=== 'loading':** 「読み込み中...」を全画面中央に表示 1。  
* **status \=== 'unauthenticated':** /login へ強制遷移 1。  
* **session.user.role \=== 'USER':** alert("管理者権限がありません。") を表示後、/ （トップページ）へ強制遷移 1。  
* *分析:* MODERATOR 以上の権限を持つユーザーのみが、本画面のコンテンツにアクセスできます。

#### **UI構成 (役割別)**

* **ヘッダー:** タイトル「管理パネル」、戻るボタン（「マイページに戻る」→ /MyPage）1。  
* **カードグリッド:**  
  * **SUPER\_ADMIN:** 3つのカード（ユーザー管理 / ガイド管理 / キャラクター管理）が全て表示されます 1。  
  * **MODERATOR:** 「ガイド管理」のみ表示されます 1。  
  * **CHAR\_MANAGER:** 「キャラクター管理」のみ表示されます 1。  
* **カードリンク先:**  
  * ユーザー管理 → /admin/users  
  * ガイド管理 → /admin/guides  
  * キャラクター管理 → /admin/characters 1

### **第17章: 管理者 ユーザー管理**

本章は、/admin/users 1 の実装仕様を定義します。第8章 1 のユーザー管理機能（特に権限変更）に対応します。

#### **画面概要**

* **画面名:** ユーザー管理  
* **目的:** ユーザー一覧の閲覧・検索・役割（ロール）更新を行います。

#### **認証・ガード**

* **SUPER\_ADMIN のみ**アクセス可能です 1。  
* SUPER\_ADMIN 以外（未認証、USER、MODERATOR, CHAR\_MANAGER）はアクセス不可（警告表示のうえ / または /login へ遷移）1。

#### **UI構成**

* **ヘッダー:** タイトル「ユーザー管理」、戻るボタン（「管理パネルに戻る」→ /admin）1。  
* **検索フォーム:** 「名前、ニックネーム、メールアドレスで検索」1。  
* **テーブル:**  
  * ヘッダ: ID / 名前 / メールアドレス / 登録日 / 役割 1。  
  * **役割 (Role) 列:** \<select\> プルダウン（USER, MODERATOR, CHAR\_MANAGER, SUPER\_ADMIN）1。

#### **API実行**

* **一覧取得:** GET /api/admin/users?query={q} 1。  
* **役割変更:** 「役割」列の \<select\> を変更した（onChange）タイミングで、即座に PUT /api/admin/users (Body: { userId:number, newRole:Role }) を実行します。成功時は alert を表示し、一覧を再取得します 1。

### **第18章: 管理者 キャラクター管理**

本章は、/admin/characters 1 の実装仕様を定義します。第8章 1 のキャラクター管理機能に対応します。

#### **画面概要**

* **画面名:** キャラクター管理  
* **目的:** 全キャラクターの検索、公開・非公開切替、編集、削除を行います。

#### **認証・ガード**

* **CHAR\_MANAGER** または **SUPER\_ADMIN** のみアクセス可能です 1。  
* 権限不足の場合は警告（alert）のうえ、/admin へ遷移します 1。

#### **データ取得**

* debouncedQuery（検索語）または currentPage（ページ番号）の変更時に GET /api/admin/characters?page={n}\&search={q} を実行します 1。  
* 検索は debounce 500ms で実行されます 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（→ /admin）、タイトル「キャラクター管理」1。  
* **検索ボックス:** placeholder="キャラクター名で検索..." 1。  
* **カードリスト:** 画像、名前、説明、**作者ニックネーム**、公開状態を表示 1。  
* **ケバブメニュー:**  
  * **公開切替:** PUT /api/admin/characters (Body: { id, visibility }) を実行（確認ダイアログあり）1。  
  * **修正:** /characters/edit/{id} へ遷移 1。  
  * **削除:** DELETE /api/admin/characters (Body: { id }) を実行（確認ダイアログあり）1。  
* **ページネーション:** 「前へ」 / {page}/{total} / 「次へ」 1。

### **第19章: 管理者 ガイド管理**

本章は、/admin/guides 1 の実装仕様を定義します。第8章 1 および第9章 1 のガイド管理機能に対応します。

#### **画面概要**

* **画面名:** ガイド管理  
* **目的:** ユーザーガイド（第15章 1 で表示）の記事を作成・編集・削除します。

#### **認証・ガード**

* **MODERATOR** または **SUPER\_ADMIN** のみアクセス可能です 1。  
* 権限不足の場合は警告（alert）のうえ、/admin へ遷移します 1。

#### **レイアウト**

* 左フォーム（固定）＋右一覧の2ペイン構成です 1。

#### **UI構成**

* **ヘッダー:** タイトル「ガイド管理」、戻るボタン（→ /guide）1。  
* **左パネル（フォーム）:**  
  * sticky top-8 で固定。  
  * 入力項目: メインカテゴリー, サブカテゴリー, タイトル, 内容 (HTML可), 表示順 (displayOrder, number) 1。  
  * isEditing 状態により、ボタン文言が「作成」／「更新」に切り替わります 1。  
* **右パネル（一覧）:**  
  * 登録済みガイドをリスト表示（カテゴリ \> サブカテゴリ / タイトル）。  
  * 各行に編集ボタン、削除ボタン 1。  
  * 空状態: 「登録されたガイドはありません。」

#### **API実行**

* **一覧取得:** GET /api/admin/guides 1。  
* **作成:** POST /api/admin/guides (Body: formData) 1。  
* **更新:** PUT /api/admin/guides (Body: {...formData, id }) 1。  
* **削除:** DELETE /api/admin/guides (Body: { id })（確認ダイアログあり）1。  
* **編集開始時:** 編集ボタンクリックで対象の Guide オブジェクトを isEditing 状態にセットし、フォームに値をバインド。同時に window.scrollTo(0, 0\) を実行し、フォーム上部へスクロールさせます 1。

### **第20章: ログイン画面**

本章は、/login 1 の実装仕様を定義します。第1章 1 のログイン機能に対応します。

#### **画面概要**

* **画面名:** ログイン  
* **目的:** Google または メール/パスワードで認証します。  
* **レイアウト:** 中央にカード型フォーム 1。

#### **UI構成**

* **見出し:** 「ログイン/会員登録」  
* **Googleログイン:** 「Googleアカウントで始まる。」ボタン 1。  
* **フォーム:**  
  * メール入力（Mail アイコン）  
  * パスワード入力（Lock アイコン, type="password"）1  
* **リンク:**  
  * パスワード再設定: ラベル表示のみ（クリックUIはあるが遷移先/処理は未実装）1。  
  * 会員登録リンク: 「アカウントがない方」→ /register へ遷移 1。  
* **CTA:** 「ログイン」ボタン

#### **API実行**

* **Google:** signIn('google') を実行 1。  
* **メール:** 「ログイン」ボタン押下で signIn('credentials', { redirect:false, email, password }) を実行 1。  
* **遷移:** ログイン成功時は /MyPage へ router.push します。失敗時は console.error にエラーを出力します（UIへのエラー表示は未実装）1。

### **第21章: マイページ**

本章は、/MyPage 1 の実装仕様を定義します。これは認証済みユーザーのハブページです。

#### **画面概要**

* **画面名:** マイページ  
* **目的:** ユーザー情報、ポイント残高、セーフティフィルター設定の確認、および主要メニューへの遷移、ログアウトを提供します。

#### **認証・ガード (表示分岐)**

* useSession の status に応じて表示を分岐します 1。  
* **status \=== 'loading':** 「ローディング中…」を表示。  
* **status \=== 'unauthenticated':** 「ログインして始める」CTA（→ /login）と、一部の案内メニューのみ表示 1。  
* **status \=== 'authenticated':** フルメニュー（プロフィール、ポイント、MYメニュー、案内、ログアウト）を表示 1。

#### **UI構成 (認証時)**

* **プロフィールカード:**  
  * アバター（画像ない場合はデフォルトSVG）、ユーザー名。  
  * session.user.role \=== 'ADMIN' の場合、「管理者」バッジを表示 1。  
  * 「マイプロフィール」ボタン → /profile/{userId} へ遷移 1。  
* **ポイントカード:**  
  * 「保有ポイント」を表示（GET /api/users/points の合算値）。  
  * クリックで /billing へ遷移 1。  
  * *分析:* 第14章 1 の /points とパスが異なりますが、機能的にはポイント関連画面への導線です。  
* **MY セクション:**  
  * キャラクター管理 (→ /character-management)  
  * **セーフティフィルター:**（第1章 1 の機能）トグルスイッチと ON/OFF バッジ 1。  
  * ペルソナ設定 (→ /persona/list)  
* **案内メニュー:** Discord、ユーザーガイド、お知らせ など。  
* **ログアウトボタン:** signOut({ callbackUrl: '/' }) を実行し、トップページへ遷移 1。

#### **モーダル仕様 (年齢確認)**

* セーフティフィルターを「ON」から「OFF」に切り替える際に、年齢確認モーダルを表示します 1。  
* **タイトル:** 年齢確認  
* **本文:** あなたは成人ですか？  
* **ボタン:** 「はい」（→ PUT /api/users/safety-filter 実行）、「いいえ」（→ キャンセル）1。

### **第22章: お知らせ一覧**

本章は、/notice 1 の実装仕様を定義します。第9章 1 のお知らせ閲覧機能に対応します。

#### **画面概要**

* **画面名:** お知らせ一覧  
* **目的:** お知らせを一覧し、詳細へ遷移します。  
* **レイアウト:** スティッキーヘッダー、一覧リスト 1。

#### **データ取得**

* 初回マウント時に GET /api/notice を実行します 1。  
* createdAt は toLocaleDateString('ja-JP') で (yyyy/mm/dd) 形式にフォーマットします 1。

#### **UI構成**

* **ヘッダー:**  
  * 左: 戻るボタン（ArrowLeft）→ /MyPage へ遷移 1。  
  * 中央: タイトル「お知らせ」  
  * 右: **新規作成ボタン**（PlusCircle）→ /notice/admin へ遷移 1。  
* **一覧リスト:**  
  * 各行に「カテゴリ」「タイトル」「作成日」を表示。  
  * **カテゴリ色分け:** アップデート (緑), 重要 (赤), イベント (青), その他 (灰) 1。  
  * 行クリックで /notice/{id} へ遷移 1。

#### **認証・ガード**

* 画面閲覧は全ユーザー可能です。  
* 「新規作成」ボタンは session.user.role \=== 'ADMIN' の場合のみ表示されます。非ADMIN時はレイアウト崩れ防止のため同サイズの空ボックス（スペーサ）を表示します 1。

### **第23章: お知らせ詳細**

本章は、/notice/{id} 1 の実装仕様を定義します。第9章 1 のお知らせ詳細機能に対応します。

#### **画面概要**

* **画面名:** お知らせ詳細  
* **目的:** 単一のお知らせ（HTML）を閲覧し、管理者が編集・削除を行えます。  
* **レイアウト:** max-w-3xl 中央寄せ 1。

#### **データ取得**

* 初回マウント時に GET /api/notice/{id} を実行します。  
* 取得失敗時は console.error に記録後、/notice （一覧）へ強制遷移します 1。

#### **UI構成**

* **ヘッダー:**  
  * 左: 戻るボタン（→ /notice）  
  * 中央: タイトル「お知らせ詳細」  
  * 右: **編集ボタン**（→ /notice/admin/{id}）、**削除ボタン**（ADMIN時のみ）1。  
* **本文:**  
  * カテゴリ（色付き小見出し）  
  * タイトル（text-2xl font-bold）  
  * 作成日（text-xs text-gray-500）  
  * 罫線（border-t）  
  * 記事HTML（dangerouslySetInnerHTML で描画、prose prose-invert でスタイル適用）1

#### **API実行 (削除)**

* 削除ボタン押下時、window.confirm で確認後、DELETE /api/notice/{id} を実行します。  
* 削除処理中はヘッダーのボタンを disabled にします 1。  
* 成功時は alert 表示後、/notice へ遷移し router.refresh() を実行します 1。

#### **認証・ガード**

* 画面閲覧は全ユーザー可能です。  
* 編集・削除ボタンは session.user.role \=== 'ADMIN' の場合のみ表示されます 1。

### **第24章: ペルソナ一覧・選択**

本章は、/persona（または /persona/list）1 の実装仕様を定義します。第5章 1 のペルソナシステムに対応します。

#### **画面概要**

* **画面名:** ペルソナ一覧／選択  
* **目的:** ペルソナの一覧、基本ペルソナの選択、新規作成・編集・削除を行います。

#### **データ取得**

* 初回マウント時に GET /api/persona を実行し、{ personas: Persona, defaultPersonaId:number } を取得します 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（→ /MyPage）、中央タイトル「ペルソナ」1。  
* **説明文:** ペルソナの活用と公開範囲に関するガイダンス文 1。  
* **リスト（カード）:**  
  * 各行にニックネーム、性別・年齢、説明（truncate）を表示。  
  * defaultPersonaId と一致する行は、ピンクの枠線と丸印（Check アイコン）で「選択中」であることを明示します 1。  
  * 右上に編集（Pencil）、削除（Trash2）アイコンを配置（行クリックと独立させるため stopPropagation）1。  
* **追加行:** 「ペルソナ追加」（Plus アイコン）ボタン → /persona/form へ遷移 1。

#### **API実行**

* **基本ペルソナ選択:** 行全体をクリック時、PATCH /api/persona (Body: { personaId }) を実行。成功時は選択状態（ピンク枠）を更新。失敗時は alert を表示し、選択状態をロールバック（元の選択に戻す）します 1。  
* **削除:** 削除アイコンクリック時、確認モーダル（「{nickname}を本当に削除しますか？」）を表示。確定後 DELETE /api/persona/{id} を実行し、成功後に一覧を再取得します 1。

### **第25章: ペルソナ作成・修正**

本章は、/persona/form/\[personaId\] 1 の実装仕様を定義します。第5章 1 のペルソナ作成・編集機能に対応します。

#### **画面概要**

* **画面名:** ペルソナ作成／修正  
* **目的:** ペルソナの（ニックネーム／年齢／性別／詳細情報）を編集・保存します。

#### **モード判定**

* URLの personaId の有無で isEditMode を自動判定します 1。  
* **修正モード時:** GET /api/persona/{personaId} で初期値を取得しフォームにバインドします。取得失敗時はアラート後 /persona/list へ戻します 1。

#### **UI構成**

* **ヘッダー:**  
  * 左: 戻る（→ /persona/list）  
  * 中央: タイトル（isEditMode? 「ペルソナ修正」 : 「ペルソナ追加」）  
  * 右: 「保存」ボタン 1  
* **フォーム:**  
  * ニックネーム（必須、最大20文字、カウンタ付）1。  
  * 年齢（数値、空で null）。  
  * 性別（「女性」「男性」「未選択」の3択。選択時ピンク枠）1。  
  * 詳細情報（必須、最大1000文字、カウンタ付、textarea）1。

#### **バリデーション**

* 必須項目（ニックネーム、詳細情報）が未入力の場合、「保存」ボタンを disabled にします 1。  
* 送信中は「保存」ボタンを disabled にし、文言を「保存中…」に変更します 1。

#### **API実行**

* **作成:** POST /api/persona (Body: formData) 1。  
* **更新:** PUT /api/persona/{personaId} (Body: formData) 1。  
* **遷移:** 保存成功時は alert（「ペルソナが作成されました。」等）を表示後、/persona/list へ router.push し、router.refresh を実行します 1。

### **第26章: お知らせ作成・修正**

本章は、/notice/admin/\[noticeId\] 1 の実装仕様を定義します。第9章 1 および第8章 1 のお知らせ管理機能に対応します。

#### **画面概要**

* **画面名:** お知らせ作成／修正  
* **目的:** 管理者が「お知らせ」を新規作成、または既存のお知らせを修正・保存します。

#### **認証・ガード (サーバーサイド)**

* **getServerSession** を使用し、**ADMIN** 権限を判定します。  
* 非ADMIN（USER、未認証など）がアクセスした場合、/notice （一覧）へ redirect() します 1。

#### **モード判定**

* URL（noticeId の有無）に基づき、サーバーサイドでモードを決定します 1。  
* **修正モード時:** サーバー側でDBから対象レコードを取得し、initialData としてクライアント（フォーム）に渡します。対象が見つからない場合（ID不正）は /notice へ redirect() します 1。

#### **UI構成**

* **ヘッダー:**  
  * 左: 戻る（作成時→ /notice, 修正時→ /notice/{noticeId}）  
  * 中央: タイトル（作成/修正）1  
* **フォーム:**  
  * **エラーバナー:** バリデーションエラーまたはAPIエラー発生時に、フォーム上部に赤背景で表示 1。  
  * タイトル: \<input type="text"\>（必須）  
  * カテゴリ: \<select\>（一般／アップデート／重要／イベント）（必須）  
  * 本文: \<textarea rows="10"\>（必須、HTML可）1  
  * 送信ボタン: 文言（作成する/更新する）。送信中は「保存中…」となり disabled 1。

#### **バリデーション**

* クライアントサイドで、タイトル・カテゴリ・本文が必須であることを検証します。未入力で保存しようとすると、エラーバナーに「すべての項目を入力してください。」と表示されます 1。

#### **API実行**

* **作成:** POST /api/notice 1。  
* **更新:** PUT /api/notice/{noticeId} 1。  
* **遷移:** 成功時は alert 表示後、/notice へ router.push し router.refresh() を実行します 1。

### **第27章: キャラクター作成・修正**

本章は、/characters/create および /characters/edit/\[id\] 1 の実装仕様を定義します。第2章 1 のキャラクター作成・編集機能に対応します。

#### **画面概要**

* **画面名:** キャラクター作成／修正  
* **目的:** キャラクターの全情報（プロフィール、画像、詳細設定、ローブック等）を編集・保存します。  
* **レイアウト:** ステップ形式フォーム（プロフィール／画像／詳細情報／開始状況／その他設定／ロアブック／登録）1。

#### **認証・ガード**

* useSession で status \=== 'unauthenticated' の場合、alert("ログインセッションが見つかりません。") を表示し、/login へリダイレクトします 1。

#### **UI構成 (ステップ別)**

* **ステップ1 (プロフィール):**  
  * 名前（必須、最大20文字）1。  
  * 紹介文（最大250文字）1。  
* **ステップ2 (キャラクター画像):**  
  * アップロード（最大10枚）。1枚目は「基本画像」。  
  * 画像クリックで「キーワード入力モーダル」を表示。  
  * 削除ボタンあり 1。  
* **ステップ3 (詳細情報):**  
  * システムテンプレート選択。  
  * 詳細設定（textarea、最大5000文字）1。  
* **ステップ4 (開始状況):**  
  * 最初の状況（最大1000文字）。  
  * 最初のメッセージ（最大500文字）1。  
* **ステップ5 (その他設定):**  
  * 公開範囲（ラジオボタン：公開／非公開／リンク限定公開）1。  
  * セーフティフィルター（トグル：On/Off）1。  
  * カテゴリ（ボタン群から1つ選択）。  
  * ハッシュタグ（最大5個、モーダルから選択またはカスタム入力）1。  
* **ステップ6 (ロアブック):**  
  * 現状プレースホルダー（将来拡張用）1。  
* **ステップ7 (登録):**  
  * 「登録」または「保存」ボタン（isEditMode で文言切替）。送信中は disabled かつ文言「登録中…」「保存中…」1。

#### **API実行**

* FormData を使用して送信します 1。  
* **作成:** POST /api/characters 1。  
* **修正:** PUT /api/characters/{id}（削除対象画像リスト、新規追加画像ファイルを含む）1。  
* **遷移:** 成功時は alert 表示後、/MyPage へ遷移します 1。

### **第28章: キャラクター管理**

本章は、/characters（または /character-management 1）1 の実装仕様を定義します。これはユーザーが自身の*キャラクターを管理する画面です。*

#### **画面概要**

* **画面名:** キャラクター管理  
* **目的:** 自身のキャラクター一覧を閲覧・管理（作成、編集、削除、コピー、インポート、チャット遷移）します。  
* **レイアウト:** カード型リスト。最大横幅 4xl、中央寄せ 1。

#### **認証・ガード**

* useSession の status に応じて制御 1。  
  * loading: ローディング表示。  
  * unauthenticated: /login へ router.push 1。  
  * authenticated: 一覧取得を実行。

#### **UI構成**

* **ヘッダー:** 戻るボタン（履歴戻り）、タイトル「キャラクター管理」、新規作成ボタン（「＋」→ /characters/create）1。  
* **タブ絞り込み:** 「全体」「公開」「非公開」「リンク限定公開」。選択中は下線と強調 1。  
* **リスト行（カード）:**  
  * 左: サムネイル（64x64、プレースホルダー対応）。  
  * 中央: 名称（truncate）、公開状態、統計値（MessageSquare やり取り / Heart お気に入り）1。  
  * 右: 「チャット」ボタン（→ /chat/\[id\]）、ケバブメニュー（…）1。

#### **ケバブメニュー機能**

* **修正:** /characters/edit/\[id\] へ遷移 1。  
* **削除:** DELETE /api/characters/{id} を実行（確認モーダルあり）。成功時はトースト表示 1。  
* **コピー:** GET /api/characters/{id} で詳細データを取得し、一時的に保持。トースト「「{name}」をコピーしました。」を表示 1。  
* **インポート:**  
  * *分析:* これは第2章 1 の「インポート機能」の具体的なUI実装です。  
  * コピー済みデータがない場合はアラート「先に他のキャラクターを「コピー」してください。」1。  
  * コピー済みデータがある場合、確認モーダルを表示。  
  * 確定後、POST /api/characters/{id}/import (Body: コピーしたJSONデータ) を実行し、対象キャラクターの設定を上書きします 1。

#### **通知**

* APIの成否は、画面上部に表示され3秒で消える「トースト」で通知されます 1。

### **第29章: キャラクター詳細**

本章は、/characters/\[characterId\] 1 の実装仕様を定義します。第2章 1 のキャラクター詳細機能に対応します。

#### **画面概要**

* **画面名:** キャラクター詳細  
* **目的:** 特定キャラクターの情報を閲覧し、チャットを開始します。  
* **レイアウト:** 上部に大きなキービジュアル、下部固定の主要CTA（会話継続／新規チャット）1。

#### **データ取得**

* GET /api/characters/{characterId} を実行します。  
* 失敗時: alert("キャラクター情報の読み込みに失敗しました。") を表示後、router.back()（履歴戻り）1。  
* 画像: 先頭画像が無い場合、/default-character-image.png を使用します 1。

#### **UI構成**

* **ヘッダー:** 画像上にオーバーレイ。左に戻るボタン（ArrowLeft）、右にその他メニュー（MoreVertical、現状未実装）1。  
* **キービジュアル:** キャラクター画像を背景表示。下端に黒半透明の帯＋キャラクター名（タイトル）1。  
* **メタ情報:** 作者ニックネーム（ない場合は「作者不明」）、チャット数（\_count.chat）、お気に入り数（\_count.favorites）1。  
* **本文:** description（ない場合は「キャラクター説明がありません。」）、ハッシュタグ（ピル型バッジ）、生成日・最近のアップデート（createdAt/updatedAt を ja-JP で日付表示）1。

#### **下部固定アクション**

* **左ボタン: 「続きから会話」**  
  * /chat/\[characterId\] への Link 遷移 1。  
* **右ボタン: 「新しいチャットを開始」**  
  * クリック時: POST /api/chats/find-or-create (Body: { characterId, forceCreate: true }) を実行 1。  
  * 処理中はボタンを disabled にし、文言を「作成中…」に変更 1。  
  * 成功時: /chat/\[characterId\] へ router.push 1。  
  * 失敗時: alert("新規チャットの作成に失敗しました。") を表示 1。

### **第30章: チャット設定＋メッセージパーサー**

本章は、チャット画面（第31章 1）で使用されるコンポーネント、ChatSettings.tsx（設定パネル）および ChatMessageParser.tsx（本文レンダラ）1 の統合仕様を定義します。

#### **ChatSettings.tsx (設定パネル)**

* **レイアウト:** 画面右からスライドインする固定パネル（w-80）と、背景のオーバーレイ（クリックで閉じる）1。  
* **機能:**  
  * **トグル:** 「チャットイメージ ON/OFF」（showChatImage）、「マルチイメージ ON/OFF」（isMultiImage）。onChange コールバックを親（チャット画面）に通知 1。  
  * **保存:** 「会話内容を保存」→ 保存モーダル（TXT/PNG）を開き、親の onSaveConversationAs... コールバックを実行 1。  
  * **ノート:** 「ユーザーノート」→ ノートモーダル（1000文字上限、カウンタ付）を開き、保存時に親の onSaveNote コールバックを実行 1。  
  * **遷移:** 「ペルソナ」→ /persona/list へクエリ付き（characterId, chatId）で遷移 1。  
  * **操作:** 「新しいチャット」（赤ボタン）→ 親の onNewChat コールバックを実行 1。

#### **ChatMessageParser.tsx (本文レンダラ)**

* *分析:* これは、チャット本文の特殊な記法を解釈し、安全にHTML（Reactノード）に変換するコアロジックです。  
* **Props:** content (本文), characterImages (画像配列), showImage (bool), isMultiImage (bool), onImageClick (fn) 1。  
* **パース規則:**  
  * \*地文\* → 斜体・グレーで表示 (\<em\>) 1。  
  * 「セリフ」 → 太字・白で表示 (\<strong\>) 1。  
  * \!(URL) → 外部画像として描画（クリックで onImageClick）1。  
  * {img:n} → 内部画像（characterImages 配列のn番目、1始まり）を参照して描画 1。  
* **描画制御:**  
  * showImage=false の場合、{img:n} は描画されません 1。  
  * isMultiImage=false の場合、{img:n} は最初の1枚のみ描画されます 1。

### **第31章: チャット**

本章は、/chat/{characterId} 1 の実装仕様を定義します。第3章 1 のチャットシステム仕様に対応し、第30章 1 のコンポーネントを使用します。

#### **画面概要**

* **画面名:** チャット  
* **目的:** キャラクターとの会話（送受信・画像表示・ノート保存）を行います。  
* **レイアウト:** 上部固定ヘッダー、中央メッセージリスト、下部入力フッター、右スライド設定パネル 1。

#### **データ取得**

* URLから characterId と chatId（クエリ）を取得します 1。  
* **1\. キャラ情報取得:** GET /api/characters/{characterId} を実行し、characterInfo（名前、firstSituation, firstMessage, characterImages）を取得 1。  
* **2\. セッション作成/取得:** POST /api/chats/find-or-create (Body: { characterId, chatId? }) を実行し、既存メッセージ履歴と userNote を取得 1。  
* **初期投入:** 取得した履歴が0件の場合、characterInfo の firstSituation と firstMessage を自動的に messages 配列の先頭に追加します 1。

#### **UI構成**

* **ヘッダー:**  
  * 左: 戻るボタン（ArrowLeft）→ /characters/{characterId} へ明示遷移 1。  
  * 中央: アバター＋キャラ名（クリックで /characters/{characterId} へ）  
  * 右: メニューボタン（Menu）→ 第30章 1 の設定パネルを開く（isSettingsOpen をトグル）1。  
* **本文（メッセージリスト）:**  
  * role \=== 'first\_situation': 斜体グレーの行。  
  * role \=== 'system': 中央・灰背景のインライン通知。  
  * role \=== 'user': ピンク気泡／右寄せ。  
  * role \=== 'model': 濃灰気泡／左寄せ。  
  * *分析:* 全ての本文は ChatMessageParser 1 を通じて描画され、\*地文\*, 「セリフ」, \!(URL), {img:n} 記法が解釈されます 1。  
* **フッター（入力エリア）:**  
  * 左上: **入力補助ボタン**（地文ボタン \*、セリフボタン 「」）。クリックで入力末尾に記号を挿入 1。  
  * 入力: \<textarea rows=1\>（Enter送信／Shift+Enter改行）。  
  * 右端: 送信ボタン（Send）（空白時・送信中は無効）1。  
* **ライトボックス:** ChatMessageParser からの onImageClick コールバックを受け取り、lightboxImage 状態を更新して全画面拡大表示します 1。

#### **API実行**

* **送信:** POST /api/chat/{chatId} (Body: { message: input })。返信（data.reply）を受信し、model ロールとして messages に追加 1。  
* **ノート保存:** （設定パネル 1 から）PATCH /api/chat/{chatId}/note (Body: { userNote }) 1。  
* **新規チャット:** （設定パネル 1 から）POST /api/chats/find-or-create (Body: { characterId, forceNew:true })。成功後、新しい chatId で router.push 1。

### **第32章: チャット一覧**

本章は、/chatlist（第3章 1 で定義）の実装仕様 1 を定義します。

#### **画面概要**

* **画面名:** チャット一覧  
* **目的:** 過去のチャットスレッドを一覧し、再開または新規開始します。  
* **レイアウト:** 固定ヘッダー＋検索欄＋リスト本体 1。

#### **データ取得**

* 初回マウント時に GET /api/chats を実行します。  
* レスポンス型: ChatData（id, updatedAt, characterId, characters:{ name, characterImages }, chat\_message:\[{content}\]）1。  
* updatedAt は toLocaleDateString('ja-JP') で日付のみ表示します 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（router.back()）、中央タイトル「チャット」1。  
* **検索バー:** 「チャット検索」プレースホルダー。*（分析: 現状はUIのみで検索ロジックは未実装）*1。  
* **チャット行:**  
  * 左: 丸型アバター（50x50、プレースホルダー /avatars/default.png）1。  
  * 中央: 上段＝キャラ名（太字）＋最終更新日（右寄せ）、下段＝最新メッセージ1件（truncate）1。  
  * 右: **新規作成ボタン**（BsPlusCircle）。ツールチップ「新しいチャットを開始」1。

#### **遷移**

* **再開:** 行全体をクリック → /chat/{characterId}?chatId={id} へ遷移（チャットIDをクエリで渡す）1。  
* **新規作成:** 右端の「＋」ボタンをクリック → POST /api/chats/find-or-create (Body: { characterId, forceCreate:true }) を実行。  
  * 成功時: /chat/{characterId} へ遷移 1。  
  * 失敗時: alert('新規チャットの作成に失敗しました。') 1。

#### **認証・ガード**

* 本コンポーネント内での明示的なガードは記述されていません。APIレイヤーまたは上位ルートでの保護を前提とします 1。

### **第33章: マイプロフィール**

本章は、/profile/{userId} 1 の実装仕様を定義します。第1章 1（パスワード変更）および第4章 1（ソーシャル）の仕様に対応します。

#### **画面概要**

* **画面名:** マイプロフィール  
* **目的:** プロフィールを閲覧し、本人であれば編集・パスワード変更を行います。  
* **レイアウト:** max-w-3xl 中央寄せ 1。

#### **データ取得**

* GET /api/profile/{userId} を実行します。  
* 失敗時: 「プロファイルが見つかりません。」を表示 1。  
* 会話量は formatNumber ユーティリティで K/M 省略表示します 1。

#### **本人判定**

* session.user.id \=== profile.id.toString() の結果を isMyProfile として保持します。  
* isMyProfile が true の場合のみ、メニュー（メール表示、パスワード変更）と「プロフィール編集」ボタンを表示します 1。

#### **UI構成**

* **ヘッダー:** 戻る（→ /MyPage）、タイトル、**MoreVertical**（isMyProfile=true のみ）1。  
* **メニュー（本人のみ）:**  
  * メールアドレス表示（Mail アイコン）  
  * 「パスワード変更」ボタン（KeyRound アイコン）1。  
* **プロフィールヘッダー:** アバター（80x80 丸、プレースホルダー /default-avatar.png）、ニックネーム、フォロワー／フォロー数 1。  
* **自己紹介:** bio（未設定時は「自己紹介がありません。」）1。  
* **プロフィール編集ボタン:**（isMyProfile=true のみ）フル幅ボタン → /profile-edit へ遷移 1。  
* **キャラクターグリッド:** 2カラム。ヘッダーに「会話量順」ラベル（*分析: ソートは表示ラベルのみで未実装*）1。

#### **モーダル仕様 (パスワード変更)**

* 「パスワード変更」ボタン押下で起動 1。  
* **入力:** 「現在のパスワード」「新しいパスワード」「パスワード確認」の3フィールド。  
* **バリデーション:** 新しいパスワードが一致しない場合は、送信前に alert("新しいパスワードが一致しません。") を表示 1。  
* **API実行:** PUT /api/users/change-password (Body: { currentPassword, newPassword }) 1。  
* **結果:** 成功/失敗を alert で通知 1。

### **第34章: プロフィール編集**

本章は、/profile-edit 1 の実装仕様を定義します。第1章 1 および第33章 1 のプロフィール編集機能に対応します。

#### **画面概要**

* **画面名:** プロフィール編集  
* **目的:** 自分のプロフィール（ニックネーム／自己紹介／アイコン画像）を編集・保存します。

#### **データ取得**

* マウント時に GET /api/users/profile を実行し、nickname, bio, image\_url を取得してフォームの初期値に設定します 1。  
* 取得失敗時は console.error のみで、空のフォームとして編集可能です 1。

#### **UI構成**

* **ヘッダー:** 戻るボタン（router.back()）、中央タイトル「プロフィール編集」1。  
* **アバター:**  
  * 円形 96x96。next/image でプレビュー（imagePreview）または初期値（image\_url）を表示 1。  
  * 右下にカメラアイコン（Camera）を配置。  
  * **画像選択:** カメラアイコンクリックで、隠された \<input type="file" accept="image/\*"\> を起動します 1。  
  * **プレビュー:** ファイル選択後、URL.createObjectURL(file) で imagePreview 状態を更新し、即時プレビューします 1。  
* **フォーム:**  
  * ニックネーム: \<input\>  
  * 自己紹介: \<textarea rows=4\>  
* **保存ボタン:** フル幅・ピンク 1。

#### **API実行**

* **更新:** FormData を使用し、PUT /api/users/profile を実行（nickname, bio, image?）1。  
* **セッション更新:** 保存成功時、next-auth の update({ name:nickname, image:imagePreview? }) 関数を呼び出し、クライアントのセッション情報を即時更新します 1。  
* **遷移:** セッション更新後、alert('プロフィールを更新しました！') を表示し、/profile/{session.user.id}（マイプロフィール画面）へ router.push します 1。

### **第35章: 会員登録**

本章は、/sign-up（または /register）1 の実装仕様を定義します。第1章 1 の会員登録機能に対応します。

#### **画面概要**

* **画面名:** 会員登録  
* **目的:** ユーザーが新規登録を完了します。  
* **レイアウト:** 中央カード型フォーム、左上に「ログイン画面へ戻る」ボタン 1。

#### **UI構成**

* **ヘッダー（左上）:** 「ログイン画面へ戻る」ボタン → /login へ遷移 1。  
* **タイトル:** 「会員登録」  
* **フォーム:**  
  * メール（Mail アイコン）  
  * パスワード（Lock アイコン, type="password"）  
  * 氏名（User アイコン）  
  * 電話（Phone アイコン, placeholder="070-1234-5678"）  
  * ニックネーム（Smile アイコン）1  
* **規約同意:**  
  * チェックボックス（agreed）＋「利用規約」リンク 1。  
  * リンククリックで「規約モーダル」を表示 1。  
* **送信ボタン:** 「会員登録」（agreed が true の場合のみ有効化）1。

#### **モーダル仕様 (利用規約)**

* 「利用規約」リンクで開きます（showTerms 状態）1。  
* 白地カードに本文をスクロール表示。  
* 「同意します」ボタン押下で agreed \= true に設定し、モーダルを閉じます 1。

#### **バリデーション (フロント)**

*送信前に厳格なクライアントサイドバリデーションを実行し、失敗時は alert を表示します。*

* **メール:** /^\[^\\s@\]+@\[^\\s@\]+\\.\[^\\s@\]+$/ 1  
* **パスワード:** /^.{8,16}$/ (8〜16文字) 1  
* **氏名:** /^+$/u (ひらがな、カタカナ、漢字、長音記号、空白のみ) 1  
* **電話:** /^070-\\d{4}-\\d{4}$/ (070-1234-5678 形式のみ) 1  
* **ニックネーム:** /^.{2,12}$/ (2〜12文字) 1  
* **規約:** agreed \=== true 1

#### **API実行**

* **登録:** POST /api/register (Body: { email, password, name, phone, nickname } をJSONで送信) 1。  
* **レスポンス処理:**  
  * content-type が JSON でない場合: alert("サーバーから不明な応答が返されました。") 1。  
  * response.ok \=== true: alert('登録成功！ログイン画面へ移動します。') → /login へ router.push 1。  
  * response.ok \=== false: レスポンスJSONの error 文言を alert で表示 1。

#### **引用文献**

1. 01\_認証及びユーザー管理\_詳細.csv
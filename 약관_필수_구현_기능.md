# 약관 기반 필수 구현 기능

> **작성일**: 2025-01-27  
> **목적**: 약관 및 개인정보처리방침에 따라 **정말 필수로 구현해야 할 기능**만 정리  
> **참고**: 이미 구현된 기능은 ✅로 표시, 미구현은 ❌로 표시

## ⚠️ 중요 참고사항

### AI 학습 옵트아웃에 대해
- **현재 시스템**: Gemini API (Vertex AI)만 사용
- **현재 구조**: 사용자 채팅 로그를 직접 Google 학습 데이터로 보내지 않음
- **약관 명시**: 개인정보처리방침에 "AI 학습 이용" 조항이 있지만, 이는 **자체 모델을 학습시킬 계획**이 있을 때를 위한 조항으로 보임
- **결론**: **현재는 구현 불필요**. 자체 모델 학습 계획이 있을 때만 구현하면 됨
- **권장**: 약관 수정 시 "자체 모델 학습 시" 또는 "향후 계획"으로 명시하는 것이 좋음

---

## 📋 현재 구현 상태 요약

### ✅ 이미 구현된 기능
- 연령 확인 체크박스 (13세 이상) - `complete-profile` 페이지
- 약관 동의 체크박스 - `complete-profile` 페이지
- 계정 삭제 기능 - `/api/users/account` DELETE
- 계정 정지 기능 - `suspendedUntil`, `suspensionReason` 필드
- 세이프티 필터 - `safetyFilter` 필드, Vertex AI HarmCategory 설정
- 포인트 시스템 기본 - `free_points`, `paid_points`, 무상 포인트 우선 소비
- 신고 기능 - `reports` 테이블
- 공지사항 시스템 - `notices` 테이블
- 알림 시스템 - `notifications` 테이블

### ❌ 미구현 필수 기능
- 약관 페이지 (이용약관, 개인정보처리방침, 특정상거래법)
- Cookie 동의 배너
- 채팅 로그 자동 삭제 설정
- 포인트 유효기간 관리 (무상 포인트 1년)
- 개인정보 열람/수정/삭제 요청
- 약관 변경 통지 시스템

### ⚠️ 선택사항 (약관에 명시되어 있지만 현재는 불필요)
- AI 학습 옵트아웃 (Gemini API만 사용하므로 현재는 불필요)

---

## 🚨 최우선 필수 구현 (법적 필수)

> **참고**: 이 섹션에는 정말 필수로 구현해야 할 기능만 포함됩니다. 선택사항은 하단 "선택사항" 섹션을 참고하세요.

### 1. 약관 페이지 (⭐⭐⭐⭐⭐)

#### 1.1 이용약관 페이지 (`/terms`)
- **약관 요구사항**: 제5조 (약관 변경 통지), 제44조 (통지 방법)
- **현재 상태**: ❌ 미구현
- **필수 내용**:
  - 약관 전체 내용 표시
  - 버전 관리 (최종 수정일)
  - 약관 동의 이력 기록 (회원가입 시)
- **구현 파일**:
  - `src/app/terms/page.tsx` (신규 생성)
  - `src/app/api/terms/agree/route.ts` (약관 동의 API)
  - `terms_agreements` 테이블 (약관 동의 이력)

#### 1.2 개인정보처리방침 페이지 (`/privacy`)
- **약관 요구사항**: 제39조 (개인정보 취급)
- **현재 상태**: ❌ 미구현
- **필수 내용**:
  - 개인정보처리방침 전체 내용 표시
  - 버전 관리 (최종 수정일)
  - 약관 동의 이력 기록 (회원가입 시)
- **구현 파일**:
  - `src/app/privacy/page.tsx` (신규 생성)
  - 기존 `ナモアイ_プライバシーポリシー.md` 내용 활용

#### 1.3 특정상거래법 페이지 (`/tokushoho`)
- **약관 요구사항**: 특정상거래법 고지 의무
- **현재 상태**: ❌ 미구현
- **필수 내용**:
  - 사업자 정보 (회사명, 대표자, 주소, 전화번호, 이메일)
  - 판매 가격
  - 결제 방법
  - 상품 인도 시기
  - 반품/교환 정책
- **구현 파일**:
  - `src/app/tokushoho/page.tsx` (신규 생성)

---

### 2. Cookie 동의 배너 (⭐⭐⭐⭐⭐)

#### 2.1 Cookie 동의 배너 컴포넌트
- **약관 요구사항**: 개인정보처리방침 제6조 (외부 송신/정보 수집 모듈)
- **현재 상태**: ❌ 미구현
- **필수 기능**:
  - 필수 Cookie / 선택 Cookie 구분
  - 동의/거부 선택
  - LocalStorage에 동의 상태 저장
  - Google Analytics 조건부 로드 (동의 시에만)
- **구현 파일**:
  - `src/components/CookieConsent.tsx` (신규 생성)
  - `src/app/layout.tsx`에 배너 추가
  - `users.cookieConsent` 필드 추가 (DB)

---

### 3. 채팅 로그 자동 삭제 설정 (⭐⭐⭐⭐⭐)

#### 3.1 채팅 로그 자동 삭제 설정
- **약관 요구사항**: 개인정보처리방침 제2조의2 제1항 (채팅 로그 취급)
- **현재 상태**: ❌ 미구현
- **필수 기능**:
  - 사용자 설정에서 "자동 삭제 활성화" 옵션
  - 최종 이용일로부터 90일 후 자동 삭제
  - 사용자 삭제 기능 (전체/일부 삭제)
  - 1년 미접속 시 삭제 (자동 삭제 설정 시)
- **구현 파일**:
  - `src/app/settings/privacy/page.tsx`에 설정 추가
  - `src/app/api/users/settings/auto-delete/route.ts` (신규 생성)
  - `src/app/api/users/chat-logs/delete/route.ts` (신규 생성)
  - `users.autoDeleteChatLogs` 필드 추가 (DB)
  - 배치 작업: 매일 실행하여 만료된 채팅 로그 삭제

---

### 4. 포인트 유효기간 관리 (⭐⭐⭐⭐⭐)

#### 4.1 무상 포인트 유효기간 관리
- **약관 요구사항**: 제14조 (무상 포인트 1년 유효기간)
- **현재 상태**: ❌ 미구현
- **필수 기능**:
  - 무상 포인트 지급 시 1년 후 만료일 설정
  - 만료된 무상 포인트 자동 삭제
  - 만료 7일 전 알림 발송
- **구현 파일**:
  - `points.freePointsExpiresAt` 필드 추가 (DB)
  - `src/app/api/points/expire/route.ts` (신규 생성)
  - 배치 작업: 매일 실행하여 만료된 포인트 삭제 및 알림 발송

---

### 5. 개인정보 열람/수정/삭제 요청 (⭐⭐⭐⭐⭐)

#### 5.1 개인정보 요청 시스템
- **약관 요구사항**: 개인정보처리방침 제8조 (개인정보 열람/수정/이용정지 등)
- **현재 상태**: ❌ 미구현
- **필수 기능**:
  - 개인정보 열람 요청 (PDF 다운로드)
  - 개인정보 수정 요청
  - 개인정보 삭제 요청
  - 이용 정지 요청
  - 본인 확인 절차
  - 수수료 처리 (열람 요청 시 1,000엔)
- **구현 파일**:
  - `src/app/settings/data/page.tsx` (신규 생성)
  - `src/app/api/users/privacy-request/route.ts` (신규 생성)

---

### 6. 약관 변경 통지 (⭐⭐⭐⭐)

#### 6.1 약관 변경 통지 시스템
- **약관 요구사항**: 제5조 (약관 변경 통지 - 효력 발생 10일 전)
- **현재 상태**: ❌ 미구현
- **필수 기능**:
  - 약관 변경 내용 게시
  - 효력 발생일 명시
  - 10일 전 자동 공지
  - 이메일 통지 (약관 변경 시)
  - 재동의 요청 (미동의 시 서비스 이용 제한)
- **구현 파일**:
  - `src/app/api/terms/notify-change/route.ts` (신규 생성)
  - `terms_agreements` 테이블에 버전 관리 추가

---

## 📊 우선순위별 구현 체크리스트

### Phase 1: 즉시 구현 (법적 필수)
1. [ ] **약관 페이지** (`/terms`, `/privacy`, `/tokushoho`)
2. [ ] **Cookie 동의 배너**
3. [ ] **채팅 로그 자동 삭제 설정**
4. [ ] **포인트 유효기간 관리**

### Phase 2: 1주일 내 구현
5. [ ] **개인정보 열람/수정/삭제 요청**
6. [ ] **약관 변경 통지 시스템**

---

## 📝 데이터베이스 스키마 추가

### 필수 필드 추가
```sql
-- users 테이블
ALTER TABLE users ADD COLUMN IF NOT EXISTS autoDeleteChatLogs BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS cookieConsent BOOLEAN DEFAULT FALSE;
ALTER TABLE users ADD COLUMN IF NOT EXISTS cookieConsentDate TIMESTAMP;

-- points 테이블
ALTER TABLE points ADD COLUMN IF NOT EXISTS freePointsExpiresAt TIMESTAMP;

-- terms_agreements 테이블 (신규 생성)
CREATE TABLE IF NOT EXISTS terms_agreements (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  terms_version VARCHAR(50) NOT NULL,
  privacy_version VARCHAR(50) NOT NULL,
  agreed_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(user_id, terms_version, privacy_version)
);
```

### 선택 필드 (자체 모델 학습 계획 시에만 추가)
```sql
-- users 테이블
ALTER TABLE users ADD COLUMN IF NOT EXISTS aiTrainingOptOut BOOLEAN DEFAULT FALSE;

-- chat_message 테이블
ALTER TABLE chat_message ADD COLUMN IF NOT EXISTS canUseForTraining BOOLEAN DEFAULT TRUE;
```

---

## 🔧 API 엔드포인트 추가

### 필수 API
- [ ] `GET /terms` - 이용약관 페이지
- [ ] `GET /privacy` - 개인정보처리방침 페이지
- [ ] `GET /tokushoho` - 특정상거래법 페이지
- [ ] `POST /api/terms/agree` - 약관 동의
- [ ] `PUT /api/users/settings/auto-delete` - 자동 삭제 설정
- [ ] `DELETE /api/users/chat-logs/delete` - 채팅 로그 삭제
- [ ] `POST /api/users/privacy-request` - 개인정보 요청
- [ ] `POST /api/points/expire` - 포인트 만료 처리
- [ ] `POST /api/terms/notify-change` - 약관 변경 통지

### 선택 API (자체 모델 학습 계획 시에만 필요)
- [ ] `PUT /api/users/settings/ai-training` - AI 학습 옵트아웃 설정

---

## 📄 프론트엔드 페이지 추가

### 필수 페이지
- [ ] `src/app/terms/page.tsx` - 이용약관 페이지
- [ ] `src/app/privacy/page.tsx` - 개인정보처리방침 페이지
- [ ] `src/app/tokushoho/page.tsx` - 특정상거래법 페이지
- [ ] `src/app/settings/privacy/page.tsx` - 개인정보 설정 페이지
- [ ] `src/app/settings/data/page.tsx` - 데이터 관리 페이지
- [ ] `src/components/CookieConsent.tsx` - Cookie 동의 배너

---

## ⚙️ 배치 작업 추가

### 필수 배치 작업
- [ ] **포인트 만료 처리** (매일 실행)
  - 만료된 무상 포인트 삭제
  - 만료 7일 전 알림 발송
- [ ] **채팅 로그 자동 삭제** (매일 실행)
  - 자동 삭제 설정 사용자의 90일 경과 채팅 로그 삭제
  - 1년 미접속 사용자 채팅 로그 삭제 (자동 삭제 설정 시)

---

## 📌 선택사항 (약관에 명시되어 있지만 현재는 불필요)

### AI 학습 옵트아웃 (⚠️ 현재는 불필요)
- **약관 요구사항**: 개인정보처리방침 제2조의2 제3항 (AI 학습 이용)
- **현재 시스템 구조**:
  - ✅ Gemini API (Vertex AI)만 사용
  - ✅ 사용자 채팅 로그를 직접 Google 학습 데이터로 보내지 않음
  - ✅ Google이 자체적으로 수집하는 데이터는 Google 정책에 따름
- **결론**:
  - ⚠️ **현재는 필수 구현 아님** (Gemini API만 사용하므로)
  - ⚠️ **약관에 명시되어 있지만, 실제로는 자체 모델 학습 계획이 있을 때만 필요**
  - ⚠️ **약관 수정 고려**: "자체 모델 학습 시" 또는 "향후 계획"으로 명시하는 것이 좋음
- **구현 시 필요한 파일** (현재는 구현 불필요):
  - `src/app/settings/privacy/page.tsx`에 설정 추가
  - `src/app/api/users/settings/ai-training/route.ts` (신규 생성)
  - `users.aiTrainingOptOut` 필드 추가 (DB)
  - `chat_message.canUseForTraining` 필드 추가 (DB)

### 기타 선택사항 (약관에 명시되어 있지만 실제로는 거의 구현 안 함)
- 보호자 동의 절차 (13-18세)
- 필터 우회 감지 시스템
- 이메일/전화번호 변경 기능

---

## 📌 참고사항

### 이미 구현된 기능 (재확인 불필요)
- ✅ 연령 확인 체크박스 (13세 이상)
- ✅ 약관 동의 체크박스 (회원가입 시)
- ✅ 계정 삭제 기능
- ✅ 계정 정지 기능
- ✅ 세이프티 필터
- ✅ 포인트 시스템 기본
- ✅ 신고 기능

---

## 🔗 관련 문서
- `약관_필수_기능_정리.md` - 전체 기능 정리 (참고용)
- `ナモアイ利用規約.md` - 이용약관 원문
- `ナモアイ_プライバシーポリシー.md` - 개인정보처리방침 원문











